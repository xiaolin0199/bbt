var bbt={title:"噢易班班通管理分析系统",importTeacherUrl:"/install/teacher/import/",importLessonUrl:"/install/lesson_name/import/",importTermUrl:"/install/term/import/",importWorktimeUrl:"/install/lesson_period/import/",importGradeClassUrl:"/install/grade_class/import/",importLessonScheduleUrl:"/install/lesson_schedule/import/",importTeachInfoUrl:"/install/lesson_teacher/import/",listGradeClassUrl:"/install/grade_class/",promptWidth:240,errorFn:function(c,b){var d=bbt.utils.getErrorMsg(b.result);Ext.Msg.alert("提示",d)},installer:{init:function(){var a=this.config();Ext.each(["province","city","country","town"],function(b){Ext.create("Ext.data.Store",{autoLoad:false,storeId:b+"Store",proxy:{type:"ajax",url:"/group_get_children/",reader:{type:"json",root:"data.children"},startParam:undefined,pageParam:undefined},fields:["name"],pageSize:10000})});Ext.getStore("provinceStore").load();Ext.onReady(function(){var b=new Ext.window.Window(a);bbt.installer.initEvents(b);b.show()})},initEvents:function(b){var a=Ext.getCmp("serverConfig-panel");bbt.utils.on(a,{"combo[name]":{change:function(i,e){var f=i.nextArea,h,j={},g=i.up("form").getForm(),c=false,d;if(!e){return}f=g.findField(f);if(!f){return}if(f.isDisabled()){return}h=f;while(h&&!h.isDisabled()){h.setValue(undefined);h=g.findField(h.nextArea)}Ext.each(["town","country","city","province"],function(l){var k=g.findField(l);if(k.isDisabled()){return}if(i.name===l){c=!c}if(c){j[l+"_name"]=k.getValue()}});f.store.proxy.extraParams=j;f.store.load();if(!/^(北京|天津|上海|重庆)$/.test(e)&&/^(city|province)$/.test(i.name)){d=function(){f.store.count()>0&&f.store.add({name:"直属"});f.store.un("load",d)};f.store.on("load",d)}}}})},config:function(){return{xtype:"window",title:"服务器配置向导",width:596,height:400,layout:"card",border:false,closable:false,resizable:false,defaultType:"panel",items:[{xtype:"panel",bodyCls:"banner",id:"common-panel",items:[{xtype:"fieldset",style:{backgroundPosition:"110px 1px"},border:false,title:"选择服务器类型",margin:"120 20 20 20",items:[{xtype:"radiogroup",defaultType:"radio",border:false,layout:{type:"hbox",pack:"center"},defaults:{margin:"0 0 0 30"},items:[{name:"server_type",boxLabel:"省级服务器",inputValue:"province",margin:0},{name:"server_type",boxLabel:"地市州级服务器",inputValue:"city"},{name:"server_type",boxLabel:"区县市级服务器",inputValue:"country"},{name:"server_type",boxLabel:"校级服务器",inputValue:"school",checked:true}]}]}],buttons:[{text:"下一步",handler:function(){var d=this.up("panel").down("radiogroup"),b=d.getValue(),g,f,h,a=false,c,e;g=this.up("window").getLayout();g.next();f=g.getActiveItem().down("form");f.down("textfield[name=server_type]").setValue(b.server_type);h=["province","city","country","town"];Ext.each(h,function(j){var i=f.down("combo[name="+j+"]");i.setDisabled(a);i.allowBlank=a;if(j==b.server_type){a=!a;return}});schoolName=f.down("textfield[name=school_name]");if(b.server_type=="school"){f.down("combo[name=country]").allowBlank=true;f.down("combo[name=town]").allowBlank=true;schoolName.setDisabled(false)}else{schoolName.setDisabled(true);e=Ext.getCmp("server-port");Ext.each(e.query("textfield"),function(i){i.allowBlank=true});e.hide();g.getActiveItem().down("[action=next]").setText("完成").setOver=function(){Ext.Ajax.request({url:"/install/step/",params:{install_step:"-1"},success:function(){location.pathname="/"},failure:bbt.errorFn})}}Ext.each(f.query("field[disabled=true]"),function(i){i.hide()});c=d.getChecked()[0].boxLabel;Ext.each(this.up("window").query("component[sid=stype]"),function(i){i.getEl().setHTML('<span style="color: #22587a;">&gt;&gt;&nbsp;'+c+"</span>")})}}],buttonAlign:"right"},{xtype:"panel",autoScroll:true,layout:"fit",items:[{xtype:"form",bodyCls:"banner",id:"serverConfig-panel",border:false,defaultType:"fieldset",defaults:{collapsible:false,margin:10,border:false},items:[{sid:"stype",xtype:"component",border:false,margin:"85 20 20 20",},{title:"服务器归属地",style:{backgroundPosition:"105px 1px"},margin:10,defaultType:"panel",defaults:{height:22,border:false,margin:"5 0 0 0"},items:[{defaultType:"combo",defaults:{emptyText:"-- 请选择 --",allowBlank:false,labelSeparator:""},layout:"column",items:[{fieldLabel:"省",name:"province",store:"provinceStore",editable:false,queryMode:"local",displayField:"name",valueField:"name",nextArea:"city",columnWidth:0.5,margin:"0 10 0 0"},{fieldLabel:"地市州",name:"city",store:"cityStore",editable:false,queryMode:"local",displayField:"name",valueField:"name",nextArea:"country",columnWidth:0.5,margin:"0 0 0 10"}]},{defaultType:"combo",defaults:{emptyText:"-- 请选择 --",allowBlank:false,labelSeparator:""},layout:"column",items:[{fieldLabel:"区县市",name:"country",store:"countryStore",editable:false,queryMode:"local",displayField:"name",valueField:"name",nextArea:"town",columnWidth:0.5,margin:"0 10 0 0"},{fieldLabel:"乡镇街道",editable:false,name:"town",store:"townStore",queryMode:"local",displayField:"name",valueField:"name",columnWidth:0.5,margin:"0 0 0 10"}]},{defaultType:"combo",defaults:{emptyText:"-- 请选择 --",flex:1,allowBlank:false,labelSeparator:""},layout:{type:"hbox",align:"center"},items:[{xtype:"textfield",name:"school_name",fieldLabel:"学校名称",emptyText:""},{margin:"0 0 0 20",xtype:"textfield",name:"server_type",inputType:"hidden"}]}]},{xtype:"fieldset",id:"server-port",hideMode:"visibility",style:{backgroundPosition:"160px 1px"},title:"填写服务器 IP 和端口号",defaultType:"textfield",defaults:{allowBlank:false},layout:{type:"hbox",pack:"left",align:"top"},items:[{name:"host",fieldLabel:"服务器 IP",labelSeparator:"",labelWidth:60,regex:/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,regexText:"无效的 IP 地址"},{name:"port",value:"8000",labelWidth:10,labelSeparator:"",fieldLabel:"&nbsp;:&nbsp;",validator:function(a){var b="无效的端口号";if(!/^\d+$/.test(a)){return b}a=parseInt(a);if(a>=0&&a<=65536){return true}else{return b}}}]}]}],buttons:[{text:"下一步",action:"next",handler:function(){var d=this,c=Ext.getCmp("serverConfig-panel"),e,a,b=d.setOver;e=bbt.utils.checkForm(c);if(e!==true){Ext.Msg.alert("提示",e);return}c=c.getForm();a=c.findField("server_type").getValue()=="school";c.waitMsgTarget=d.up("window").getEl();c.submit({url:"/install/serverinfo/",waitMsg:"正在提交数据……",timeout:60000,params:{install_step:1},success:function(f,g){if(g.result.status=="success"){a?d.up("window").getLayout().next():(b&&b())}},failure:bbt.errorFn})}}],buttonAlign:"right"},{xtype:"panel",layout:"anchor",bodyCls:"banner",defaults:{anchor:"100%"},items:[{sid:"stype",xtype:"component",border:false,margin:"85 20 20 20"},{xtype:"fieldset",border:false,title:"服务器基础信息导入",style:{backgroundPosition:"140px 1px"},margin:20,defaults:{border:false,layout:"hbox",margin:"10 0 0 0"},defaultType:"panel",header:false,items:[{items:[{border:false,html:"教职人员基础信息",width:bbt.promptWidth},{xtype:"form",bodyCls:"no-bg",height:22,border:false,layout:"card",items:[{xtype:"fileuploadfield",name:"excel",buttonOnly:true,margin:0,padding:0,buttonConfig:{text:"导入"},listeners:{change:function(a,b){if(!/\.xlsx?$/.test(b)){return}a.up("form").submit({url:bbt.importTeacherUrl,success:function(d,c){var g=c.result;try{if(g.status=="success"){Ext.getCmp("import-2").setDisabled(false);fixStyle(Ext.getCmp("import-2"))}}catch(f){}},failure:bbt.errorFn})}}},{xtype:"component",border:false,html:'<p class="import-success">OK！</p>'}]},{flex:1,border:false}]},{items:[{border:false,html:"学校开课课程信息",width:bbt.promptWidth},{xtype:"form",id:"import-2",height:22,disabled:true,bodyCls:"no-bg",layout:"card",border:false,items:[{xtype:"fileuploadfield",name:"excel",buttonOnly:true,margin:0,padding:0,buttonConfig:{text:"导入"},listeners:{change:function(a,b){if(!/\.xlsx?$/.test(b)){return}a.up("form").submit({url:bbt.importLessonUrl,success:function(d,c){var g=c.result;try{if(g.status=="success"){Ext.getCmp("import-3").setDisabled(false);fixStyle(Ext.getCmp("import-3"))}}catch(f){}},failure:bbt.errorFn})}}},{xtype:"component",border:false,html:'<p class="import-success">OK！</p>'}]},{flex:1,border:false}]},{items:[{border:false,html:"学年学期信息",width:bbt.promptWidth},{xtype:"form",bodyCls:"no-bg",height:22,id:"import-3",disabled:true,border:false,layout:"card",items:[{xtype:"fileuploadfield",name:"excel",buttonOnly:true,margin:0,padding:0,buttonConfig:{text:"导入"},listeners:{change:function(a,b){if(!/\.xlsx?$/.test(b)){return}a.up("form").submit({url:bbt.importTermUrl,success:function(d,c){var g=c.result;try{if(g.status=="success"){Ext.getCmp("next-step-1").setDisabled(false)}}catch(f){}},failure:bbt.errorFn})}}},{xtype:"component",border:false,html:'<p class="import-success">OK！</p>'}]},{flex:1,border:false}]}]}],buttons:[{text:"下一步",id:"next-step-1",disabled:true,handler:function(){this.up("window").getLayout().next()}}],buttonAlign:"right"},{xtype:"panel",bodyCls:"banner",layout:"anchor",items:[{sid:"stype",xtype:"component",border:false,margin:"85 20 20 20"},{xtype:"fieldset",title:"当前学期基础信息导入（可跳过）",border:false,style:{backgroundPosition:"220px 1px"},defaults:{border:false,layout:"hbox",margin:"10 0 0 0"},defaultType:"panel",layout:"vbox",margin:20,anchor:"100%",items:[{items:[{border:false,html:"学期作息时间",width:bbt.promptWidth},{xtype:"form",bodyCls:"no-bg",height:22,border:false,layout:"card",items:[{xtype:"fileuploadfield",name:"excel",buttonOnly:true,margin:0,padding:0,buttonConfig:{text:"导入"},listeners:{change:function(a,b){if(!/\.xlsx?$/.test(b)){return}a.up("form").submit({url:bbt.importWorktimeUrl,success:function(d,c){var g=c.result;try{if(g.status=="success"){a.up("form").getLayout().next();Ext.getCmp("import-4").setDisabled(false);fixStyle(Ext.getCmp("import-4"))}}catch(f){}},failure:bbt.errorFn})}}},{xtype:"component",border:false,html:'<p class="import-success">OK！</p>'}]},{flex:1,border:false}]},{items:[{border:false,html:"学期年级班级信息",width:bbt.promptWidth},{xtype:"form",bodyCls:"no-bg",height:22,id:"import-4",disabled:true,border:false,layout:"card",items:[{xtype:"fileuploadfield",name:"excel",buttonOnly:true,margin:0,padding:0,buttonConfig:{text:"导入"},listeners:{change:function(a,b){if(!/\.xlsx?$/.test(b)){return}a.up("form").submit({url:bbt.importGradeClassUrl,success:function(d,c){var g=c.result;try{if(g.status=="success"){a.up("form").getLayout().next();Ext.getCmp("import-5").setDisabled(false);fixStyle(Ext.getCmp("import-5"))}}catch(f){}},failure:bbt.errorFn})}}},{xtype:"component",border:false,html:'<p class="import-success">OK！</p>'}]},{flex:1,border:false}]},{items:[{border:false,html:"学期班级课程表",width:bbt.promptWidth},{xtype:"button",text:"查看",id:"import-5",disabled:true,handler:function(){var a={modal:true,width:330,height:360,title:"导入课程表",layout:"fit",resizable:false,items:[{xtype:"coursetable",border:false}]};new Ext.window.Window(a).show()}},{flex:1,border:false}]},{items:[{border:false,html:"学期班级课程授课老师信息",width:bbt.promptWidth},{xtype:"form",bodyCls:"no-bg",height:22,id:"import-6",disabled:true,layout:"card",border:false,items:[{xtype:"fileuploadfield",name:"excel",buttonOnly:true,margin:0,padding:0,buttonConfig:{text:"导入"},listeners:{change:function(a,b){if(!/\.xlsx?$/.test(b)){return}a.up("form").submit({url:bbt.importTeachInfoUrl,params:{install_step:"-1"},success:function(d,c){var g=c.result;try{if(g.status=="success"){a.up("form").getLayout().next();a.up("panel").down("button[action=next]").setEnabled(true)}}catch(f){}},failure:bbt.errorFn})}}},{xtype:"component",border:false,html:'<p class="import-success">OK！</p>'}]},{flex:1,border:false}]}]}],buttons:[{text:"完成",action:"next",handler:function(){bbt.request({url:"/install/step/",params:{install_step:"-1"},callback:function(b,a,f){var c;try{c=Ext.decode(f.responseText);if(c.status=="success"){location.pathname="/"}}catch(d){}}})}}],buttonAlign:"right"}]}}},boot:function(){this.installer.init();bbt.utils.setLoadMask()},utils:{on:function(b,c){var a,d;for(a in c){d=c[a];Ext.each(b.query(a),function(e){e.on(d)})}},checkForm:function(b){var a=b.getForm(),c=true,d;a.getFields().each(function(e){if(!e.isValid()){d=e.getFieldLabel()+"："+e.getActiveError();c=false;return false}});return d||c},getErrorMsg:function(b){var a,c="";for(a in b){break}if(!a){return"服务器错误！"}if(Ext.isArray(b.errors)){b.errors=b.errors[0]}if(typeof b.errors=="object"){Ext.Object.each(b.errors,function(d,e){if(typeof e=="string"){c+=e}else{if(Ext.isArray(e)){c+=e.join("<br/>")}}})}return c||b.msg},getIcon:function(a,c){try{var b=bbt.icons[a][c];if(b.charAt(0)!="/"){b="/public/images/"+b}return b}catch(d){}return bbt.icons.defaultIcon},setLoadMask:function(){Ext.Ajax.on("requestcomplete",function(c,b){try{if(b.request.options.loadMaskId){var a=bbt._loadmask[b.request.options.loadMaskId];delete b.loadMaskId;bbt.utils.destroyMask(a)}}catch(d){}})},createMask:function(c,d){var b=new Ext.LoadMask(c,{msg:d}),a=new Date().getTime()+""+Math.random();bbt._loadmask[a]=b;b.show();return a},destroyMask:function(a){if(typeof a=="string"){a=bbt._loadmask[a]}a&&a.hide();a=null},serializeStore:function(j,h){var a,d=0,g=j.count(),f,b,c={},e;f=j.model.getFields();h=h||{};for(;d<g;d++){a=j.getAt(d);if(typeof b=="string"){return b}e="form-"+d+"-";Ext.each(f,function(l){var k=l.name,i=a.get(k);if(k in h){i=h[k](i)}c[e+k]=i})}c["form-TOTAL_FORMS"]=d;c["form-INITIAL_FORMS"]=0;c["form-MAX_NUM_FORMS"]="";return c}},request:function(a){a=a||{};if(!a.url){return}Ext.Ajax.request(a)},_loadmask:{}};Ext.define("bbt.CourseTable",{extend:"Ext.grid.Panel",alias:"widget.coursetable",store:new Ext.data.Store({fields:["grade__name","name"]}),bodyCls:"import-schedule-grid",columns:{defaults:{sortable:false,menuDisabled:true,draggable:true},items:[{text:"年级",dataIndex:"grade__name",renderer:function(a){return a?a+"年级":""}},{text:"班级",dataIndex:"name",renderer:function(a){return a?a+"班":""}},{text:"操作",dataIndex:"_",renderer:function(a){if(a){return a}return'<form style="margin:0;padding:0;margin-top:1px;" method="POST"><div class="x-panel x-panel-default" style="margin: 0px; width: 38px; height: 22px; "><div class="x-panel-body no-bg x-panel-body-default x-panel-body-default x-docked-noborder-top x-docked-noborder-right x-docked-noborder-bottom x-docked-noborder-left" style="width: 38px; height: 22px; "><table class="x-field x-form-item x-field-default x-anchor-form-item x-form-readonly" style="padding: 0px; margin: 0px; border-width: 0px; table-layout: auto;" cellpadding="0"><tbody><tr><td style="display:none;" valign="top" halign="left" width="105" class="x-field-label-cell"><label for="filefield-1036-inputEl" class="x-form-item-label x-form-item-label-left" style="width:100px;margin-right:5px;"></label></td><td class="x-form-item-body x-form-file-wrap" colspan="3" role="presentation"><table class="x-form-trigger-wrap" cellpadding="0" cellspacing="0" style="table-layout: auto;"><tbody><tr><td class="x-form-trigger-input-cell" style="display: none;"><input type="text" name="" readonly="readonly" style="" class="x-form-field x-form-text  " autocomplete="off" aria-invalid="false" data-errorqtip=""></td><td style="width: 38px;"><div class="x-btn x-form-file-btn x-btn-default-small x-noicon x-btn-noicon x-btn-default-small-noicon" style="border-width:1px 1px 1px 1px;"><em><button type="button" class="x-btn-center" hidefocus="true" role="button" autocomplete="off"><span class="x-btn-inner" style="">导入</span><span class="x-btn-icon "></span></button></em><input class="x-form-file-input" type="file" size="1" name="excel"></div></td></tr></tbody></table></td></tr></tbody></table><div style="font-size: 1px; width: 1px; height: 1px; display: none;"></div></div></div></form>'}}]},tbar:["->",{text:"完成",disabled:true,id:"next-step-2",handler:function(){Ext.getCmp("import-5").setDisabled(true);this.up("window").destroy()}}],listeners:{viewready:function(){var a=this;bbt.request({url:"/install/grade_class/",success:function(c){var b=Ext.decode(c.responseText);a.store.loadData(b.data)},failure:bbt.errorFn});setTimeout(function(){Ext.each(a.getEl().query('input[type="file"]'),function(c){var b=Ext.get(c);b.on("change",function(){var e=b.up("form"),d=e.up(".x-grid-row");d=a.getView().getRecord(d);Ext.Ajax.upload(e,bbt.importLessonScheduleUrl,"grade_name="+d.get("grade__name")+"&class_name="+d.get("name"),{success:function(f,h){Ext.getCmp("import-6").setDisabled(false);fixStyle(Ext.getCmp("import-6"));Ext.getCmp("next-step-2").setDisabled(false);b.up(".x-btn").addCls(["x-disabled","x-btn-disabled","x-btn-default-small-disabled"]);b.clearListeners();try{var g=a.getView().getRecord(b.up(".x-grid-row"));g&&g.set("_",'<img src="/public/images/install/import_ok.png"/>');g.commit()}catch(i){}},failure:bbt.errorFn})})})},100)}},});function fixStyle(b){var a=b.getEl().down(".x-btn");try{a.removeCls(["x-disabled","x-btn-disabled","x-btn-default-small-disabled"])}catch(c){}}bbt.boot();function test(){var b={modal:true,width:350,height:400,title:"导入课程表",layout:"fit",items:[{xtype:"coursetable",border:false}]};var a=new Ext.window.Window(b).show();a.down("grid").store.loadData([{grade__name:"一",name:"1"},{grade__name:"一",name:"2"}])};