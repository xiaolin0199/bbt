var bbt={version:"20140704",loadScript:function(){var b=["/public/js/app2.js","/public/js/"+bbt.UserInfo.level+"Config.js"],c,a,d,f=location.search,h,g={},e=/^true|1|yes$/;if(f.length){f=f.substring(1);h=f.split("&");Ext.each(h,function(i){var j=i.split("=");g[j[0]]=j[1]})}if(e.test(g.tester)){b.push("/public/js/performenceTest.js")}if(e.test(g.importTest)){b.push("/public/js/importTest.js")}for(c=0,a=b.length;c<a;c++){d=document.createElement("script");d.type="text/javascript";d.src=b[c];document.body.appendChild(d)}},loadGroup:function(a){Ext.Ajax.request({url:"/group/",success:function(h){var i,l,d={},b,j,f,c;try{i=Ext.decode(h.responseText)}catch(k){i={}}if(i.status=="success"){i=i.data;Ext.each(i.group,function(e){d[e.uuid]=e;if(!e.parent__uuid){l=e}});for(b in d){j=d[b];if(j===l){continue}f=d[j.parent__uuid];if(!f.children){f.children=[]}f.children.push(j)}c=l;while(c.group_type!=bbt.UserInfo.level){Ext.getStore(c.group_type+"Store").add(c);c=c.children;if(Ext.isArray(c)&&c.length!==0){c=c[0]}else{break}}Ext.getStore(c.group_type+"Store").add(c)}}})},loadClasses:function(a){if(typeof a!=="function"){a([]);return}Ext.Ajax.request({url:"/classes/",callback:function(b,m,d){var f=Ext.decode(d.responseText),n={},l=[],e,h,k,c,j;if(f.status!=="success"){a([]);return}for(h=0,k=f.data.length;h<k;h++){e=f.data[h];if(!(e.grade__name in n)){n[e.grade__name]=[]}n[e.grade__name].push({text:e.name,value:e.name})}for(j in n){l.push({text:j,value:j,sub:n[j]})}a(l)}})},loadCurrentSchoolYear:function(a){Ext.Ajax.request({url:"/system/term/current/",callback:a})},loadTermCompareData:function(b,d,a){var c=b.indexOf("total-time")===-1?"lesson_count":"total_time";d=d||{};Ext.Ajax.request({url:b,method:"GET",params:d,callback:function(s,r,j){var l,f,o,p,g,q,m,k,h;try{l=Ext.decode(j.responseText);if(l.status=="success"){l=l.data}}catch(n){}if(!l){return}f={};h=Math.max(l.term?l.term.length:0,l.term_previous?l.term_previous.length:0,l.term_lastyear?l.term_lastyear.length:0,20);if(l.term){m=0;Ext.each(l.term,function(i){var e=i.week+"",t=i[c];if(c=="total_time"){t=Math.floor(t/60)}if(!(e in f)){f[e]=[]}f[e][0]=t;m+=t;f[e][3]=m})}if(l.term_previous){m=0;Ext.each(l.term_previous,function(i){var e=i.week+"",t=i[c];if(c=="total_time"){t=Math.floor(t/60)}if(!(e in f)){f[e]=[]}f[e][1]=t;m+=t;f[e][4]=m})}if(l.term_lastyear){m=0;Ext.each(l.term_lastyear,function(i){var e=i.week+"",t=i[c];if(c=="total_time"){t=Math.floor(t/60)}if(!(e in f)){f[e]=[]}f[e][2]=t;m+=t;f[e][5]=m})}o=[];p=[];for(g=1;g<=h;g++){q=f[g+""];if(q){o.push({data1:typeof q[0]=="number"?q[0]:"",data2:typeof q[1]=="number"?q[1]:"",data3:typeof q[2]=="number"?q[2]:"",name:g});p.push({data1:typeof q[3]=="number"?q[3]:"",data2:typeof q[4]=="number"?q[4]:"",data3:typeof q[5]=="number"?q[5]:"",name:g})}else{o.push({name:g});p.push({name:g})}}a&&a(o,p)}})},loadSchoolCascadeData:function(b){var a=["grade_name","lesson_period","lesson_name"];Ext.each(a,function(c){var d=b.down("[name="+c+"]");d&&d.store.load()})},beforeCascadeLoad:function(){var f=this.proxy.extraParams,d=this.owner.ownerCt.ownerCt,a,b;a=d.down("[name=start_date]");if(a){a=a.getValue();a=Ext.isDate(a)?Ext.Date.format(a,"Y-m-d"):"";f.start_date=a}a=d.down("[name=end_date]");if(a){a=a.getValue();a=Ext.isDate(a)?Ext.Date.format(a,"Y-m-d"):"";f.end_date=a}a=d.down("[name=school_year]");if(a){f.school_year=a.getValue()}a=d.down("[name=term_type]");if(a){f.term_type=a.getValue()}a={};a[this.owner.displayField]="所有";this.loadData([a]);this.owner.setValue("");if(!bbt.UserInfo.isSchool()){b=true;try{a=d.down("[name=school_name]");a=a.findRecordByValue(a.getValue());a=a.raw.uuid;f.uuid=a}catch(c){b=false}if(!b||!f.uuid){return false}}},autoArea:function(a){if(!bbt.UserInfo.isSchool()){a.on("afterrender",function(){var e=["province","city","country","town","school"],c,d,b;c=Ext.Array.indexOf(e,bbt.UserInfo.level);d=Ext.getStore(e[c++]+"Store").getAt(0).get("children");b=Ext.getStore(e[c]+"Store");b.add(d);b.fireEvent("load",b)});a.on("beforedestroy",function(){var e=["province","city","country","town","school"],d,b,c;d=Ext.Array.indexOf(e,bbt.UserInfo.level);for(d=d+1,b=e.length;d<b;d++){c=Ext.getStore(e[d]+"Store");c.removeAll()}})}},autoFill2:function(a){var b,d,c=[];if(a.is("panel")){b="afterlayout"}else{if(a.is("grid")){b="viewready"}else{return}}d=a.query("toolbar[dock=top]");Ext.each(d,function(e){var f=e.query("combo");if(f&&f.length){c=c.concat(f)}});a.on(b,function(){Ext.each(c,function(g){var e=function(){g.setValue("");g.store.un("load",e)};if(g.store.isLoading()){g.store.on("load",e)}else{!g.getValue()&&g.setValue("")}})})},autoFill:function(a){return;Ext.each(a.is("grid")?[a]:a.query("grid"),function(b){b.on("viewready",function(){var d=[],c=this.query("toolbar[dock=top]");Ext.each(c,function(e){var f=e.query("combo");if(f&&f.length){d=d.concat(f)}});Ext.each(d,function(g){var e;if(g.skipAutoValue){g.store.load()}e=function(){!g.getValue()&&g.setValue("");g.store.un("load",e)};if(g.store.isLoading()&&!g.getValue()){g.store.on("load",e)}else{!g.getValue()&&g.setValue("")}})})})},getUPYunImageUrl:function(a,c){var b;if(c){c=Ext.Object.toQueryString(c);if(c){c="?"+c}else{c=""}}else{c=""}return"http://oe-test1.b0.upaiyun.com"+a+c},fullgrade:function(a){if("一二三四五六".indexOf(a)!=-1){return a+"年级（小学）"}else{if("七八九".indexOf(a)!=-1){return a+"年级（初中）"}else{if("十一十二".indexOf(a)!=-1){return a+"年级（高中）"}}}},createOverlay:function(c){var b=document.createElement("div"),a=document.createElement("a");c||(c=10);b.style.cssText="position:absolute;top:0;left:0;bottom:0;right:0;background-color: #000;opacity: 0.5;filter:alpha(opacity=50);z-index:"+c;a.className="close-trigger";a.style.cssText="z-index:10000;";a.href="javascript:void(0);";a.setAttribute("data-role","overlay");document.body.appendChild(b);document.body.appendChild(a);a.$closeTarget=b;Ext.get(a).on("click",function(g,d){var f=d.$closeTarget;f.onBeforeDestroy&&f.onBeforeDestroy(f);Ext.removeNode(f);Ext.removeNode(d)});return b},destroyWindow:function(b){var a=b.getBox();b.animate({duration:200,to:{width:"100px",height:"100px",x:a.x+(a.width-100)/2,y:a.y+(a.height-100)/2},callback:function(){b.destroy();b=null}})},getLevelTools:function(c){var a=["province","city","country","town","school"],b;if(!c){c=bbt.UserInfo.level}b=Ext.Array.indexOf(a,c);if(b!=-1){return Ext.Array.slice(a,b+1)}return[]},simulateClick:function(b){var a;if(Ext.isIE&&Ext.ieVersion<9){a=document.createEventObject();a.button=0;a.ctrlKey=false;a.altKey=false,a.shiftKey=false;b.fireEvent("onclick",a)}else{a=document.createEvent("MouseEvents");a.initMouseEvent("click",true,true);b.dispatchEvent(a)}},utils:{strftime:function(a){if(typeof a=="string"){return a}else{if(Ext.isDate(a)){return a.getFullYear()+"-"+(a.getMonth()+1)+"-"+a.getDate()}}},toDate:function(a){var c,f,b,e;if(a.indexOf(" ")!==-1){b=a.split(" ");c=b[0].split("-");f=b[1].split(":")}else{c=a.split("-")}e=new Date();if(c.length===3){e.setFullYear(parseInt(c[0]));e.setMonth(parseInt(c[1])-1);e.setDate(parseInt(c[2]))}if(f&&f.length>1){e.setHours(parseInt(f[0]));e.setMinutes(parseInt(f[1]));e.setSeconds(parseInt(f[2])||0)}return e},makeTipFor:function(a,b){Ext.create("Ext.tip.ToolTip",{target:b,html:a})},parseGroupData:function(h){var b,a={},e,f,d,c;Ext.each(h.group,function(g){a[g.uuid]=g;g.children=[]});Ext.each(h.grade,function(i){var g=a[i.term__school__uuid];if(!g.children){g.children=[]}i.leaf=true;i.text=i.name+"年级";i.group_type="grade";g.children.push(i)});for(e in a){f=a[e];f.leaf=false;f.expanded=true;f.text=f.name;if(!f.parent__uuid){b=f;continue}d=a[f.parent__uuid];d.children.push(f)}return b},on:function(b,c){var a,d;for(a in c){d=c[a];Ext.each(b.query(a),function(e){e.on(d)})}},checkForm:function(b){var a=b.getForm(),c=true,d;a.getFields().each(function(e){if(!e.isValid()){d=e.getFieldLabel()+"："+e.getActiveError();c=false;return false}});return d||c},setLoadMask:function(){Ext.Ajax.on("requestcomplete",function(c,b){try{if(b.request.options.loadMaskId){var a=bbt._loadmask[b.request.options.loadMaskId];delete b.loadMaskId;bbt.utils.destroyMask(a)}}catch(d){}})},createMask:function(c,d){var b=new Ext.LoadMask(c,{msg:d}),a=new Date().getTime()+""+Math.random();bbt._loadmask[a]=b;b.show();return a},destroyMask:function(a){if(typeof a=="string"){a=bbt._loadmask[a]}a&&a.hide();a.destroy&&a.destroy()},serializeStore:function(j,h){var a,d=0,g=j.count(),f,b,c={},e;f=j.model.getFields();h=h||{};for(;d<g;d++){a=j.getAt(d);if(typeof b=="string"){return b}e="form-"+d+"-";Ext.each(f,function(l){var k=l.name,i=a.get(k);if(k in h){i=h[k](i)}c[e+k]=i})}c["form-TOTAL_FORMS"]=d;c["form-INITIAL_FORMS"]=0;c["form-MAX_NUM_FORMS"]="";return c}},request:function(a){a=a||{};if(!a.url){return}Ext.Ajax.request(a)},_loadmask:{}};Ext.define("bbt.UserInfo",{singleton:true,_amap:function(b){var c={},d,a;for(d=0,a=b.length;d<a;d++){c[b[d]]=true}return c},_isloading:false,isReady:function(){return !!this._ready},isSchool:function(){if(this.isReady()){return this.level=="school"}return false},update:function(b){var a=this;if(a._isloading){return}Ext.Ajax.request({url:"/details/",callback:function(g,d,j){var h,c,f=false;try{h=Ext.decode(j.responseText)||{};if(h.status=="success"){if(a._lastResponseText!=j.responseText){a._lastResponseText=j.responseText;h=h.data;c={};c.privileges=a._amap(h.privileges);c.permitted_groups=a._amap(h.permitted_groups);a.userdata=c;Ext.apply(a,h);f=true;a._ready=true}}}catch(i){}finally{b&&b(f);a._isloading=false}}});a._isloading=true},isGroup:function(a){try{if(me.superuser){return true}else{return a in this.userdata.privileges}}catch(b){return false}},hasPrivilege:function(a){var b=this;try{if(b.superuser){return true}else{return a in b.userdata.privileges}}catch(c){return false}}});(function(){var b={privileges:null,isSchoolServer:function(){var e=Ext.get(document.getElementById("bbt-server-info")).down("span").getHTML();return Ext.String.trim(e)=="school"},login:function(){var f=Ext.create("Ext.window.Window",{baseCls:"",width:"100%",height:"100%",minHeight:450,minWidth:800,layout:{type:"hbox",align:"stretch"},padding:0,margin:0,bodyCls:"login-win",header:false,shadow:false,border:false,closable:false,resizable:false,items:[{xtype:"panel",border:false,bodyCls:"no-bg",html:'<div class="download-client"><p><img src="/public/images/login/title.png"/></p>'+(this.isSchoolServer()?'<p class="btns"><a class="download" href="/download/client.zip"></a></p>':"")+"</div>",flex:1},{xtype:"form",bodyCls:"login-form-bg",width:392,height:340,flex:1,margin:0,padding:0,border:false,layout:"absolute",defaultType:"textfield",defaults:{height:30,allowBlank:false,enableKeyEvents:true,width:220},items:[{name:"username",emptyText:"      请输入用户名",fieldBodyCls:"login-user",listeners:{focus:function(){if(!this.getValue()){this.addCls("login-user-hover")}},blur:function(){if(!this.getValue()){this.removeCls("login-user-hover")}}}},{name:"password",inputType:"password",hidden:Ext.isIE,emptyText:"      请输入密码",fieldBodyCls:"login-password",listeners:{focus:function(){if(!this.getValue()){this.addCls("login-password-hover")}},blur:function(){if(!this.getValue()){this.removeCls("login-password-hover");if(Ext.isIE){this.hide();this.up("form").down("[name=_]").show()}}}}},{name:"_",emptyText:"      请输入密码",readOnly:true,hidden:!Ext.isIE,allowBlank:true,fieldBodyCls:"login-password",listeners:{focus:function(){var g=this.up("form").down("[name=password]");this.hide();g.show();g.focus()},show:function(){if(this.isDisabled()){this.setDisabled(false)}}}},{xtype:"button",text:"登  录",cls:"login-submit",overCls:"login-submit-hover",border:false,width:98,height:28,handler:function(){var g=this.up("form");e(g)}}]}],listeners:{afterrender:function(){var h=this,g=document.createElement("img");g.src="/public/images/login/login.jpg";h.getEl().down(".x-box-inner").insertFirst(g);Ext.get(g).setSize(h.getWidth(),h.getHeight());h.on("resize",function(){var k=h.getHeight(),i,l,j;Ext.get(g).setSize(h.getWidth(),k);i=Math.round(k*180/811-(340-k*278/811)/2);if(i<0){i=0}h.down("panel").setBodyStyle("marginTop",k*180/811+"px");l=h.down("form");l.setBodyStyle("marginTop",i+"px");j=l.getWidth();l.down("textfield[name=username]").setPosition((j-392)/2+86,90);l.down("textfield[name=password]").setPosition((j-392)/2+86,140);l.down("textfield[name=_]").setPosition((j-392)/2+86,140);l.down("button").setPosition((j-392)/2+306-98,210)});h.on("beforedestroy",function(){g&&g.parentNode.removeChild(g);g=null});Ext.get(window).on("resize",function(){h.updateLayout()})}}}).show();new Ext.util.KeyMap({target:f.down("form").getEl(),key:13,fn:function(){var g=Ext.getCmp(this.target.dom.id);e(g)}});function e(g){var i,h=g.up("window");i=checkForm(g);if(i!==true){Ext.Msg.alert("提示","用户名或密码不可为空！");return}if(e.wait){return}g.down("[name=_]").setDisabled(true);g.getForm().submit({url:"/login/",method:"POST",success:function(j,l){var k=l.result;if(k.status=="success"){h.destroy();b.buildUI()}delete e.wait},failure:function(l,o){var j,n=o.result,m=[n.msg];for(j in n.errors){m=m.concat(n.errors[j])}Ext.Msg.alert("提示",m.join("<br/>"));delete e.wait}});e.wait=true}},init:function(e){bbt.login=true;Ext.onReady(function(){var f=document.getElementById("bbt-server-info");f.parentNode.removeChild(f);new Ext.container.Viewport({layout:"border",padding:5,items:[{region:"north",xtype:"toolbar",margin:"0 0 5 0",id:"app-toolbar"},{region:"west",xtype:"treepanel",bodyCls:"func-menu",title:"主菜单",id:"app-menu",width:220,split:true,collapsible:true,overflowY:"auto",rootVisible:false},{region:"center",xtype:"panel",defaults:{border:false},id:"content-panel",layout:"fit",items:[]}]});Ext.Ajax.on("beforerequest",function(h,g){try{if(g.timeout){g.timeout=g.timeout*2}if(g.params&&g.params.order_direction){g.params.order_direction=g.params.order_direction.toLowerCase()}}catch(i){}});bbt.loadScript();e&&e();Ext.Ajax.on("requestcomplete",function(g,k){var i=Ext.decode(k.responseText),h;if(i.status=="not login"){Ext.Msg.alert("提示","登录失败！",function(l){location.pathname="/"})}try{h=k.request.options.url;if(h.indexOf("/statistic/")===0||h.indexOf("/activity/")===0){if(i.status!="success"){Ext.Msg.alert("提示",i.msg)}}}catch(j){}});Ext.QuickTips.init();Ext.override(Ext.toolbar.Toolbar,{onBeforeAdd:function(g){var h=g.ui;if(g.is("field")){g.ui=g.ui+"-toolbar"}if(g instanceof Ext.toolbar.Separator){g.setUI((this.vertical)?"vertical":"horizontal")}this.callParent(arguments);if(g.is("button")){g.ui=h}}});Ext.getDoc().on("keydown",function(h){var g=h.target;if(h.getKey()===Ext.EventObject.BACKSPACE){if(g.editable===true||Ext.Array.contains(["input","textarea"],g.tagName.toLowerCase())){}else{h.stopEvent()}}})})},buildUI:function(){var e;if(!bbt.UserInfo.isReady()){bbt.UserInfo.update()}Ext.Ajax.request({url:"/privileges/",success:function(g){var f=Ext.decode(g.responseText);b.privileges=f.data},failure:function(){b.blueScreen("无法连接服务器")}});e=function(){b.init(function(){var g,h,i,j=bbt.UserInfo.userdata.privileges,f;g=function(o){var m,k,l,n=[];if(!Ext.isArray(o)){o=[o]}for(m=0,k=o.length;m<k;m++){if(o[m].privileges){o[m].privileges=g(o[m].privileges);if(o[m].privileges.length===0){continue}}else{if(!(o[m].key in j)){continue}}n.push(o[m])}return n};f=g(b.privileges);h=b.privilege2Tree(f);b.initMenu(h);i=b.privilege2ButtonGroup(f);b.initToolbar(i);b.initMainUIEvents();c("global_statistic")})};setTimeout(function(){if(bbt.UserInfo.isReady()&&b.privileges){e()}else{setTimeout(arguments.callee,1)}},1)},initToolbar:function(g){var f=Ext.getCmp("app-toolbar"),e=bbt.UserInfo,h;h={province:"省级管理员",city:"地市州级管理员",country:"区县市级管理员",school:"校级管理员"};g.push("->");g.push({xtype:"button",icon:"/public/images/user.png",scale:"large",text:"您好，"+h[e.level]+"："+e.username,menu:{items:[{text:"退出",icon:"/public/images/exit.png",handler:function(){Ext.Msg.confirm("提示","确定要退出吗？",function(i){if(i=="yes"){apiRequest("logout",function(){window.location.reload()})}})}}]}});f.add(g)},initMenu:function(e){var f=Ext.getCmp("app-menu");f.getRootNode().appendChild(e)},initMainUIEvents:function(){var g=Ext.getCmp("app-menu"),f,e;g.addDocked({dock:"top",xtype:"toolbar",items:[{text:"全部展开",icon:"/public/images/expand-all.gif",handler:function(){this.up("treepanel").expandAll()}},"-",{text:"全部折叠",icon:"/public/images/collapse-all.gif",handler:function(){this.up("treepanel").collapseAll()}}]});g.on({collapse:function(){this.placeholder.getEl().on("mouseenter",function(){this.floatCollapsedPanel()},this)}});g.on("itemclick",function(j,h){var i=h.raw.key;i&&c(i)});g.on("itemexpand",function(i,j){var h=this.getView().getNode(i);Ext.get(h).down(".x-grid-cell-inner").setStyle("border-bottom","0px solid #99bce8")});g.on("itemcollapse",function(i,j){var h=this.getView().getNode(i);Ext.get(h).down(".x-grid-cell-inner").setStyle("border-bottom","1px solid #99bce8")});f=Ext.getCmp("app-toolbar");e=function(h){if(!h){return}if(h.key){h.handler=c}if(h.menu){h.on("mouseover",function(){if(!this.menu.isVisible()){this.showMenu()}});h.on("mouseout",function(){if(this.menu.isVisible()){this.hideMenu()}});h.menu.on("mouseenter",function(){this.show()});h.menu.on("mouseleave",function(){this.hide()});h.menu.items.each(e)}};f.items.each(e)},blueScreen:function(f){var e=document.createElement("div");e.style.cssText="position:absolute;top:0;left:0;bottom:0;right:0;background-color: blue;color: #FFF;font-size: 48px;padding-top:50px;";e.innerHTML=f||"unknow error, please contact your administrator!";Ext.onReady(function(){document.body.appendChild(e)})},privilege2Tree:function(h){var e=[],f,i=2,g={general:"",activity:"",statistic:"",asset:"",system:""};f=function(j,l){var k={text:j.name,key:j.key};if(Ext.isArray(j.privileges)&&l<i){k.leaf=false;k.expanded=true;k.children=[];(k.key in g)&&(k.icon="/public/images/"+k.key+"16.png");Ext.each(j.privileges,function(m){m.is_hide||k.children.push(f(m,l+1))})}else{k.leaf=true}return k};if(!Ext.isArray(h)){h=[h]}Ext.each(h,function(j){e.push(f(j,1))});return e},privilege2ButtonGroup:function(g){var i=[],h,f,j=2,e={general:"",activity:"",statistic:"",asset:"",system:""};f=function(k){var l=[];Ext.each(k,function(n){var m={text:n.name,key:n.key};n.is_hide||l.push(m)});return l};h=function(k){var m=k.key in e?"/public/images/"+k.key+"32.png":null;var l={xtype:"button",text:k.name,key:k.key,scale:"large",icon:m};if(k.privileges){l.menu=f(k.privileges)}return l};if(!Ext.isArray(g)){g=[g]}Ext.each(g,function(k){i.push(h(k))});return i}},c,a={global_statistic:{xtype:"panel",title:"实时概况 > 班班通全局数据",layout:"border",defaults:{border:false},items:[{region:"west",bodyCls:"r-border",xtype:"bbt_area",width:200,split:true},{region:"center",xtype:"bbt_globalview",bodyCls:"l-border"}]},global_login_status:{xtype:"panel",title:"实时概况 > 班班通登录状态",layout:"border",defaults:{border:false},items:[{region:"west",bodyCls:"r-border",xtype:"bbt_area",width:200,split:true,schoolFirst:true,quickSearch:true,pinyinSupport:true,currentAsRoot:true},{region:"center",xtype:"loginstatuspanel",bodyCls:"l-border"}]},global_desktop_preview:{xtype:"panel",title:"实时概况 > 班班通桌面预览",layout:"border",defaults:{border:false},items:[{region:"west",bodyCls:"r-border",xtype:"bbt_area",width:200,split:true,schoolFirst:true,pinyinSupport:true,quickSearch:true},{region:"center",xtype:"desktoppreview",bodyCls:"l-border"}]},global_computer_room:{xtype:"",title:"实时概况 > 电脑教室全局数据",feature:true},global_computer_room_desktop_preview:{xtype:"",title:"实时概况 > 电脑教室桌面预览",feature:true},global_teaching_venue:{xtype:"",title:"实时概况 > 教学点全局数据",feature:true},maintenance_reset:{xtype:"maintainpanel",title:"运维管理 > 终端远程关机重启"},maintenance_vnc:{xtype:"remotehelppanel",title:"运维管理 > 远程桌面协助"},maintenance_trans_file:{xtype:"",title:"运维管理 > 文件发送",feature:true},maintenance_post:{xtype:"noticewindow",title:"运维管理 > 校园电子公告",window:true},maintenance_msg:{xtype:"",title:"运维管理 > 消息发送",feature:true},activity_computer_room:{xtype:"",title:"使用记录 > 电脑教室使用日志",feature:true},activity_teaching_venue:{xtype:"",title:"使用记录 > 教学点使用日志",feature:true},statistic_teaching_venue_satellite_download:{xtype:"",title:"统计分析 > 教学点资源卫星下载统计",feature:true},activity_desktop_preview:{xtype:"previewlog",title:"统计分析 > 班班通桌面使用日志",border:false},teaching_analysis:{xtype:"cphcount",title:"使用记录 > 班班通授课综合分析",border:false},resource_analysis:{xtype:"",title:"统计分析 > 班班通资源使用分析",feature:true},asset_log:{xtype:"assetmgr",title:"资产管理 > 资产统计与申报",border:false},system_user:{xtype:"bbt_usermanager",title:"系统设置 > 用户管理",border:false},system_role:{xtype:"bbt_rolemanager",title:"系统设置 > 角色管理",border:false},system_grade_class:{xtype:"gc",title:"系统设置 > 年级班级管理",border:false},system_lesson_period:{xtype:"worktime",title:"系统设置 > 学校作息时间管理",border:false},system_lesson_name:{xtype:"lesson",title:"系统设置 > 学校开课课程管理",border:false},system_new_lesson_name:{xtype:"lesson2",title:"系统设置 > 学校开课课程管理",border:false},system_teacher:{xtype:"teacher",title:"系统设置 > 教职人员信息管理",border:false},system_class_lesson:{xtype:"tabpanel",title:"系统设置 > 班级课程综合管理",items:[{xtype:"coursetable",title:"课程表管理",border:false},{xtype:"teachinfo",title:"班级课程授课老师管理",border:false}]},system_resource:{xtype:"bbt_resource",title:"系统设置 > 资源管理",border:false},system_term:{xtype:"term",title:"系统设置 > 学年学期管理",border:false},system_newterm:{xtype:"panel",border:false,layout:"card",items:[{xtype:"term2",title:"系统设置 > 学年学期管理",border:false},{xtype:"courseoutline",title:"系统设置 > 学期关联教材大纲",border:false}]},system_sync_server:{xtype:"bbt_setting",title:"系统设置 > 系统设置",window:true},system_node:{xtype:"bbt_nodemanager",title:"系统设置 > 服务器汇聚管理",border:false},system_restore:{xtype:"bbt_restore",title:"系统设置 > 数据还原",window:true},system_desktop_preview:{xtype:"preview_settings",title:"系统设置 > 桌面预览设置",window:true},system_school_server_setting:{xtype:"school_setting",title:"系统设置 > 校级服务器设置",window:true},system_baseinfo:{xtype:"basicinfo",title:"系统设置 > 基础信息同步查看",border:false},system_about:{xtype:"bbt_about",title:"系统设置 > 关于",window:true}},d;bbt.UserInfo.update(function(e){if(e){b.buildUI()}else{Ext.onReady(function(){b.login()})}});Ext.onReady(function(){var g=document.getElementById("bbt-server-info"),f={school:"校级服务器",country:"区县市级服务器",city:"地市州级服务器",province:"省级服务器"},e;e=g.innerHTML.replace(/\{ (\w+)? \}/,function(h,i){return f[i]});g.innerHTML=e});c=function(g){if(typeof g!="string"){g=g.key}if(g===d){return}var e,f;e=a[g];if(!e){e=bbtConfig.get(g)}if(!e){return}if(e.window){if(e.show){e.show()}else{Ext.widget(e)}return}else{if(e.feature){e={xtype:"new_feature",title:e.title,border:false}}}f=Ext.getCmp("content-panel");f.removeAll(true);f.add(e);d=g}})();var EStore=Ext.data.Store,tools=tools||{},bbtConfig={map:{logged_in:"bbtUsageLog.login",not_logged_in:"bbtUsageLog.unlogin",teacher_lesson_statistic:"bbtAnalyzeStatic.teachCount",teacher_number_statistic:"bbtAnalyzeStatic.teacherNumber",teacher_absent_statistic:"bbtAnalyzeStatic.unlogin",resource_statistic:"bbtAnalyzeStatic.resource",asset_report_log:"bbtAnalyzeStatic.assetlist",asset_repair:"bbtAnalyzeStatic.assetrepairhistosy",time_used_statistic:"bbtAnalyzeStatic.timeUsedCount"},gridDefaults:{title:"",url:"",tools:null,pagination:false,status:"",statusRender:null,columns:null,sorters:null},getAssetIcon:function(a){return"/public/images/asset/"+a+".png"},get:function(a){if(a in bbtConfig.map){a=bbtConfig.map[a]}else{return}var d=a.split("."),c=bbtConfig,b;while(d.length){c=c[d.shift()];if(typeof c=="undefined"){return null}}c=Ext.clone(c);if(!Ext.isArray(c.grid)){c.grid=[c.grid]}Ext.each(c.grid,function(n,f,k){var h,l,o,e,g={menuDisabled:true,sortable:false,draggable:false},j,m;h=Ext.Array.map(n.columns,function(i){Ext.applyIf(i,g);return i.dataIndex});l=new Ext.data.Store({fields:h,proxy:{type:"ajax",url:n.url,reader:{type:"json",root:"data.records",totalProperty:"data.record_count"},extraParams:{},sortParam:"order_field",pageParam:"page",directionParam:"order_direction",simpleSortMode:true,startParam:undefined},sorters:n.sorters,remoteSort:true});if(n.statusTemplate){o={xtype:"pagingtoolbar",store:l,items:["->",{xtype:"tbtext",itemId:"status",statusTemplate:true}],statusTemplate:n.statusTemplate,displayInfo:false,statusRender:n.statusRender||function(){return""},listeners:{boxready:function(){var q=this,p=q.store,i;q.down("textfield").setWidth(60);i=function(){q.down("tbtext[statusTemplate]").setText(q.statusRender(q.statusTemplate,q,p))};p.on("load",i);if(!p.isLoading()){i()}q.on("beforedestroy",function(){p.un("load",i)})}}}}else{o={xtype:"pagingtoolbar",store:l,displayInfo:true,listeners:{boxready:function(){this.down("textfield").setWidth(60)}}}}j=bbt.ToolBox.convert(n.tools);k[f]={xtype:"grid",border:false,columns:n.columns,dockedItems:j[0].xtype=="toolbar"?j:{xtype:"toolbar",dock:"top",items:j},columnLines:true,features:e,bbar:o,store:l,title:n.title,viewConfig:{stripeRows:true,forceFit:true},exportUrl:n.exportUrl,chart:n.chart,listeners:{viewready:function(){var q,s=this,t=n.query||{},p=s.query("toolbar[dock=top]"),i=[],r,u;Ext.each(p,function(v){Ext.each(v.query("[name]"),function(y){var x;if(y.is("combo")){i.push(y)}if(y.name in t){x=t[y.name];if(typeof x=="function"){x=x()}y.setValue(x)}});var w=v.down("button[action=query]");w&&(r=w)});u=setInterval(function(){var v=false;Ext.each(i,function(w){if(w.store&&w.store.isLoading()){v=true;return false}});if(!v){clearInterval(u);r.handler.call(r)}},10)}}}});if(c.grid.length===1){c=c.grid[0]}else{c={xtype:"tabpanel",title:c.title,border:false,items:c.grid}}b=Ext.widget(c.xtype,c);bbt.autoFill(b);if(!bbt.UserInfo.isSchool()){bbt.autoArea(b)}return b},tmplReg:/\{(\w+)\}/g,isEmpty:function(a){return a===null||a===undefined||a===""},tmpl:function(b,d,a){var c=this;if(typeof a=="undefined"){a=""}return b?b.replace(c.tmplReg,function(e,f){return c.isEmpty(d[f])?a:d[f]}):""}};Ext.define("bbt.areaTree",{extend:"Ext.tree.Panel",alias:"widget.bbt_area",initComponent:function(){var a=new Ext.data.TreeStore({root:{text:"所有",expanded:true,children:[]}});Ext.apply(this,{store:a,rootVisible:false,useArrows:true,displayField:"text",listeners:{itemclick:function(c,b){this.fireClick(b)},viewready:function(){this.updateStore(function(c){var b=false;c.getRootNode().cascadeBy(function(d){if(b){return false}if(c.schoolFirst){if(d.raw.group_type=="school"){c.fireClick(d);b=true;return false}}else{if(d.raw.group_type==bbt.UserInfo.level){c.fireClick(d);b=true;return false}}});c.isStoreLoaded=true;c.fireEvent("load",c);if(!bbt.UserInfo.isSchool()){c.calcSchool()}})}}});if(!bbt.UserInfo.isSchool()&&this.quickSearch){this.tbar=[{xtype:"combo",displayField:"text",valueField:"value",querMode:"local",hideTrigger:true,emptyText:"查找“实验小学”？试试输入“syxx”",width:"100%",store:new Ext.data.Store({fields:["text","value"]}),afterSubTpl:'<a class="search-box" href="javascript:void(0);"></a>',doSearch:function(){var c=this.getValue(),b,d;this.collapse();if(!c){return}c=Ext.String.trim(c);b=this.up("treepanel").getRootNode();d=[];if(!c){return}b.cascadeBy(function(g){var f=g.data.text||"",e=g.raw.first_letter||"";if(g.raw.group_type!="school"){return}if(f.indexOf(c)!==-1||e.indexOf(c)!==-1){d.push({text:f,value:f,node:g})}});this.store.removeAll();this.store.add(d);this.expand()},listeners:{afterrender:function(){this.getEl().down(".search-box").on("click",function(){this.hide()})},focus:function(){this.selectText()},blur:function(){this.getEl().down(".search-box").show()},change:function(){this.doSearch()},select:function(c,d){var b;if(d.length){d=d[0].raw.node;b=c.up("treepanel");b.collapseAll();b.selectPath(d.getPath("text"),"text");setTimeout(function(){var e=b.getView().getNode(d);bbt.simulateClick(e)},400)}}}}]}this.callParent()},calcSchool:function(){var a=this.getRootNode(),b;b=function(f){var d,c,e=0;if(f.raw.group_type=="town"){e=f.childNodes.length}else{for(d=0,c=f.childNodes.length;d<c;d++){e+=b(f.childNodes[d])}}f.set("text",f.get("text")+"("+e+")");f.commit();return e};b(a)},fireClick:function(b){var a=Ext.getCmp("content-panel").down("panel[region=center]");a.onLevelChange&&a.onLevelChange(b.raw.group_type||"grade",b.raw.uuid);this.selectPath(b.getPath("text"),"text")},updateStore:function(a){var b=this,c;if(this.pinyinSupport){c={first_letter:"true"}}Ext.Ajax.request({url:"/group/",method:"GET",params:c,success:function(g){var d;try{d=Ext.decode(g.responseText)}catch(f){d={}}if(d.status=="success"){d=d.data;b._parse(d);a&&a(b)}}})},_parse:function(f){var j=this,k,c={},a,i,h,d,b=bbt.UserInfo.level,l=bbt.UserInfo.isSchool(),e;Ext.each(f.group,function(g){g.iconCls="icon-"+g.group_type;c[g.uuid]=g;if(!g.parent__uuid){k=g}if(g.group_type==b){e=g.uuid}});if(f.grade&&f.grade.length){i="一 二 三 四 五 六 七 八 九 十 十一 十二".split(" ");f.grade.sort(function(n,m){var g=Ext.Array.indexOf(i,n.name),o=Ext.Array.indexOf(i,m.name);return g-o});Ext.each(f.grade,function(m){var g=c[m.term__school__uuid];if(!g.children){g.children=[]}m.leaf=true;m.text=m.name+"年级";m.icon="/public/images/grade.png";g.children.push(m)})}else{f.grade=false}for(a in c){h=c[a];if(!f.grade&&h.group_type=="school"){h.leaf=true}else{h.leaf=false}h.expanded=true;h.text=h.name;if(!h.parent__uuid){k=h;continue}d=c[h.parent__uuid];if(!d.children){d.children=[]}d.children.push(h)}if(j.currentAsRoot){this.getRootNode().appendChild(c[e].children)}else{this.getRootNode().appendChild(k)}}});Ext.chart.theme.bbt=Ext.extend(Object,{constructor:function(a){Ext.chart.theme.Base.prototype.constructor.call(this,Ext.apply({colors:["#398439","#269abc","#d58512","#285e8e","#ac2925"]},a))}});Ext.define("bbt.chart",{extend:"Ext.panel.Panel",alias:"widget.bbt_chart",initComponent:function(){this.border=false;this.layout={type:"vbox",align:"stretch"};this.chart.flex=9;this.chart.theme="bbt";this.chart.border=false;this.items=[this.chart,{xtype:"panel",border:false,height:32,padding:5,html:'<ul class="bbt-legend"></ul>'}];this.callParent()},addItem:function(d,b){var a=document.createElement("li"),c;a.innerHTML='<a href="javascript:void(0)"><b style="background-color:'+b+';"></b>'+d+"</a>";c=this.getEl().query(".bbt-legend")[0];c.appendChild(a)},clearItems:function(){var a=this.getEl().query(".bbt-legend")[0];a&&(a.innerHTML="")}});new EStore({id:"ClassNumStore",fields:["number","label"]});new EStore({id:"ClassNumStore2",fields:["name","num"]});new EStore({id:"TeacherNumStore",fields:["number","label"]});new EStore({id:"TeacherNumStore2",fields:["name","num"]});Ext.define("bbt.globalView",{extend:"Ext.panel.Panel",alias:"widget.bbt_globalview",minWidth:800,initComponent:function(){var a=this;Ext.apply(a,{border:false,minWidth:450,minHeight:500,layout:{type:"vbox",align:"stretch"},defaults:{flex:1,border:false},listeners:{beforedestroy:function(){var c=["ClassNumStore","ClassNumStore2","TeacherNumStore","TeacherNumStore2"],d=0,b=c.length;for(;d<b;d++){Ext.getStore(c[d]).removeAll()}}}});a.items=[{xtype:"panel",layout:{type:"hbox",align:"stretch"},defaultType:"bbt_chart",defaults:{flex:1,border:false},items:[{bodyCls:"rb-border",chart:{xtype:"chart",theme:"Green",store:"ClassNumStore",animate:true,series:[{type:"pie",highlight:true,showInLegend:true,angleField:"number",tips:{trackMouse:true,width:120,renderer:function(b){this.setTitle(b.get("label"))}},label:{display:"rotate",field:"label",contrast:true,color:"#F06000"},renderer:function(g,d,b,f,e){var c=["#d58512","#398439"];return Ext.apply(b,{fill:c[f%c.length]})}}],listeners:{afterrender:this.addClassItems,refresh:this.addClassItems}}},{bodyCls:"b-border",chart:{xtype:"chart",theme:"Green",store:"TeacherNumStore",animate:true,series:[{type:"pie",highlight:true,showInLegend:true,angleField:"number",tips:{trackMouse:true,width:120,renderer:function(b){this.setTitle(b.get("label"))}},label:{display:"rotate",field:"label",contrast:true,color:"#F06000"},renderer:function(g,d,b,f,e){var c=["#d58512","#398439"];return Ext.apply(b,{fill:c[f%c.length]})}}],listeners:{afterrender:this.addTeacherItems,refresh:this.addTeacherItems}}}]},{xtype:"panel",layout:{type:"hbox",align:"stretch"},defaultType:"bbt_chart",defaults:{flex:1,border:false},items:[{bodyCls:"r-border",chart:{xtype:"chart",theme:"Sky",animate:true,store:"ClassNumStore2",axes:[{type:"Numeric",position:"left",fields:["num"],title:"在线班级数量",minimum:0,maximum:10},{type:"Category",position:"bottom",fields:["name"],label:{renderer:function(b){if(b&&b.length>5){return b.substring(0,5)+"..."}return b}}}],series:[{type:"column",axis:"left",gutter:100,style:{width:30},highlight:true,tips:{trackMouse:true,width:140,renderer:function(b){b.get("name")&&this.setTitle(b.get("name")+":"+b.get("num"))}},label:{display:"insideEnd",field:"num",contrast:true},xField:"name",yField:"num",renderer:function(g,d,b,f,e){var c=["#398439","#269abc","#d58512","#285e8e","#ac2925","#F00"];return Ext.apply(b,{fill:c[f%c.length]})}}],listeners:{afterrender:this.addOnlineClassItems,refresh:this.addOnlineClassItems}}},{chart:{xtype:"chart",animate:true,theme:"Sky",store:"TeacherNumStore2",axes:[{type:"Numeric",position:"left",fields:["num"],title:"在线教师数量",minimum:0,maximum:10},{type:"Category",position:"bottom",fields:["name"],label:{renderer:function(b){if(b&&b.length>5){return b.substring(0,5)+"..."}return b}}}],series:[{type:"column",gutter:100,axis:"left",highlight:true,style:{width:30},tips:{trackMouse:true,width:140,renderer:function(b){b.get("name")&&this.setTitle(b.get("name")+":"+b.get("num"))}},label:{display:"insideEnd",field:"num",contrast:true},xField:"name",yField:"num",renderer:function(g,d,b,f,e){var c=["#398439","#269abc","#d58512","#285e8e","#ac2925","#F00"];return Ext.apply(b,{fill:c[f%c.length]})}}],listeners:{afterrender:this.addOnlineTeacherItems,refresh:this.addOnlineTeacherItems}}}]}];a.callParent()},onLevelChange:function(d,c){var b=["province","city","country","town","school","grade"],a=bbt.UserInfo.level;if(Ext.Array.indexOf(b,d)<Ext.Array.indexOf(b,a)){this.update({uuid:c,type:a})}else{this.update({uuid:c,type:d})}},addOnlineClassItems:function(d){var b=0,a;a=d.up("bbt_chart");a.clearItems();d.store.each(function(e,c){b+=e.get("num")});a.addItem("在线班级（TOP 5）："+b,"#FFF")},addOnlineTeacherItems:function(d){var b=0,a;a=d.up("bbt_chart");a.clearItems();d.store.each(function(e,c){b+=e.get("num")});a.addItem("在线教师（TOP 5）："+b,"#FFF")},addClassItems:function(e){var a=["#d58512","#398439"],d=0,b;b=e.up("bbt_chart");b.clearItems();e.store.each(function(f,c){b.addItem(f.get("label"),a[c]);d+=f.get("number")});b.addItem("班级总数："+d,"#FFF")},addTeacherItems:function(e){var a=["#d58512","#398439"],d=0,b;b=e.up("bbt_chart");b.clearItems();e.store.each(function(f,c){b.addItem(f.get("label"),a[c]);d+=f.get("number")});b.addItem("教师总数："+d,"#FFF")},updateMaximum:function(a,c){var d=function(g,f){return g.num>f.num?1:-1},e=Ext.Array.max(a,d),b=Ext.Array.max(c,d);Ext.each(this.query("chart"),function(f){if(f.store.storeId=="ClassNumStore2"){e&&e.num&&(f.axes.get(0).maximum=e.num+10)}else{if(f.store.storeId=="TeacherNumStore2"){b&&b.num&&(f.axes.get(0).maximum=b.num+10)}}})},getDefaultArea:function(){var a=this.up("panel").down("bbt_area").getRootNode(),b={type:bbt.UserInfo.level};a.cascadeBy(function(c){if(c.raw.group_type===bbt.UserInfo.level){b.uuid=c.raw.uuid;return false}});return b},update:function(c){var b=this,a;c=c||b.getDefaultArea();a=bbt.utils.createMask(b,"Loading");Ext.Ajax.request({url:"/global_statistic/",method:"GET",params:c,success:function(g){var f=Ext.decode(g.responseText),d,e;if(f.status=="success"){d=Ext.getStore("ClassNumStore");d.removeAll();d.loadData(b.parseData(f.data["class"],"班级数"));d=Ext.getStore("TeacherNumStore");d.removeAll();d.loadData(b.parseData(f.data.teacher,"教师数"));b.updateMaximum(f.data["class"]["online_list"],f.data.teacher["online_list"]);d=Ext.getStore("ClassNumStore2");d.removeAll();e=f.data["class"]["online_list"];d.loadData(e.length?e:[{name:"",number:0}]);d=Ext.getStore("TeacherNumStore2");d.removeAll();e=f.data.teacher["online_list"];d.loadData(e.length?e:[{name:"",number:0}])}},callback:function(){bbt.utils.destroyMask(a)}})},parseData:function(c,b){var a=[{label:"在线"+b+"："+c.online,number:c.online},{label:"离线"+b+"："+c.offline,number:c.offline}];return a}});function apiRequest(a,g,j,d){var h="",e,i,c,f,b;if(typeof g=="function"){j=g;g={}}if(g.id){h="?id="+g.id;delete g.id}if(g.form){c=g.form;delete g.form}e=apiRequest.msg||"正在获取数据……";i=apiRequest.target||g.waitTarget||(c&&c.up("panel"))||document.body;g.waitTarget&&(delete g.waitTarget);apiRequest.msg&&(delete apiRequest.msg);apiRequest.target&&(delete apiRequest.target);f={url:a+h,params:g};if(c){c=c.getForm();c.waitMsgTarget=i.getEl();f.waitMsg=e;f.success=function(k,l){j(l.result)};f.failure=function(k,l){Ext.Msg.alert("提示",getErrorMsg(l.result))};c.submit(f)}else{b=new Ext.LoadMask(i,{msg:e});b.show();f.timeout=30*60*1000;f.callback=function(k,l,m){b.hide();onResponse(m,j,d);b.destroy()};Ext.Ajax.request(f)}}function decodeResponse(c){var a;try{a=Ext.JSON.decode(c.responseText)}catch(b){a={}}return a}function checkForm(a){var b=true,c;if(a.is&&a.is("form")){a=a.getForm()}a.getFields().each(function(d){if(!d.isValid()){c=d.getFieldLabel()+"："+d.getActiveError();b=false;return false}});return c||b}function checkPassword(b,a,c){if(arguments.length===1){a="password",c="password_confirmation"}b.xtype==="form"&&(b=b.getForm());var e=b.findField(a).getValue();var d=b.findField(c).getValue();return e===d}function downloadFile(b,a){Ext.create("Ext.window.Window",{title:"下载文件",modal:true,width:240,height:120,layout:{type:"vbox",pack:"center",align:"center"},items:[{html:"点击下面的按钮下载"+a+"！",bodyCls:"no-bg",border:false,margin:20},{xtype:"button",text:"确定",href:b,margin:"-5 0 0 0",listeners:{click:function(){var c=this.up("window");setTimeout(function(){c.destroy()},500)}}}]}).show()}function getErrorMsg(b){var a,d;try{if(typeof b=="string"){b=Ext.decode(b);d=b.msg}}catch(c){d="未知的错误!"}for(a in b){break}if(!a){return"服务器错误！"}if(b.errors){if(Ext.isObject(b.errors)){b.errors=[b.errors]}d=Ext.Array.map(b.errors,function(f){var e,g;for(e in f){g=f[e];if(Ext.isArray(g)){g=g.join(";")}break}return g});return d.join("<br/>")}return d||b.msg}function onItemDelete(c,b,a){if(arguments.length==1){a=c;c="提示";b="确定要删除吗？"}else{if(arguments.length==2){a=b,b=c;c="提示"}}c=c||"提示";Ext.Msg.confirm(c,b,function(d){if(d=="yes"){a&&a()}})}function onResponse(d,a,e){var b=decodeResponse(d),c;switch(b.status){case"success":a&&a(b);break;case"failure":c="操作失败！";c+="<br/>"+getErrorMsg(b);break;default:c="服务器异常！";break}if(c){if(typeof e=="function"){e(c)}else{if(e!==true){Ext.Msg.alert("提示",c)}}}}function timeit(c){var b=timeit.lastTime,a=new Date().getTime();if(b){console.log(c,a,a-b)}else{console.log(c,a)}timeit.lastTime=a};