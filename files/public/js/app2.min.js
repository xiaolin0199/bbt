Ext.define("bbt.ToolBox",{singleton:true,get:function(c,d){if(c=="->"){return c}if(typeof c=="object"){return c}var b=this._tools[c],a;if(typeof b=="function"){a=b()}else{a=Ext.clone(b)}if(d){Ext.apply(a,d)}return a},register:function(c,b){var a;if(arguments.length===1){for(a in c){this.register(a,c[a])}}else{if(c in this._tools){throw new Error("tool "+c+" already exists!")}else{this._tools[c]=b}}},convert:function(e){var d=this,c,a,b=[];if(typeof e=="string"){return d.get(e)}else{if(Ext.isArray(e)){for(c=0,a=e.length;c<a;c++){if(Ext.isArray(e[c])){b.push({xtype:"toolbar",dock:"top",items:Ext.Array.map(e[c],function(f){return d.get(f)})})}else{b.push(d.get(e[c]))}}return b}}return[]},_tools:{}});bbt.ToolBox.register({resourceType:function(){var a=new Ext.data.Store({fields:["uuid","value"],data:[{value:"所有"}],proxy:{type:"ajax",url:"/system/resource/resource-type/",reader:{type:"json",root:"data.records"}},pageSize:1000,listeners:{load:function(c,b){c.insert(0,{value:"所有"})}}});a.load();return{xtype:"combo",name:"resource_type",displayField:"value",valueField:"uuid",submitField:"value",editable:false,fieldLabel:"资源类型",labelWidth:60,width:145,queryMode:"local",store:a,value:"所有"}},resourceFrom:function(){var a=new Ext.data.Store({fields:["uuid","value"],data:[{value:"所有"}],proxy:{type:"ajax",url:"/system/resource/resource-from/",reader:{type:"json",root:"data.records"}},pageSize:1000,listeners:{load:function(c,b){c.insert(0,{value:"所有"})}}});a.load();return{xtype:"combo",name:"resource_from",editable:false,fieldLabel:"资源来源",displayField:"value",valueField:"uuid",submitField:"value",queryMode:"local",labelWidth:60,width:180,store:a,value:"所有"}},grade:function(){var a={xtype:"combo",name:"grade_name",fieldLabel:"年级",labelWidth:40,width:95,skipAutoValue:true,editable:false,displayField:"name",submitField:"name",valueField:"uuid",queryMode:"local",listConfig:{minWidth:40},store:new Ext.data.Store({fields:["uuid","name"],data:[{name:"所有"}],pageSize:500,proxy:{url:"/list/get-grade-class/",type:"ajax",reader:{type:"json",root:"data.grade"}},sorters:[{sorterFn:function(b,g){var d={"一":1,"二":2,"三":3,"四":4,"五":5,"六":6,"七":7,"八":8,"九":9,"十":10},f,e,c;if(!b.get("value")){return -1}c=function(h){if((h.indexOf("十一")===0)){return 11}if((h.indexOf("十二")===0)){return 12}return d[h]};f=c(b.get("name"));e=c(g.get("name"));return f-e}}],listeners:{beforeload:bbt.beforeCascadeLoad,load:function(b){var c;try{b.owner.ownerCt.down("[name=class_name]").store.rawData=b.proxy.reader.rawData.data["class"]}catch(d){console.log(d)}c=b.getAt(0);if(!c||(c&&c.get("name")!="所有")){b.insert(0,{name:"所有",uuid:null})}if(b.expandOnLoad){b.owner.expand();dv=b.defaultValueOnLoad;if(b.owner.findRecordByValue(dv)){b.owner.setValue(dv)}delete b.expandOnLoad;delete b.defaultValueOnLoad}}}}),value:"",listeners:{beforerender:function(){this.store.owner=this},change:function(c,b){var d=c.findRecordByValue(b),e;e=c.ownerCt.down("[name=class_name]");e&&e.updateStore(d)},expand:function(){var b=this.lastLoadConditions,c=false,d=this.ownerCt.ownerCt;if(bbt.UserInfo.isSchool()){if(typeof b=="undefined"){b=this.lastLoadConditions={};c=true}Ext.each(["school_year","term_type","start_date","end_date"],function(f){var g=d.down("[name="+f+"]"),e;if(g){e=g.getValue();if(Ext.isDate(e)){e=Ext.Date.format(e,"Y-m-d")}if(e!==b[f]){b[f]=e;c=true}}});if(c){this.store.expandOnLoad=true;this.store.defaultValueOnLoad=this.getValue();this.store.load()}}}}};return a},gradeOld:function(){var a=new Ext.data.Store({fields:["text","fulltext","value","sub"],pageSize:500,sorters:[{sorterFn:function(b,g){var d={"一":1,"二":2,"三":3,"四":4,"五":5,"六":6,"七":7,"八":8,"九":9,"十":10},f,e,c;if(!b.get("value")){return -1}c=function(h){if((h.indexOf("十一")===0)){return 11}if((h.indexOf("十二")===0)){return 12}return d[h]};f=c(b.get("value"));e=c(g.get("value"));return f-e}}],listeners:{beforeload:function(){var b=this;Ext.Ajax.request({url:"/classes/",callback:function(c,n,e){var h=Ext.decode(e.responseText),p={},m=[],f,j,l,d,k,o=b.owner.useSuffix;if(b.owner.displayAll){m.push({text:"所有",value:""})}if(h.status!=="success"){return}for(j=0,l=h.data.length;j<l;j++){f=h.data[j];if(!(f.grade__name in p)){p[f.grade__name]=[]}p[f.grade__name].push({text:f.name,value:f.name})}for(k in p){if(o){m.push({text:bbt.fullgrade(k),value:k,sub:p[k]})}else{m.push({text:k,value:k,sub:p[k]})}}b.loadData(m);b.owner.setValue("")}});return false}}});return{xtype:"combo",fieldLabel:"年级",labelWidth:40,name:"grade_name",width:95,queryMode:"local",store:a,editable:false,displayAll:true,displayField:"text",valueField:"value",listConfig:{minWidth:40},listeners:{afterrender:function(){this.store.owner=this;this.store.load()},change:function(d,c){var f=d.findRecordByValue(c),h=f?f.get("sub"):null,b;if(!Ext.isArray(h)){h=[]}try{b=d.ownerCt.down("combo[name=class_name]");b.store.loadData(h);if(b.displayAll){b.store.insert(0,{text:"所有",value:""})}b.setValue("")}catch(g){}}}}},"class":function(){var a=new Ext.data.Store({fields:["name","uuid"],data:[{name:"所有"}],sorters:[{property:"text",sorterFn:function(b,c){if(!b.get("value")){return -1}return parseInt(b.get("value"))-parseInt(c.get("value"))}}]});return{xtype:"combo",name:"class_name",fieldLabel:"班级",store:a,skipAutoValue:true,value:"",listConfig:{minWidth:40},queryMode:"local",displayField:"name",valueField:"uuid",submitField:"name",editable:false,labelWidth:40,width:95,updateStore:function(f){var d=this.store,c=d.rawData,e=[{name:"所有"}],b=f.get(this.valueField);d.removeAll();if(b){Ext.each(c,function(g){if(g.grade===b){e.push(g)}})}d.add(e);this.setValue("")}}},classOld:function(){var a=new Ext.data.Store({fields:["text","value"],data:[{text:"所有",value:""}],sorters:[{property:"text",sorterFn:function(b,c){if(!b.get("value")){return -1}return parseInt(b.get("value"))-parseInt(c.get("value"))}}]});return{xtype:"combo",name:"class_name",fieldLabel:"班级",displayAll:true,store:a,value:"",listConfig:{minWidth:40},queryMode:"local",displayField:"text",valueField:"value",editable:false,labelWidth:40,width:95}},jieci:function(){var a=new Ext.data.Store({fields:["sequence","uuid"],data:[{sequence:"所有"}],sorters:[{property:"sequence",direction:"ASC"}],proxy:{type:"ajax",url:"/list/get-lesson-period/",reader:{type:"json",root:"data.lesson_period"}},pageSize:1000,listeners:{beforeload:bbt.beforeCascadeLoad,load:function(c,b){var d=c.getAt(0);if(!d||(d&&d.get("sequence")!="所有")){c.insert(0,{sequence:"所有"})}if(c.expandOnLoad){c.owner.expand();dv=c.defaultValueOnLoad;if(c.owner.findRecordByValue(dv)){c.owner.setValue(dv)}delete c.expandOnLoad;delete c.defaultValueOnLoad}}}});return{xtype:"combo",name:"lesson_period",fieldLabel:"节次",store:a,skipAutoValue:true,listConfig:{minWidth:40},queryMode:"local",displayField:"sequence",valueField:"uuid",submitField:"sequence",editable:false,labelWidth:40,width:100,value:"",listeners:{beforerender:function(){this.store.owner=this},expand:function(){var b=this.lastLoadConditions,c=false,d=this.ownerCt.ownerCt;if(bbt.UserInfo.isSchool()){if(typeof b=="undefined"){b=this.lastLoadConditions={};c=true}Ext.each(["school_year","term_type","start_date","end_date"],function(f){var g=d.down("[name="+f+"]"),e;if(g){e=g.getValue();if(Ext.isDate(e)){e=Ext.Date.format(e,"Y-m-d")}if(e!==b[f]){b[f]=e;c=true}}});if(c){this.store.expandOnLoad=true;this.store.defaultValueOnLoad=this.getValue();this.store.load()}}}}}},jieciOld:function(){var a=new Ext.data.Store({fields:["sequence"],data:[{sequence:"所有"}],sorters:[{property:"sequence",direction:"ASC"}],proxy:{type:"ajax",url:"/system/lesson-period/list-sequence/",reader:{type:"json",root:"data.records"}},pageSize:1000,listeners:{load:function(c,b){c.insert(0,{sequence:"所有"})}}});a.load();return{xtype:"combo",name:"lesson_period",fieldLabel:"节次",store:a,skipAutoValue:true,listConfig:{minWidth:40},queryMode:"local",displayField:"sequence",valueField:"sequence",editable:false,labelWidth:40,width:100,value:"",listeners:{}}},qdate:{xtype:"combo",fieldLabel:"时间范围",editable:false,labelWidth:60,name:"_",width:140,store:[["7","近一周"],["1m","近一个月"],["3m","近三个月"],["custom","自定义"]],listeners:{change:function(e,b){var d,c,f,a;f=e.up("toolbar").down("datefield[name=start_date]");a=e.up("toolbar").down("datefield[name=end_date]");if(b===""){f.setDisabled(true);f.setValue("");a.setDisabled(true);a.setValue("")}else{if(b=="custom"){f.setDisabled(false);a.setDisabled(false)}else{if(/^\d+m?$/.test(b)){f.setDisabled(true);a.setDisabled(true);a.setValue(new Date());d=new Date();c=parseInt(b);if(b.indexOf("m")==-1){d.setDate(d.getDate()-c)}else{d.setMonth(d.getMonth()-c)}f.setValue(d)}}}},afterrender:function(){var a=this;setTimeout(function(){a.setValue("7")},10)}}},startDate:{xtype:"datefield",name:"start_date",fieldLabel:"开始",editable:false,format:"Y-m-d",labelWidth:40,disabled:true,width:140,validator:function(){var d=this,b=d.getValue(),a,c;a=d.up("toolbar").down("datefield[name=end_date]");c=a.getValue();if(!b&&!c){d.allowBlank=true;a.allowBlank=true;return true}if(c){if(b>c){return"开始时间不能大于结束时间！"}else{a.validate()}}else{a.allowBlank=false;a.expand()}return true}},endDate:{xtype:"datefield",name:"end_date",fieldLabel:"结束",editable:false,format:"Y-m-d",labelWidth:40,disabled:true,width:140,validator:function(){var c=this,b=c.getValue(),d,a;d=c.up("toolbar").down("datefield[name=start_date]");a=d.getValue();if(!a&&!b){c.allowBlank=true;d.allowBlank=true;return true}if(a){if(a>b){return"开始时间不能大于结束时间！"}}else{d.allowBlank=false;d.expand()}return true}},queryMethod:{xtype:"combo",name:"_",fieldLabel:"查询方式",queryMode:"local",store:[["","按学年学期"],["natural","按自然时间"]],editable:false,labelWidth:60,width:160,defaultValue:"",listeners:{afterrender:function(){this.setValue(this.defaultValue)},change:function(e,c){var a,d,f,b;a=e.up("toolbar").down("combo[name=school_year]");d=e.up("toolbar").down("combo[name=term_type]");f=e.up("toolbar").down("datefield[name=start_date]");b=e.up("toolbar").down("datefield[name=end_date]");if(c=="natural"){a.setDisabled(true);a.setValue("");d.setDisabled(true);d.setValue("");f.setDisabled(false);b.setDisabled(false)}else{a.setDisabled(false);a.setValue("");d.setDisabled(false);d.setValue("");f.setDisabled(true);f.setValue(undefined);b.setDisabled(true);b.setValue(undefined);e.store.loading=true;bbt.loadCurrentSchoolYear(function(h,g,j){var i=Ext.decode(j.responseText);if(i.status=="success"){a.setValue(i.data.school_year);d.setValue(i.data.term_type)}e.store.loading=false})}}}},queryMethodEx:{xtype:"combo",name:"_",fieldLabel:"查询方式",queryMode:"local",store:[["7","近一周"],["1m","近一个月"],["3m","近三个月"],["natural","按自然时间"],["term","按学年学期"]],editable:false,defaultValue:"7",labelWidth:60,width:160,listeners:{afterrender:function(){this.setValue(this.defaultValue)},change:function(g,j){var d,c,f,e,h,b,a,i;d=g.up("toolbar").down("combo[name=school_year]");c=g.up("toolbar").down("combo[name=term_type]");f=g.up("toolbar").down("datefield[name=start_date]");e=g.up("toolbar").down("datefield[name=end_date]");if(j=="term"){d.setDisabled(false);d.setValue("");c.setDisabled(false);c.setValue("");f.setDisabled(true);f.setValue(undefined);e.setDisabled(true);e.setValue(undefined);g.store.loading=true;bbt.loadCurrentSchoolYear(function(l,k,n){var m=Ext.decode(n.responseText);if(m.status=="success"){d.setValue(m.data.school_year);c.setValue(m.data.term_type)}g.store.loading=false})}else{d.setDisabled(true);d.setValue("");c.setDisabled(true);c.setValue("");f.setDisabled(true);e.setDisabled(true);h=/^(\d+)m$/;if(j=="7"){b=new Date();b.setDate(b.getDate()-7);a=new Date()}else{if(h.test(j)){i=h.exec(j)[1];b=new Date();b.setMonth(b.getMonth()-i);a=new Date()}else{f.setDisabled(false);e.setDisabled(false)}}if(b&&a){f.setValue(b);e.setValue(a);e.collapse()}}}}},schoolYear:function(){var a=new Ext.data.Store({fields:["school_year","terms","start_date","end_date"],pageSize:100,listeners:{beforeload:function(c,b){Ext.Ajax.request({url:bbt.UserInfo.isSchool()?"/system/term/list/":"/system/newterm/list/",callback:function(g,f,h){var e=Ext.decode(h.responseText),d={};if(e.status=="success"){Ext.each(e.data.records,function(i){if(!(i.school_year in d)){i.terms=[{text:i.term_type,start_date:i.start_date,end_date:i.end_date}];delete i.term_type;d[i.school_year]=i}else{d[i.school_year].terms.push({text:i.term_type,start_date:i.start_date,end_date:i.end_date})}});c.loadData(Ext.Object.getValues(d))}}});return false}}});a.load();return{xtype:"combo",name:"school_year",fieldLabel:"学年",store:a,queryMode:"local",displayField:"school_year",valueField:"school_year",editable:false,labelWidth:40,width:130,listeners:{change:function(e,b){var f=e.findRecordByValue(b),d,c;if(f){d=e.ownerCt.down("[name=term_type]");if(!d){return}c=d.getValue();d.store.loadData(f.get("terms"));if(d.findRecordByValue(c)){d.setValue(c)}else{d.setValue(f.get("terms")[0].text)}if(d.getValue()==c){d.fireEvent("change",d,c)}}}}}},iTeacherName:{xtype:"textfield",name:"teacher_name",labelWidth:60,fieldLabel:"授课教师",qtip:"输入教师姓名",maxLength:100,width:160,listeners:{boxready:function(){bbt.utils.makeTipFor(this.qtip,this.getInputId())}}},teacherName:function(){var a=new Ext.data.Store({fields:["text","value","name","uuid","birthday"],proxy:{type:"ajax",url:"/system/teacher/list/",reader:{type:"json",root:"data.records",totalProperty:"data.record_count"}},pageSize:1000,listeners:{load:function(c,b){c.each(function(d){d.data.text=d.data.value=d.get("name")});c.insert(0,{text:"所有",value:""})}}});a.load();return{xtype:"combo",name:"teacher_name",fieldLabel:"授课教师",labelWidth:60,width:160,hideTrigger:true,store:a,displayField:"text",valueField:"value",value:"",queryMode:"local",typeAhead:true,validator:function(){var b=this.getValue();return this.findRecordByValue(b)?true:"请选择教师"},listeners:{boxready:function(){var b=this;Ext.create("Ext.tip.ToolTip",{target:b.getInputId(),html:"输入教师名字可以快速选择哦"})}}}},assetReportType:{xtype:"combo",name:"log_type",fieldLabel:"申报类型",labelWidth:60,width:120,queryModel:"local",value:"",editable:false,store:[["","所有"],["新增","新增"],["停用","停用"]]},assetname:{xtype:"textfield",name:"name",fieldLabel:"资产名称",labelWidth:60,emptyText:"请输入资产名称",width:160},report_user:{xtype:"textfield",name:"reported_by",fieldLabel:"申报用户",maxLength:20,labelWidth:60,qtip:"输入申报用户",width:160,listeners:{boxready:function(){Ext.create("Ext.tip.ToolTip",{target:this.getInputId(),html:this.qtip})}}},course:function(){var a=new Ext.data.Store({fields:["name"],data:[{name:"所有"}],proxy:{type:"ajax",url:"/list/get-lesson-name/",reader:{type:"json",root:"data.lesson_name"}},pageSize:1000,listeners:{beforeload:bbt.beforeCascadeLoad,load:function(d,b){var e=d.getAt(0),c;if(!e||(e&&e.get("name")!="所有")){d.insert(0,{name:"所有"})}if(d.expandOnLoad){d.owner.expand();c=d.defaultValueOnLoad;if(d.owner.findRecordByValue(c)){d.owner.setValue(c)}delete d.expandOnLoad;delete d.defaultValueOnLoad}else{d.owner.setValue("所有")}}}});return{xtype:"combo",name:"lesson_name",fieldLabel:"课程",editable:false,skipAutoValue:true,labelWidth:40,width:135,displayField:"name",valueField:"name",submitField:"name",queryMode:"local",store:a,value:"所有",listeners:{beforerender:function(){this.store.owner=this},expand:function(){var b=this.lastLoadConditions,c=false,d=this.ownerCt.ownerCt;if(bbt.UserInfo.isSchool()){if(typeof b=="undefined"){b=this.lastLoadConditions={};c=true}Ext.each(["school_year","term_type","start_date","end_date"],function(f){var g=d.down("[name="+f+"]"),e;if(g){e=g.getValue();if(Ext.isDate(e)){e=Ext.Date.format(e,"Y-m-d")}if(e!==b[f]){b[f]=e;c=true}}});if(c){this.store.expandOnLoad=true;this.store.defaultValueOnLoad=this.getValue();this.store.load()}}}}}},courseOld:function(){var a=new Ext.data.Store({fields:["name"],proxy:{type:"ajax",url:"/system/lesson-name/list/",reader:{type:"json",root:"data.records"}},pageSize:1000,listeners:{load:function(d,b){var e=d.getAt(0),c;if(d.owner.displayAll){if(!e||(e&&e.get("name")!="所有")){d.insert(0,{name:"所有"})}d.owner.setValue("所有")}}}});return{xtype:"combo",name:"lesson_name",fieldLabel:"课程",editable:false,skipAutoValue:true,labelWidth:40,width:135,displayAll:true,displayField:"name",valueField:"name",submitField:"name",queryMode:"local",store:a,listeners:{afterrender:function(){this.store.owner=this;this.store.load()}}}},assetType:function(){var a=new Ext.data.Store({fields:["name","uuid"],proxy:{type:"ajax",url:"/asset/asset-type/",reader:{type:"json",root:"data.records"},extraParams:{distinct:true}},listeners:{load:function(c,b){var d=c.getAt(0);if(c.owner.displayAll){if(!d||(d&&d.get("name")!="所有")){c.insert(0,{name:"所有"})}c.owner.setValue("所有")}}}});return{xtype:"combo",name:"asset_type",editable:false,fieldLabel:"资产类型",labelWidth:60,width:160,queryModel:"local",store:a,displayField:"name",valueField:"name",submitField:"name",displayAll:true,listeners:{afterrender:function(){this.store.owner=this;this.store.load()}}}},iDeviceModel:{xtype:"textfield",name:"device_model",fieldLabel:"设备型号",maxLength:100,labelWidth:60,width:160,qtip:"输入设备型号",listeners:{boxready:function(){Ext.create("Ext.tip.ToolTip",{target:this.getInputId(),html:this.qtip})}}},deviceModel:function(){var a=new Ext.data.Store({fields:["uuid","device_model"],proxy:{type:"ajax",url:"",reader:{type:"json",root:"data.records"},extraParams:{status:"在用"}}});return{xtype:"combo",name:"device_model",fieldLabel:"设备型号",labelWidth:60,editable:false,hideTrigger:true,width:160,queryMode:"local",displayField:"device_model",valueField:"device_model",store:a}},remark:{xtype:"textfield",name:"remark",fieldLabel:"备注",labelWidth:40,maxLength:180,qtip:"输入备注",width:160,listeners:{boxready:function(){Ext.create("Ext.tip.ToolTip",{target:this.getInputId(),html:this.qtip})}}},assetStatus:{xtype:"combo",name:"status",fieldLabel:"资产状态",editable:false,labelWidth:60,width:125,queryModel:"local",value:"在用",store:[["","所有"],["在用","在用"],["停用","停用"]],queryMode:"local"},year:function(){var d=new Date().getFullYear(),c=[{text:"所有",value:""}],a=-2,b;while(a++<10){c.push({text:d-a,value:d-a})}b=new Ext.data.Store({fields:["text","value"],data:c});return{xtype:"combo",name:"year",fieldLabel:"年份",labelWidth:40,width:105,queryModel:"local",editable:false,displayField:"text",valueField:"value",value:"",listeners:{change:function(f,e){var g=f.up("toolbar").down("combo[name=month]");if(g){if(e){g.isDisabled()?g.setDisabled(false):""}else{g.setDisabled(true);g.setValue(undefined)}}}},store:b}},month:function(){var a=1,b=[["","所有"]];for(;a<=12;a++){b.push([a+"",a+"月份"])}return{xtype:"combo",name:"month",fieldLabel:"月份",labelWidth:40,editable:false,disabled:true,width:140,queryMode:"local",value:"",multiSelect:true,store:b,listeners:{change:function(h,e){var d=h.up("toolbar").down("combo[name=day]"),c,j,f=1,k,g;if(!d){return}c=d.store;j=c.getAt(c.count()-1).get(h.valueField)*1;if(e in {"1":"","3":"","5":"","7":"","8":"","10":"","12":""}){if(j<31){for(;f<j;f++){c.add({text:""+f,value:""+f})}}}else{if(e in {"4":"","6":"","9":"","11":""}){if(j===31){c.remove(c.getAt(c.count()-1))}else{if(j<30){for(;f<j;f++){c.add({text:""+f,value:""+f})}}}}else{if(e=="2"){k=new Date().getFullYear();g=(k/4===0&&k/100!==0||k/400===0)?29:28;if(g<j){f=j;for(;f!=g;f--){c.remove(c.getAt(c.count()-1))}}else{if(g>j){for(;f<j;f++){c.add({text:""+f,value:""+f})}}}}}}}}}},edubg:{xtype:"combo",name:"edu_background",editable:false,fieldLabel:"学历",labelWidth:40,width:120,value:"",store:[["","所有"],["大专","大专"],["本科","本科"],["硕士","硕士"],["博士","博士"],["其他","其他"]]},sex:{xtype:"combo",name:"sex",fieldLabel:"性别",labelWidth:40,width:120,editable:false,value:"",store:[["","所有"],["男","男"],["女","女"]]},ttitle:{xtype:"combo",name:"title",fieldLabel:"教师职称",labelWidth:60,width:140,value:"",editable:false,store:[["","所有"],["正高级","正高级"],["高级","高级"],["一级","一级"],["二级","二级"],["三级","三级"]]},tstatus:{xtype:"combo",name:"status",fieldLabel:"状态",labelWidth:40,width:120,editable:false,value:"",store:[["","所有"],["授课","授课"],["停课","停课"]]},faketb:{xtype:"tbtext",cls:"icon-toolbar",width:10,height:20,style:{marginLeft:"10px",marginTop:"-1px",marginBottom:"-1px"}},day:{xtype:"combo",name:"day",fieldLabel:"日",labelWidth:25,width:105,queryMode:"local",store:new Ext.data.Store({fields:["text","value"]}),displayField:"text",valueField:"value"},term:function(){return{xtype:"combo",fieldLabel:"学期",labelWidth:40,width:120,name:"term_type",editable:false,value:"",displayField:"text",valueField:"text",queryMode:"local",store:new Ext.data.Store({fields:["text","start_date","end_date"]})}},query:{xtype:"button",text:"查询",iconCls:"icon-query",action:"query",handler:function(){var d=this,c=this.up("toolbar[dock=top]"),b=[],f={},a,g,e=true;a=c.ownerCt;Ext.each(a.query("toolbar[dock=top]"),function(h){var i=h.query("field[name]");b=b.concat(i)});Ext.each(b,function(j){var h=j.getValue(),i;if(j.submitField){i=j.findRecordByValue(h);if(i){h=i.get(j.submitField)}}if(j.name=="_"){return}if(j.isValid()){if(Ext.isDate(h)){h=Ext.Date.format(h,j.format)}f[j.name]=h=="所有"?"":h}else{e=false;Ext.Msg.alert("提示",j.getActiveError(),function(){switch(j.xtype){case"combo":case"datefield":j.expand();break;case"textfield":j.focus()}});return false}});if(!e){return}if(a.store){a.store.currentPage=1;if(!a.store.proxy.extraParams){a.store.proxy.extraParams={}}Ext.apply(a.store.proxy.extraParams,f);a.store.load()}}},viewReport:{xtype:"button",text:"报表显示",handler:function(){var b=this.up("grid");if(!b){return}var d=b.chart,a;if(!d){Ext.Msg.alert("提示","报表不可用！");return}a={title:d.title,autoShow:true,width:800,height:480,modal:true,layout:"fit",items:[{xtype:"chart",style:{backgroundColor:"#FFF"},shadow:true,theme:"bbt",legend:{position:"right",update:false},store:b.store,axes:[{type:"Numeric",position:"left",fields:d.y.push?d.y:[d.y],title:d.ytitle,grid:true,minimum:0,maximum:10,adjustMaximumByMajorUnit:1},{type:"Category",position:"bottom",fields:d.x.push?d.x:[d.x],title:d.xtitle,label:{color:"#000",rotate:{degrees:300}}}],series:[{type:"column",axis:"left",gutter:80,showInLegend:true,highlight:true,style:{width:35},title:d.seriesTitle,xField:d.x,yField:d.y,label:{display:"outside",color:"#000",field:d.y}}],listeners:{beforerender:function(){var f=this.store,g=this.axes.getAt(0),e=g.fields,c=0;f.each(function(l){var k,h,j;for(k=0,h=e.length;k<h;k++){j=l.get(e[k])||0;c=c>j?c:j}});c=c<10?10:c;this.series.getAt(0);g.maximum=c},afterrender:function(){var c=this.legend.items;setTimeout(function(){Ext.each(c,function(e){e.un("mousedown",e.events.mousedown.listeners[0].fn)})})}}}],listeners:{afterrender:function(){var e=this,c=function(){e.center()};Ext.get(window).on("resize",c);e.on("beforedestroy",function(){Ext.get(window).un("resize",c)})}}};Ext.create("Ext.window.Window",a)}},"export":{text:"导出",iconCls:"icon-export",handler:function(){var a=this.up("grid"),b;if(!a.exportUrl){alert("没有配置导出 url");return}if(a){b=a.store.lastOptions.params||a.store.proxy.extraParams}Ext.Ajax.request({url:a.exportUrl,params:b,timeout:60*1000,success:function(f){var c;try{c=Ext.decode(f.responseText);if(c.status=="success"){downloadFile(c.url,"")}else{Ext.Msg.alert("提示",c.msg)}}catch(d){c=c||{};Ext.Msg.alert("提示",c.msg||"服务器错误！")}},failure:function(f){var c;try{c=Ext.decode(f.responseText);Ext.Msg.alert("提示",getErrorMsg(c))}catch(d){}}})}},assetFrom:{xtype:"combo",fieldLabel:"资产来源",editable:false,value:"",store:[["","所有"],["校自主采购","校自主采购"],["县级电教采购","县级电教采购"],["地级电教采购","地级电教采购"],["省级电教采购","省级电教采购"],["其他","其他"]],name:"asset_from",labelWidth:60,width:160},asset_repair:{text:"资产报修",handler:function(){var f,a,e,g,d,b,c;a=bbt.ToolBox.get("assetType",{displayAll:false});a.store.proxy.url="/asset/asset-type/get-assettype-for-repair/";a.valueField="uuid";delete a.labelWidth;Ext.merge(a,{listeners:{change:function(k,i){var l=k.findRecordByValue(i),j,h;j="/asset/get-devicemodel-by-assettype/?uuid="+l.raw.uuid;h=k.ownerCt.down("[name=device_model]");h.store.proxy.url=j;h.setValue("");h.store.load()}}});e=bbt.ToolBox.get("deviceModel");e.editable=false;delete e.hideTrigger;Ext.merge(e,{listeners:{change:function(i,h){var j=i.findRecordByValue(h);if(j){i.up("form").getForm().findField("asset").setValue(j.raw.uuid)}}}});delete e.labelWidth;g=bbt.ToolBox.get("gradeOld",{displayAll:false});delete g.labelWidth;d=bbt.ToolBox.get("classOld",{displayAll:false});delete d.labelWidth;d.store.removeAll();f={title:"资产报修",modal:true,width:400,closable:false,layout:"fit",items:[{xtype:"form",margin:30,border:false,bodyCls:"no-bg",defaultType:"combo",layout:"anchor",defaults:{anchor:"100%",allowBlank:false},items:[a,e,g,d,,{xtype:"textarea",fieldLabel:"备注",allowBlank:true,name:"remark"},{xtype:"hidden",name:"asset"}]}],buttons:[{text:"报修",handler:function(){var i=this.up("window"),h=i.down("form"),j;j=checkForm(h);if(j!==true){return}h.getForm().submit({url:"/asset/asset-repair/add/",success:function(k,l){c.store.add(l.result.data);i.destroy()},failure:function(l,k){Ext.Msg.alert("提示",getErrorMsg(k.result))}})}},{text:"关闭",handler:function(h){h.up("window").destroy()}}],buttonAlign:"right"};new Ext.window.Window(f).show();c=this.up("grid")}},assetPos:{xtype:"textfield",name:"asset_pos",fieldLabel:"所属位置",labelWidth:60,width:160,qtip:"请输入资产所在的年级班级",listeners:{boxready:function(){Ext.create("Ext.tip.ToolTip",{target:this.getInputId(),html:this.qtip})}}}});Ext.define("bbt.ManageGrid",{extend:"Ext.grid.Panel",alias:"widget.mgrgridbase",initComponent:function(){var a={sortable:false,menuDisabled:true,draggable:false};Ext.each(this.columns,function(b){Ext.applyIf(b,a)});if(this.showOperateColumn){if(this.columns[this.columns.length-1].text!="操作"){this.columns.push({text:"操作",sortable:false,menuDisabled:true,draggable:false,dataIndex:"_",flex:1,editRenderer:function(){return""},renderer:this.operateRenderer?this.operateRenderer():this.getOperateFn()})}}this.store=new Ext.data.Store({fields:this.fields,proxy:this.proxy||{type:"ajax",url:this.listUrl,reader:{type:"json",root:"data.records",totalProperty:"data.record_count"},startParam:undefined,sortParam:"order_field",directionParam:"order_direction",simpleSortMode:true},pageSize:this.pageSize,sorters:this.sorters});if(typeof this.tbar!="undefined"){this.tbar=bbt.ToolBox.convert(this.tbar)}if(this.pagination){this.bbar={xtype:"pagingtoolbar",displayInfo:true,store:this.store}}this.callParent();this.on("afterrender",function(){var c=this,b;if(this.actionMap){b=this.down("toolbar[dock=top]");b&&Ext.Object.each(this.actionMap,function(e,d){btn=b.down("[action="+e+"]");if(btn){btn.setHandler(c[d],c)}})}});this.on("itemclick",function(b,h,g,d,j){var c=Ext.get(j.target),f;if(c.is("[action]")){f=c.getAttribute("action")||c.dom.getAttribute("action");this[this.actionMap[f]](b,h,g,d,j)}});this.fireEvent("show",this)},listUrl:null,addUrl:null,removeUrl:null,updateUrl:null,operates:null,actionMap:null,showOperateColumn:true,checkPrivilegeOnAction:false,alertOnFailure:true,pagination:false,request:function(c,g,b){var f=this,e,a,d;b=b||{};b.method=b.method||"POST";if(typeof g=="function"){b.success=g;g={}}if(g.form){e=g.form;delete g.form}a={url:c,params:g};if(e){e=e.getForm();a.success=function(h,i){b.maskId&&f.destroyMask(b.maskId);b.success&&b.success(i.result)};a.failure=function(h,i){b.maskId&&f.destroyMask(b.maskId);if(b.alertOnFailure!==false){Ext.Msg.alert("提示",getErrorMsg(i.result))}else{b.failure&&b.failure(i.result)}};e.submit(a)}else{a.timeout=30*60*1000;a.method=b.method;a.callback=function(h,i,l){var j;try{j=Ext.decode(l.responseText);if(j.status=="success"){b.success&&b.success(j.data,j)}else{if(b.alertOnFailure!==false){Ext.Msg.alert("提示",j.msg)}else{b.failure&&b.failure(j)}}}catch(k){if(typeof j=="undefined"){Ext.Msg.alert("提示","失败！")}}finally{b.maskId&&f.destroyMask(b.maskId);b.callback&&b.callback(j)}};Ext.Ajax.request(a)}},load:function(){this.store.load()},createMask:function(c,d){var b=new Ext.LoadMask(c||this,{msg:d}),a=new Date().getTime()+""+Math.random();if(!this._loadmask){this._loadmask={}}this._loadmask[a]=b;b.show();return a},destroyMask:function(a){var b;if(typeof a=="string"){b=this._loadmask[a]}b&&b.hide();b.destroy&&b.destroy();delete this._loadmask[a]},getOperateFn:function(){var a=[];Ext.Object.each(this.operates,function(c,b){a.push('<a href="javascript:void(0);" action="'+c+'">'+b+"</a>")});a=a.join(" ");return function(){return a}},checkForm:function(a){var b=true,c;if(a.is&&a.is("form")){a=a.getForm()}a.getFields().each(function(d){if(!d.isValid()){c=d.getFieldLabel()+"："+d.getActiveError();b=false;return false}});return c||b}});if(bbt.UserInfo.isSchool()){Ext.define("bbt.GradeClass",{extend:"bbt.ManageGrid",alias:"widget.gc",fields:["grade__name","name","classmacv2__mac","uuid","grade__term__school_year","grade__term__term_type","teacher__name","teacher__birthday"],importUrl:"/system/class/import/",addUrl:"/system/class/add/",updateUrl:"/system/class/edit/",removeUrl:"/system/class/delete/",listUrl:"/system/class/list/",bingMacUrl:"/system/class/clear_mac/",tbar:[{text:"添加班级",action:"add",iconCls:"icon-add"},{text:"编辑班级",action:"edit",iconCls:"icon-edit"}],columns:[{text:"学年",dataIndex:"grade__term__school_year"},{text:"学期类型",dataIndex:"grade__term__term_type"},{text:"年级",dataIndex:"grade__name",width:120,regex:/^[1-9]\d+$/,regexText:"无效的数字",renderer:function(a){return a?a+"年级":""}},{text:"班级",dataIndex:"name",width:120,renderer:function(a){return a?a+"班":""},regex:/^[1-9]\d+$/,regexText:"无效的数字"},{text:"本学期班主任",dataIndex:"teacher__name"},{text:"出生年月",dataIndex:"teacher__birthday"},{text:"MAC地址绑定",width:240,dataIndex:"classmacv2__mac",renderer:function(a){if(a){return a+' <a action="clear_mac" href="javascript:void(0);">清除绑定</a>'}else{return""}}}],pagination:true,showOperateColumn:true,operates:{remove:"删除"},actionMap:{add:"addGradeClass",edit:"editGradeClass",remove:"removeGradeClass",clear_mac:"onClearMac"},listeners:{edit:function(a,b){if(this.myAfterEdit){this.myAfterEdit();delete this.myAfterEdit}else{b.record.commit()}},show:function(){this.store.load()}},onClearMac:function(a,b){this.request("/system/class/clear_mac/",{uuid:b.get("uuid")},{maskId:this.createMask(this,"正在清除 MAC 地址绑定！"),success:function(){b.set("classmacv2__mac","");b.commit()}})},addGradeClass:function(){var a=Ext.create("Ext.window.Window",this.getGradeClassWindowConfig());a.down("[action=submit]").setHandler(function(e){var g=this,f=a.down("form"),h,d,c;h=g.checkForm(f);if(h!==true){return}g.request(g.addUrl,{form:f},{maskId:g.createMask(a,"正在添加年级和班级……"),success:function(){g.store.reload();a.destroy()}})},this);a.show();this.hasSchoolYear(a)},editGradeClass:function(){var c=this,f,b,a,e,h,g;a=c.getSelectionModel().getSelection();if(a.length){e=a[0]}else{Ext.Msg.alert("提示","请先选中一行！");return}f=Ext.create("Ext.window.Window",this.getGradeClassWindowConfig("编辑班级"));f.down("[action=submit]").setHandler(function(j){var l=this,k=f.down("form"),m,i,d;m=l.checkForm(k);if(m!==true){return}l.request(l.updateUrl,{form:k,uuid:e.get("uuid")},{maskId:l.createMask(f,"正在编辑年级和班级……"),success:function(){l.store.reload();f.destroy()}})},this);f.show();f.down("[name=school_year]").setValue(e.get("grade__term__school_year")+" （"+e.get("grade__term__term_type")+"）");f.down("[name=grade_name]").setValue(e.get("grade__name")).setReadOnly(true);f.down("[name=teacher_name]")._value=e.get("teacher__name");f.down("[name=name]").setValue(e.get("name")).setReadOnly(true)},removeGradeClass:function(){var c=this,d,b,a;b=c.getSelectionModel().getSelection();if(!b.length){Ext.Msg.alert("提示","请先选择年级和班级！");return}d=b[0];passCB=function(){c.request(c.removeUrl,{uuid:d.get("uuid")},{success:function(){c.store.reload()},maskId:c.createMask(c,"正在删除班级")})};Ext.Msg.confirm("提示","删除班级将会影响班级课程表，班级课程授课教师等，确认要删除吗？",function(e){e=="yes"&&new bbt.DangerOperate({onPass:passCB}).show()})},hasSchoolYear:function(a){bbt.loadCurrentSchoolYear(function(c,b,e){var d=Ext.decode(e.responseText);if(d.status=="success"){a.down("displayfield").setValue(d.data.school_year+" （"+d.data.term_type+"）")}else{Ext.Msg.alert("提示","当前没有学年学期!",function(){a.destroy()})}})},askNext:function(c,b,a){Ext.widget("window",{title:"提示",width:250,modal:true,height:140,closable:false,items:[{bodyCls:"no-bg",html:c+"\n要继续添加吗？",border:false,margin:30}],buttons:[{text:"继续添加 >>",handler:function(){b&&b();this.up("window").destroy()}},{text:"不了，谢谢",handler:function(){a&&a();this.up("window").destroy()}}],buttonAlign:"center"}).show()},getGradeClassWindowConfig:function(c){var b,a;bbt.loadClasses(function(d){b=d});a={xtype:"window",modal:true,title:c||"添加班级",width:350,closable:false,items:[{xtype:"form",margin:20,bodyCls:"no-bg",border:false,layout:"anchor",defaults:{anchor:"100%",allowBlank:false,margin:"15 0 0 0"},items:[{xtype:"displayfield",name:"school_year",value:"",fieldLabel:"学年学期"},{xtype:"combo",name:"grade_name",fieldLabel:"年级",editable:false,store:Ext.Array.map(["一","二","三","四","五","六","七","八","九","十","十一","十二"],function(d){return[d,bbt.fullgrade(d)]}),listeners:{change:function(e,d){var g=e.up("form").down("[name=name]"),f=false;if(b){Ext.each(b,function(i){var h;if(i.text===d){h=Ext.Array.pluck(i.sub,"text");Ext.each(h,function(k,l,j){j[l]=parseInt(k)});g.setValue(Ext.Array.max(h)+1);f=true;return false}});if(!f){g.setValue("1")}}}}},{xtype:"textfield",margin:"15 0 20 0",name:"name",fieldLabel:"班级",readOnly:true},bbt.ToolBox.get("teacherName",{fieldLabel:"班主任",labelWidth:100,hideTrigger:false,listeners:{afterrender:function(){this.store.on("load",function(d){var e=d.getAt(0);if(e.data.value===""){d.remove(e)}this._value&&this.setValue(this._value)},this);this.store.fireEvent("load",this.store)},change:function(e,d){var h=e.ownerCt.down("combo[name=birthday]"),g,f=[];g=e.store.query("text",d);g.each(function(i){f.push({text:i.get("birthday"),value:i.get("birthday")})});if(f.length){h.store.loadData(f);h.setValue(f[0].text);h.setDisabled((f.length===1))}},blur:function(){var d=this.getValue();if(!this.findRecordByDisplay(d)){this.setValue("")}}}}),{xtype:"combo",name:"birthday",disabled:true,displayfield:"text",valueField:"value",queryMode:"local",fieldLabel:"出生年月",labelWidth:100,store:new Ext.data.Store({fields:["text","value"]})}]}],buttons:[{text:"确定",action:"submit"},{text:"关闭",handler:function(){this.up("window").destroy()}}],buttonAlign:"right"};return a}});Ext.define("bbt.Worktime",{extend:"bbt.ManageGrid",alias:"widget.worktime",fields:["sequence","start_time","end_time","uuid","term__school_year","term__term_type"],pagination:true,columns:[{text:"学年",dataIndex:"term__school_year"},{text:"学期类型",dataIndex:"term__term_type"},{text:"节次",dataIndex:"sequence",width:50,editor:{xtype:"textfield",regex:/^\d+$/,regexText:"无效的数字"}},{text:"开始时间",dataIndex:"start_time",width:150,editor:{xtype:"timefield",format:"H:i"},renderer:function(a){if(Ext.isDate(a)){return Ext.Date.format(a,"H:i")}else{return a}}},{text:"结束时间",dataIndex:"end_time",editor:{xtype:"timefield",format:"H:i"},renderer:function(a){if(Ext.isDate(a)){return Ext.Date.format(a,"H:i")}else{return a}}}],tbar:[{text:"添加节次",action:"add",iconCls:"icon-add"},{text:"编辑节次",action:"edit",iconCls:"icon-edit"},{text:"删除",action:"remove",iconCls:"icon-delete"}],listUrl:"/system/lesson_period/list/",addUrl:"/system/lesson_period/add/",updateUrl:"/system/lesson_period/edit/",removeUrl:"/system/lesson_period/delete/",importUrl:"/system/lesson_period/import/",actionMap:{add:"addJieci",edit:"editJieci",remove:"removeJieci"},showOperateColumn:false,listeners:{show:function(){this.store.load()}},addJieci:function(){var e=this,f=new Ext.window.Window(Ext.apply(this.getJieciWindowConfig(),{title:"添加节次",buttons:[{text:"添加",handler:function(){var h=this.up("window"),d=h.down("form"),i;i=e.checkForm(d);if(i!==true){return}e.request(e.addUrl,{form:d},{maskId:e.createMask(h,"正在添加节次……"),success:function(){e.store.reload();h.destroy()},failure:function(j){Ext.Msg.alert("提示",getErrorMsg(j))}})}},{text:"关闭",margin:"0 30 0 20",handler:function(){this.up("window").destroy()}}]})),b,c,g=new Date(),a;b=e.store.proxy.reader.rawData.data.max_sequence+1;c=e.store.getAt(b-2);f.down("textfield[name=sequence]").setValue(b||1);if(c){a=c.get("end_time").split(":");g.setHours(parseInt(a[0]));g.setMinutes(parseInt(a[1]));f.down("timefield[name=start_time]").setMinValue(g);f.down("timefield[name=end_time]").setMinValue(g)}f.show();e.hasSchoolYear(f)},editJieci:function(){var c=this,e,b,a,h,g,f;a=c.getSelectionModel().getSelection();if(a.length){h=a[0]}else{Ext.Msg.alert("提示","请先选中一行！");return}e=new Ext.window.Window(Ext.apply(this.getJieciWindowConfig(),{title:"编辑节次",buttons:[{text:"保存",handler:function(){var i=this.up("window"),d=i.down("form"),j;j=c.checkForm(d);if(j!==true){return}c.request(c.updateUrl,{uuid:h.get("uuid"),form:d},{maskId:c.createMask(i,"正在更新节次……"),success:function(){c.store.load();i.destroy()}})}},{text:"关闭",margin:"0 30 0 20",handler:function(){this.up("window").destroy()}}]}));b=e.down("form").getForm();b.findField("sequence").setValue(h.get("sequence"));g=new Date();f=h.get("start_time").split(":");g.setHours(parseInt(f[0]));g.setMinutes(parseInt(f[1]));b.findField("start_time").setValue(g);g=new Date();f=h.get("end_time").split(":");g.setHours(parseInt(f[0]));g.setMinutes(parseInt(f[1]));b.findField("end_time").setValue(g);b.findField("school_year").setValue(h.get("term__school_year")+" （"+h.get("term__term_type")+"）");e.show()},removeJieci:function(){var b=this,c,a;c=b.getSelectionModel().getSelection();if(c.length){c=c[0];a=b.store.indexOf(c)}else{Ext.Msg.alert("提示","请先选中一行！");return}passCB=function(){b.request(b.removeUrl,{uuid:c.get("uuid")},{maskId:b.createMask(b,"正在删除节次……"),success:function(){b.store.reload()}})};Ext.Msg.confirm("提示","删除作息时间将会影响班级课程表，班级课程授课教师等，确认要删除吗？",function(d){d=="yes"&&new bbt.DangerOperate({onPass:passCB}).show()})},hasSchoolYear:function(a){bbt.loadCurrentSchoolYear(function(c,b,e){var d=Ext.decode(e.responseText);if(d.status=="success"){a.down("displayfield").setValue(d.data.school_year+" （"+d.data.term_type+"）")}else{Ext.Msg.alert("提示","当前没有学年学期!",function(){a.destroy()})}})},getJieciWindowConfig:function(){var a,b;b=new Ext.data.Store({autoLoad:true,fields:["school_year"],proxy:{type:"ajax",url:"/system/term/list_school_year/",reader:{type:"json",root:"data.records"}}});a={xtype:"window",modal:true,closable:false,resizable:false,width:350,layout:"fit",items:[{xtype:"form",bodyCls:"no-bg",layout:"anchor",margin:30,border:false,defaults:{allowBlank:false,anchor:"100%"},items:[{xtype:"displayfield",name:"school_year",fieldLabel:"学年学期",value:""},{xtype:"textfield",name:"sequence",fieldLabel:"节次",regex:/^\d+$/,regexText:"无效的数字",readOnly:true},{xtype:"timefield",fieldLabel:"开始时间",format:"H:i",name:"start_time"},{xtype:"timefield",fieldLabel:"结束时间",format:"H:i",name:"end_time"}]}],buttonAlign:"right"};return a}});Ext.define("bbt.Teacher",{extend:"bbt.ManageGrid",alias:"widget.teacher",fields:["uuid","sequence","status_count","name","password","sex","edu_background","birthday","title","mobile","qq","remark","register_at","school"],pagination:true,columns:[{text:"ID",dataIndex:"sequence",width:50},{text:"姓名",dataIndex:"name"},{text:"性别",dataIndex:"sex",width:40,renderer:function(a){return{male:"男",female:"女"}[a]||a}},{text:"学历",dataIndex:"edu_background"},{text:"出生年月",dataIndex:"birthday",renderer:bbt.utils.strftime},{text:"教师职称",dataIndex:"title"},{text:"注册时间",dataIndex:"register_at",renderer:function(a){return a?a.substring(0,10):""}},{text:"移动电话",dataIndex:"mobile"},{text:"QQ",dataIndex:"qq"},{text:"状态",dataIndex:"status",width:50,renderer:function(b,a,c){return c.get("status_count")>0?"授课":"停课"}},{text:"备注",dataIndex:"remark",flex:1}],showOperateColumn:true,dockedItems:[{xtype:"toolbar",items:[{text:"添加",action:"add",iconCls:"icon-add"},{text:"删除",action:"remove",iconCls:"icon-delete"},{xtype:"form",bodyCls:"no-bg",border:false,items:[{xtype:"fileuploadfield",name:"excel",buttonOnly:true,margin:0,padding:0,buttonConfig:{text:"导入",iconCls:"icon-import"},listeners:{change:function(b,c){var a=b.up("teacher");if(!/\.xlsx?$/.test(c)){b.reset();return}b.up("form").submit({url:a.importUrl,success:function(e,d){b.reset();Ext.Msg.alert("提示","导入成功！");a.load()},failure:function(){b.reset()}})}}}]},"->",bbt.ToolBox.get("export"),{text:"教师 UKey 生产程序",iconCls:"icon-download",href:"/download/usbkey.zip"}]},{xtype:"toolbar",items:[bbt.ToolBox.get("iTeacherName"),bbt.ToolBox.get("sex"),bbt.ToolBox.get("edubg"),bbt.ToolBox.get("ttitle"),bbt.ToolBox.get("tstatus"),bbt.ToolBox.get("query")]}],operates:{edit:"编辑"},actionMap:{add:"addTeacher",edit:"editTeacher",remove:"removeTeacher"},listeners:{show:function(){this.store.load()}},listUrl:"/system/teacher/list/",addUrl:"/system/teacher/add/",updateUrl:"/system/teacher/edit/",removeUrl:"/system/teacher/delete/",exportUrl:"/system/teacher/export/",importUrl:"/system/teacher/import/",checkPassword:function(b,a,c){if(arguments.length===1){a="password",c="password_confirmation"}b.xtype==="form"&&(b=b.getForm());var e=b.findField(a).getValue();var d=b.findField(c).getValue();return e===d},addTeacher:function(){var c=this,b,d,a;b=Ext.apply(c.getTeacherWindowConfig(),{title:"添加教师信息",buttons:[{text:"确定",handler:function(e){var i=e.up("window"),g,h,k,j;g=i.down("form");k=c.checkForm(g);if(k!==true){return}h=Ext.Date.format(g.down("[name=birthday]").getValue(),"md");j={password:h,password_confirmation:h,form:g};c.request(c.addUrl,j,{form:g,maskId:c.createMask(i,"正在添加教师"),success:function(f){c.store.reload();i.destroy()}})}},{text:"关闭",margin:"0 10 0 20",handler:function(){this.up("window").destroy()}}]});d=Ext.create("Ext.window.Window",b);d.show()},editTeacher:function(){var e=this,c,h,i,a,d,b,g;a=e.getSelectionModel().getSelection();if(!a.length){Ext.Msg.alert("提示","请先选择用户！");return}i=a[0];c=Ext.apply(e.getTeacherWindowConfig(),{title:"编辑教师信息",buttons:[{text:"重置登录密码",handler:function(){this.up("window").down("form").setPassword=true}},"->",{text:"确定",handler:function(j){var m=j.up("window"),k,l,o,n={};k=m.down("form");o=checkForm(k);if(o!==true){return}if(k.setPassword===true){l=Ext.Date.format(k.down("[name=birthday]").getValue(),"md");n.password=l;n.password_confirmation=l}n.uuid=i.get("uuid");n.form=k;e.request(e.updateUrl,n,{form:k,maskId:e.createMask(m,"正在修改教师"),success:function(f){i.set(f.data);i.commit();Ext.Msg.alert("提示","修改成功！");m.destroy()},alertOnFailure:true})}},{text:"关闭",margin:"0 10 0 20",handler:function(){this.up("window").destroy()}}]});h=Ext.create("Ext.window.Window",c);d=h.down("form").getForm();d.setValues(i.data);d.findField("name").setReadOnly(true);h.show()},removeTeacher:function(){var b=this,d,c,a=b.getSelectionModel().getSelection();if(!a.length){Ext.Msg.alert("提示","未选择教师！");return}c=a[0];if(b.removeUrl){b.request(b.removeUrl,{uuid:c.get("uuid")},{maskId:b.createMask(this,"确定要删除教师 "+c.get("username")+" 吗？"),success:function(){b.store.reload()}})}else{b.store.remove(c)}},getTeacherWindowConfig:function(){var a={xtype:"window",closable:false,resizable:false,modal:true,width:475,items:[{xtype:"form",bodyCls:"no-bg",border:false,margin:10,layout:{type:"vbox",align:"stretch"},items:[{defaults:{layout:{type:"vbox",align:"stretch"},border:false,bodyCls:"no-bg",flex:1},layout:{type:"hbox",align:"stretch"},border:false,bodyCls:"no-bg",defaultType:"panel",items:[{defaultType:"textfield",defaults:{margin:"5 5 5 0",labelWidth:60},items:[{fieldLabel:"ID",allowBlank:true,readOnly:true,emptyText:"系统自动生成"},{xtype:"combo",queryMode:"local",editable:false,store:[["female","女"],["male","男"]],name:"sex",value:"male",fieldLabel:"性别",allowBlank:false},{xtype:"datefield",name:"birthday",format:"Y-m-d",editable:false,fieldLabel:"出生年月"},{xtype:"textfield",name:"mobile",fieldLabel:"移动电话",regex:/^1\d{10}$/,regexText:"无效的手机号码"}]},{defaultType:"textfield",defaults:{margin:"5 0 5 5",labelWidth:60},items:[{name:"name",fieldLabel:"姓名",allowBlank:false},{xtype:"combo",name:"edu_background",editable:false,fieldLabel:"学历",store:["大专","本科","硕士","博士","其他"],allowBlank:false},{xtype:"combo",fieldLabel:"教师职称",name:"title",editable:false,store:["正高级","高级","一级","二级","三级"]},{xtype:"textfield",name:"qq",fieldLabel:"QQ",regex:/^\d+$/,regexText:"无效的QQ号"}]}]},{margin:"5 0 0 0",xtype:"textarea",name:"remark",fieldLabel:"备注",labelWidth:60}]}],buttonAlign:"right"};return a}});Ext.define("bbt.TeachInfo",{extend:"bbt.ManageGrid",alias:"widget.teachinfo",fields:["uuid","class_uuid__grade__term__school_year","class_uuid__grade__term__term_type","class_uuid__grade__name","class_uuid__name","lesson_name__name","teacher__name","teacher__birthday","schedule_time","remain_time"],columns:[{text:"学年",dataIndex:"class_uuid__grade__term__school_year"},{text:"学期类型",dataIndex:"class_uuid__grade__term__term_type"},{text:"年级",dataIndex:"class_uuid__grade__name",renderer:function(a){return a?a+"年级":""}},{text:"班级",dataIndex:"class_uuid__name",renderer:function(a){return a?a+"班":""}},{text:"课程",dataIndex:"lesson_name__name"},{text:"授课教师",dataIndex:"teacher__name"},{text:"教师生日",dataIndex:"teacher__birthday"},{text:"计划课时",dataIndex:"schedule_time"}],pagination:true,tbar:["gradeOld","classOld","courseOld","iTeacherName","query",{text:"新增",action:"add",iconCls:"icon-add"},{xtype:"form",bodyCls:"no-bg",border:false,items:[{xtype:"fileuploadfield",name:"excel",buttonOnly:true,margin:0,padding:0,buttonConfig:{text:"导入",iconCls:"icon-import"},listeners:{change:function(c,d){var b=c.up("teachinfo"),a;if(!/\.xlsx?$/.test(d)){Ext.Msg.alert("提示","请选择 excel 文件！");c.reset();return}a=function(e){if(e!="yes"){return}c.up("form").submit({url:b.importUrl,success:function(g,f){c.reset();Ext.Msg.alert("提示","导入成功！");b.load()},failure:function(g,f){c.reset();Ext.Msg.alert("提示",getErrorMsg(f.result))}})};if(b.store.count()>0){Ext.Msg.confirm("提示","本次导入将会先清除原有信息后，再执行导入操作!",a)}else{a("yes")}}}}]},"->","export"],listeners:{show:function(){this.store.load()},afterrender:function(){bbt.autoFill(this)}},listUrl:"/system/lesson_teacher/list/",addUrl:"/system/lesson_teacher/add/",updateUrl:"/system/lesson_teacher/edit/",removeUrl:"/system/lesson_teacher/delete/",exportUrl:"/system/lesson_teacher/export/",importUrl:"/system/lesson_teacher/import/",showOperateColumn:true,operates:{remove:"删除",edit:"编辑"},actionMap:{add:"addTeachInfo",edit:"updateTeachInfo",remove:"removeTeachInfo"},addTeachInfo:function(){var a=this,b=new Ext.window.Window(Ext.apply(this.getTeachInfoWindowConfig(),{title:"添加班级课程授课老师信息",buttons:[{text:"添加",handler:function(){var f=this.up("window"),e=f.down("form"),g;e.down("[name=birthday]").setDisabled(true);g=a.checkForm(e);if(g!==true){return}a.request(a.addUrl,{form:e},{maskId:a.createMask(f,"正在添加……"),success:function(h){a.store.reload();f.destroy()}})}},{text:"关闭",handler:function(){this.up("window").destroy()}}]})),c,d;c=function(){var f={},e=b.down("[name=remain_time]");f.class_name=b.down("[name=class_name]").getValue();f.grade_name=b.down("[name=grade_name]").getValue();if(!(f.grade_name&&f.class_name)){return}Ext.Ajax.request({url:"/system/lesson_teacher/remain_time/",params:f,callback:function(h,g,j){var i=Ext.decode(j.responseText);if(i.status=="success"){e.setValue(i.data.remain_time)}}});d=null};b.down("[name=grade_name]").on("change",function(){if(d){clearTimeout(d)}d=setTimeout(c,10)});b.down("[name=class_name]").on("change",function(){if(d){clearTimeout(d)}d=setTimeout(c,10)});b.show();this.hasSchoolYear(b)},updateTeachInfo:function(){var f=this,a=f.getSelectionModel().getSelection(),h,g,e,b,d,c;if(a.length){h=a[0]}else{Ext.Msg.alert("提示","请先选中一行！");return}g=new Ext.window.Window(Ext.apply(this.getTeachInfoWindowConfig(),{title:"编辑班级课程授课老师信息",buttons:[{text:"保存",handler:function(){var k=this.up("window"),j=k.down("form"),l,i;l=f.checkForm(j);if(l!==true){return}i=j.down("[name=teacher]");i=i.findRecordByValue(i.getValue()).get("name");f.request(f.updateUrl,{uuid:h.get("uuid"),form:j},{maskId:f.createMask(k,"正在编辑……"),success:function(){h.set(j.getForm().getFieldValues());h.set("teacher__name",i);h.commit();k.destroy()}})}},{text:"关闭",handler:function(){this.up("window").destroy()}}]}));e=g.down("form").getForm();b={school_year:"class_uuid__grade__term__school_year",grade_name:"class_uuid__grade__name",class_name:"class_uuid__name",lesson_name:"lesson_name__name",teacher:"teacher__name"};e.findField("school_year").setValue(h.get("class_uuid__grade__term__school_year")+" （"+h.get("class_uuid__grade__term__term_type")+"）");c=e.findField("grade_name");c.suspendEvents(false);c.setValue(h.get("class_uuid__grade__name")).setDisabled(true);c=e.findField("class_name");c.suspendEvents(false);c.setValue(h.get("class_uuid__name")).setDisabled(true);e.findField("lesson_name").setValue(h.get("lesson_name__name")).setDisabled(true);e.findField("teacher").setValue(h.raw.teacher__uuid).setDisabled(true);e.findField("schedule_time").setValue(h.get("schedule_time"));e.findField("remain_time").setValue(h.get("remain_time"));g.show();d=e.findField("birthday");d.setDisabled(true);d.hide()},removeTeachInfo:function(){var b=this,a=b.getSelectionModel().getSelection(),c;if(a.length){c=a[0]}else{Ext.Msg.alert("提示","请先选中一行！");return}passCB=function(){b.request(b.removeUrl,{uuid:c.get("uuid")},{maskId:b.createMask(b,"正在删除班级课程授课老师信息"),success:function(){b.store.reload()}})};Ext.Msg.confirm("提示","删除该记录将会影响班级授课教师信息，统计分析等，确认要删除吗？",function(d){d=="yes"&&new bbt.DangerOperate({onPass:passCB}).show()})},hasSchoolYear:function(a){bbt.loadCurrentSchoolYear(function(c,b,e){var d=Ext.decode(e.responseText);if(d.status=="success"){a.down("displayfield").setValue(d.data.school_year+" （"+d.data.term_type+"）")}else{Ext.Msg.alert("提示","当前没有学年学期!",function(){a.destroy()})}})},getTeachInfoWindowConfig:function(){var d=bbt.ToolBox.get("gradeOld",{displayAll:false}),c=bbt.ToolBox.get("classOld",{displayAll:false}),e=bbt.ToolBox.get("courseOld",{displayAll:false}),b=bbt.ToolBox.get("teacherName",{valueField:"uuid",name:"teacher"});delete d.labelWidth;delete c.labelWidth;delete e.labelWidth;delete b.labelWidth;c.store.removeAll();delete b.hideTrigger;b.store.on("load",function(f){var g=f.getAt(0);if(g.get("value")===""){f.remove(g)}});Ext.merge(b,{listeners:{change:function(h,f){var j=h.findRecordByValue(f),g=h.ownerCt.down("[name=birthday]"),i=[];if(j){h.store.each(function(k){if(k.get("text")==j.get("text")){i.push({birthday:k.get("birthday"),uuid:k.get("uuid")})}});g.store.loadData(i);g.setValue(f);g.setDisabled(i.length<=1)}else{g.setDisabled(true);g.setValue(undefined);g.store.removeAll()}}}});var a={modal:true,width:380,closable:false,resizable:false,layout:"fit",items:[{xtype:"form",bodyCls:"no-bg",border:false,margin:30,layout:"anchor",defaults:{anchor:"100%",allowBlank:false,margin:"10 0 0 0"},items:[{xtype:"displayfield",fieldLabel:"学年学期",name:"school_year",value:""},d,c,e,b,{xtype:"combo",fieldLabel:"教师生日",name:"birthday",displayField:"birthday",valueField:"uuid",editable:false,disabled:true,queryMode:"local",store:new Ext.data.Store({fields:["birthday","uuid"]}),listeners:{change:function(g,f){f&&g.ownerCt.down("[name=teacher]").setValue(f)}}},{xtype:"textfield",name:"schedule_time",fieldLabel:"分配课时",regex:/^\d+$/,regexText:"无效的数字"},{xtype:"displayfield",name:"remain_time",fieldLabel:"本班剩余课时",regex:/^\d+$/,regexText:"无效的数字"}]}],buttonAlign:"center"};return a}});Ext.define("bbt.CourseTable",{extend:"bbt.ManageGrid",alias:"widget.coursetable",fields:["grade__name","name","grade__term__school_year","grade__term__term_type","teacher__name","teacher__birthday","classtime__schedule_time","classtime__assigned_time","grade__term__schedule_time","assigned_time"],columns:[{text:"学年",dataIndex:"grade__term__school_year"},{text:"学期类型",dataIndex:"grade__term__term_type"},{text:"年级",dataIndex:"grade__name",renderer:function(a){return a?a+"年级":""}},{text:"班级",dataIndex:"name",renderer:function(a){return a?a+"班":""}},{text:"本学期班主任",dataIndex:"teacher__name"},{text:"出生年月",dataIndex:"teacher__birthday"},{text:"学期参考计划课时",width:120,dataIndex:"grade__term__schedule_time"},{text:"已分配课时",dataIndex:"assigned_time"},{text:"未分配课时",dataIndex:"xxx",renderer:function(f,d,g){var e,c;e=g.get("grade__term__schedule_time")||0;c=g.get("assigned_time")||0;return e-c}}],pagination:true,showOperateColumn:true,listUrl:"/system/class/list/",listScheduleUrl:"/system/lesson_schedule/list/",updateUrl:"/system/lesson_schedule/edit/",importUrl:"/system/lesson_schedule/import/",operates:{"import":"导入",preview:"预览"},actionMap:{"import":"importSchedule",preview:"previewSchedule"},listeners:{afterrender:function(){this.store.load();this.store.on("load",this.bindPreview,this);this.getEl().insertHtml("beforeEnd",'<div style="position:absolute;top:0;left:0;z-index:19999;width:800px;height:300px;box-shadow: 0 0 25px #000;" id="preview-course-body"></div>');Ext.get("preview-course-body").hide();this.initPreviewGrid()},itemmouseenter:function(a,b){this.previewGrid.listUrl=this.listScheduleUrl+"?uuid="+b.raw.uuid},beforedestroy:function(){this.previewGrid.destroy()}},showPreview:function(g,d){var c,h,b,f,a;this.previewGrid.loadStore();c=Ext.get(d).getBox();f=this.body.getBox();h=Ext.get("preview-course-body");h.mask("loading ...");a=h.getBox();if(c.y-f.y>a.height){b=c.y-a.height}else{if((f.y+f.height)>(c.y+c.height+a.height)){b=c.y+c.height}else{b=f.y+5}}h.setXY([c.x-h.getWidth(),b]);h.show()},hidePreview:function(){var a=Ext.get("preview-course-body");a.unmask();a.hide()},bindPreview:function(){var a=this;Ext.each(a.getEl().query("a[action=preview]"),function(b){b=Ext.get(b);b.on("mouseenter",a.showPreview,a);b.on("mouseleave",a.hidePreview,a)})},initPreviewGrid:function(){this.previewGrid=Ext.widget({xtype:"grid",border:true,width:800,height:300,overflowX:"hidden",store:new Ext.data.Store({fields:["jieci","mon","tue","wed","thu","fri","sat","sun"],sorters:[{property:"jieci",direction:"ASC"}]}),renderTo:"preview-course-body",columns:{defaults:{sortable:false,menuDisabled:true,draggable:false,height:22,width:95},items:[{text:"节次",dataIndex:"jieci",width:130,renderer:function(b,a,c){return b+" ("+c.raw.start_time+"~"+c.raw.end_time+")"}},{text:"周一",dataIndex:"mon"},{text:"周二",dataIndex:"tue"},{text:"周三",dataIndex:"wed"},{text:"周四",dataIndex:"thu"},{text:"周五",dataIndex:"fri"},{text:"周六",dataIndex:"sat"},{text:"周日",dataIndex:"sun",flex:1}]},autoHeight:function(){var a=(this.store.count()+1)*21+10;this.setHeight(a);Ext.get("preview-course-body").setHeight(a)},feed:function(c){var b=[],a=this.store;Ext.each(c,function(d){var e=d.lesson_period__sequence,f=b[e];if(typeof f=="undefined"){f=b[e]={}}f[d.weekday]=d.lesson_name__name;f.jieci=e;if(!f.start_time){f.start_time=d.lesson_period__start_time.substring(0,5);f.end_time=d.lesson_period__end_time.substring(0,5)}});a.removeAll();Ext.each(b,function(d){if(d){a.add(d)}})},loadStore:function(){var a=this;Ext.Ajax.request({url:this.listUrl,callback:function(c,b,g){var d;Ext.get("preview-course-body").unmask();try{d=Ext.decode(g.responseText);a.feed(d.data.records);a.autoHeight()}catch(f){console.log(f)}}})}})},previewSchedule:function(){return;var a=this.getSelectionModel().getSelection(),b;if(!a.length){Ext.Msg.alert("提示","请先选中一行！");return}schedule=a[0];b=new Ext.window.Window(this.getScheduleWindowConfig(schedule.get("grade__name"),schedule.get("name"),schedule.raw.uuid));this.apply2ScheduleWindow(b);b.show()},importSchedule:function(){var d=this,a=this.getSelectionModel().getSelection(),e,c,f,b;if(!a.length){Ext.Msg.alert("提示","请先选中一行！");return}schedule=a[0];f={school_year:schedule.get("grade__term__school_year"),term_type:schedule.get("grade__term__term_type"),grade_name:schedule.get("grade__name"),class_name:schedule.get("name")};c={xtype:"window",modal:true,title:"导入"+f.grade_name+"年级"+f.class_name+"班课程表",layout:{type:"vbox",align:"stretch"},width:300,height:180,items:[{xtype:"component",flex:1,margin:"30 30 10 30",html:'<p style="color:red;">注：如果该班级已经导入过课程表，本次导入将会予以覆盖！</p>'},{xtype:"form",border:false,margin:"0 30 30 30",flex:1,bodyCls:"no-bg",layout:{type:"hbox",align:"middle",pack:"center"},items:[{xtype:"fileuploadfield",name:"excel",buttonOnly:true,importUrl:d.importUrl,margin:0,padding:0,buttonConfig:{text:"选择文件并导入"},listeners:{change:function(h,i){var g=h.up("teacher");if(!/\.xlsx?$/.test(i)){Ext.Msg.alert("提示","请选择 excel 文件！");h.reset();return}b=new Ext.LoadMask(e,{msg:"正在导入课表"});b.show();h.up("form").submit({url:h.importUrl,params:f,success:function(k,j){b.hide();Ext.Msg.alert("提示","导入成功！",function(){h.up("window").destroy()})},failure:function(k,j){b.hide();Ext.Msg.alert("提示",getErrorMsg(j.result))}})}}}]}]};e=new Ext.window.Window(c).show()},getScheduleWindowConfig:function(d,e,b){var a={xtype:"window",modal:true,width:800,height:300,title:d+"年级"+e+"班课程表",layout:"fit",items:[{xtype:"grid",border:false,store:new Ext.data.Store({fields:["jieci","mon","tue","wed","thu","fri","sat","sun"],sorters:[{property:"jieci",direction:"ASC"}]}),importUrl:this.importUrl,listUrl:this.listScheduleUrl+"?uuid="+b,columns:{defaults:{sortable:false,menuDisabled:true,draggable:false},items:[{text:"节次",dataIndex:"jieci",width:50},{text:"周一",dataIndex:"mon"},{text:"周二",dataIndex:"tue"},{text:"周三",dataIndex:"wed"},{text:"周四",dataIndex:"thu"},{text:"周五",dataIndex:"fri"},{text:"周六",dataIndex:"sat"},{text:"周日",dataIndex:"sun"}]}}]};return a},apply2ScheduleWindow:function(b){var a=b.down("grid");Ext.apply(a,{feed:function(e){var d=[],c=this.store;Ext.each(e,function(f){var g=f.lesson_period__sequence,h=d[g];if(typeof h=="undefined"){h=d[g]={}}h[f.weekday]=f.lesson_name__name;h.jieci=g});Ext.each(d,function(f){if(f){c.add(f)}})},loadStore:function(){var c=this;Ext.Ajax.request({url:this.listUrl,callback:function(f,d,i){var g;try{g=Ext.decode(i.responseText);c.feed(g.data.records)}catch(h){}}})}});a.loadStore()}});Ext.define("bbt.BasicInfo",{extend:"Ext.tab.Panel",alias:"widget.basicinfo",initComponent:function(){var a=[new Ext.data.Store({fields:["school_year","term_type","start_date","end_date","deleted"],proxy:{url:"/system/baseinfo/term/",type:"ajax",reader:{type:"json",root:"data.records",totalProperty:"data.record_count"}}}),new Ext.data.Store({fields:["number","name","types","remark"],proxy:{url:"/system/baseinfo/lesson-name/",type:"ajax",reader:{type:"json",root:"data.records",totalProperty:"data.record_count"}}}),new Ext.data.Store({fields:["value","remark"],proxy:{url:"/system/baseinfo/resource-from/",type:"ajax",reader:{type:"json",root:"data.records",totalProperty:"data.record_count"}}}),new Ext.data.Store({fields:["value","remark"],proxy:{url:"/system/baseinfo/resource-type/",type:"ajax",reader:{type:"json",root:"data.records",totalProperty:"data.record_count"}}})];this.defaultType="grid";this.defaults={border:false};this.items=[{title:"学年学期信息",columns:[{text:"学年",dataIndex:"school_year"},{text:"学期类型",dataIndex:"term_type"},{text:"开始时间",dataIndex:"start_date"},{text:"结束时间",dataIndex:"end_date"},{text:"状态",dataIndex:"deleted",renderer:function(b){return b?"已结转":"正常"}}],bbar:{xtype:"pagingtoolbar",store:a[0],displayInfo:true},store:a[0],listeners:{afterrender:function(){this.fireEvent("show",this)},show:function(){this.store.load()}}},{title:"学校开课课程",columns:[{xtype:"rownumberer",text:"序号",width:50},{text:"课程名称",dataIndex:"name",width:200},{text:"适用学校类型",dataIndex:"types",width:200,renderer:function(b){return b.replace(/,/g,"，")}},{text:"备注",dataIndex:"remark",flex:1}],bbar:{xtype:"pagingtoolbar",store:a[1],displayInfo:true},store:a[1],listeners:{show:function(){this.store.load()}}},{title:"资源来源",columns:[{text:"资源来源",width:300,dataIndex:"value"},{text:"备注",dataIndex:"remark",flex:1}],bbar:{store:a[2],xtype:"pagingtoolbar",displayInfo:true},store:a[2],listeners:{show:function(){this.store.load()}}},{title:"资源类型",columns:[{text:"资源类型",width:160,dataIndex:"value"},{text:"备注",dataIndex:"remark",flex:1}],bbar:{store:a[3],xtype:"pagingtoolbar",displayInfo:true},store:a[3],listeners:{show:function(){this.store.load()}}}];this.callParent()}});Ext.define("bbt.SchoolSettings",{extend:"Ext.window.Window",alias:"widget.school_setting",getDetails:function(){var a=this;apiRequest.msg="loading ...";apiRequest.target=a;apiRequest("/system/school-server-setting/get/",{},function(c){var b=a.down("form").getForm();b.findField("host").setValue(c.data.host);b.findField("port").setValue(c.data.port)})},initComponent:function(){Ext.apply(this,this.getPopConfig());this.callParent();this.show();this.getDetails()},getPopConfig:function(){var a={title:"校级服务器设置",resizable:false,closable:false,modal:true,width:450,layout:"fit",items:[{xtype:"form",bodyCls:"no-bg",layout:{type:"vbox",align:"center",pack:"center"},defaultType:"textfield",defaults:{width:320},border:false,items:[{fieldLabel:"IP 地址",name:"host",margin:"40 0 0 0",validator:function(b){var c=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,d;if(!b){return"IP地址不可为空！"}if(~b.indexOf(":")){d=b.split(":");d[1]=parseInt(d[1]);return c.test(d[0])&&!isNaN(d[1])&&d[1]>=0&&d[1]<65536||msg}else{return c.test(b)||"错误的IP地址！"}}},{margin:"10 0 40 0",fieldLabel:"端口号",name:"port",emptyText:"不可为空",allowBlank:false,validator:function(b){var c=/^[1-9]\d+$/.test(b),d;if(!b){return"端口号不可为空！"}d="错误的端口号！";if(c){b=parseInt(b);return(b>0&&b<=65535)?true:d}return d}}]}],buttonAlign:"center",buttons:[{xtype:"button",text:"确定",margin:"0 10 10 10",handler:function(){var c=this.up("window"),b=c.down("form"),d;d=checkForm(b);if(d!==true){return}b=b.getForm();b.waitTarget=c;b.submit({url:"/system/school-server-setting/set/",waitMsg:"正在提交数据……",success:function(e,g){var f=g.result;if(f.status=="success"){Ext.Msg.alert("提示",f.msg,function(){c.destroy()})}}})}},{xtype:"button",margin:"0 10 10 10",text:"关闭",handler:function(){this.up("window").destroy()}}]};return a}});Ext.define("bbt.MaintainView",{extend:"Ext.view.View",alias:"widget.maintainview",style:{paddingBottomWidth:"15px"},itemSelector:".class-item",tpl:['<tpl for=".">','<div class="class-item">','<div class="status-icon {cls}"></div>','<div class="class-info">{info}</div>',"</div>",'</tpl><div style="clear:left;height:15px;"></div>'],constructor:function(){var a=new Ext.data.Store({fields:["grade_name","class_name","mac","online"],proxy:{url:"/system/maintenance/list-system/",type:"ajax",reader:{type:"json",root:"data.records",totalProperty:"data.record_count"}}});this.selectedItemCls="class-item-selected";this.store=a;a.load();this.callParent()},initComponent:function(){this.listeners={afterrender:function(){var a=this.el;a.on("mouseover",function(b){Ext.fly(b.target).addCls(["x-over","x-btn-over","x-btn-default-small-over"])},undefined,{delegate:".ext-btn"});a.on("mouseout",function(b){Ext.fly(b.target).removeCls(["x-over","x-btn-over","x-btn-default-small-over"])},undefined,{delegate:".ext-btn"});a.on("click",function(b){var c=b.target.getAttribute("action");Ext.getCmp("content-panel").child("maintainpanel")[c]()},undefined,{delegate:".ext-btn"})},itemmouseenter:function(){Ext.fly(arguments[2]).addCls("class-item-hover")},itemmouseleave:function(){Ext.fly(arguments[2]).removeCls("class-item-hover")},itemclick:function(){var b=this,a=this.up("maintainpanel"),c=a.down("[name=select-all]"),d=arguments[1];if(c.getValue()){this.store.each(function(e){if(d!==e){Ext.fly(b.getNode(e)).removeCls(b.selectedItemCls)}});c.setValue(false)}this.getSelectionModel().select(arguments[1])}};this.callParent()},prepareData:function(c,b,a){var d=Ext.String.format('{0}年级{1}班<br/><span class="mac">{2}</span><br/> <a href="javascript:void(0);" action="shutdown" class="x-btn x-btn-default-small ext-btn">关机</a> <a href="javascript:void(0);" action="reboot" class="x-btn x-btn-default-small ext-btn">重启</a>',c.grade_name,c.class_name,c.mac||'<b style="color: red;">未申报</b>',Math.floor(c.login_time/60));c.online||(c.cls="offline");c.info=d;return c}});Ext.define("bbt.MaintainPanel",{extend:"Ext.panel.Panel",alias:"widget.maintainpanel",initComponent:function(){this.tbar=[bbt.ToolBox.get("gradeOld",{fieldLabel:"终端分组",labelWidth:65,width:165,useSuffix:true}),{text:"刷新",name:"refresh",iconCls:"icon-refresh"},"-",{xtype:"checkbox",name:"select-all",boxLabel:"全选当前终端",listeners:{change:function(c,b){var a=this.up("maintainpanel").child("maintainview");a.store.each(function(d){if(b){Ext.fly(a.getNode(d)).addCls(a.selectedItemCls)}else{Ext.fly(a.getNode(d)).removeCls(a.selectedItemCls)}})}}},{text:"远程关机",name:"shutdown",iconCls:"icon-shutdown"},{text:"远程重启",name:"reboot",iconCls:"icon-reboot"}];this.autoScroll=true;this.items={xtype:"maintainview"};this.listeners={afterrender:function(){var a=this.child("toolbar[dock=top]");a.down("[name=grade_name]").on("change",this.reloadStore,this);a.down("[name=refresh]").setHandler(this.reloadStore,this);a.down("[name=shutdown]").setHandler(this.shutdown,this);a.down("[name=reboot]").setHandler(this.reboot,this)}};this.callParent()},reloadStore:function(b,c){var a=this.child("maintainview");if(typeof c!="undefined"){a.store.proxy.extraParams.grade_name=c}a.store.load()},getSelectedRecords:function(){var b=this.child("maintainview"),a;a=this.body.query("."+b.selectedItemCls);a=Ext.Array.map(a,function(c){return b.getRecord(c)});return a},shutdown:function(){var a=this.getSelectedRecords();if(!a.length){return}a=Ext.Array.filter(a,function(b){return !!b.get("mac")});if(!a.length){return}Ext.Msg.confirm("提示","确定要关闭 "+a.length+" 台班班通客户端吗？",function(c){(c=="yes")&&Ext.Ajax.request({url:"/system/maintenance/run-shutdown/",params:{mac:Ext.Array.map(a,function(b){return b.get("mac")})},method:"POST",callback:function(d,b,e){}})})},reboot:function(){var a=this.getSelectedRecords();if(!a.length){return}a=Ext.Array.filter(a,function(b){return !!b.get("mac")});if(!a.length){return}Ext.Msg.confirm("提示","确定要重启 "+a.length+" 台班班通客户端吗？",function(c){(c=="yes")&&Ext.Ajax.request({url:"/system/maintenance/run-reboot/",params:{mac:Ext.Array.map(a,function(b){return b.get("mac")})},method:"POST",callback:function(d,b,e){}})})}});Ext.define("bbt.RemoteHelpView",{extend:"Ext.view.View",alias:"widget.remotehelpview",style:{paddingBottomWidth:"15px"},itemSelector:".class-item",tpl:['<tpl for=".">','<div class="class-item">','<div class="status-icon {cls}"></div>','<div class="class-info">{info}</div>','<a class="over-btn viewer">远程查看</a>','<a class="over-btn controller">远程协助</a>',"</div>",'</tpl><div style="clear:left;height:15px;"></div>'],constructor:function(){var a=new Ext.data.Store({fields:["grade_name","class_name","mac","online"],proxy:{url:"/system/maintenance/list-system/",type:"ajax",reader:{type:"json",root:"data.records",totalProperty:"data.record_count"}}});this.store=a;a.load();this.listeners={afterrender:function(){var b=this.el;b.on("mousemove",function(g,f){var c=g.getX(),f=Ext.fly(f),h=f.child(".viewer"),d=f.child(".controller");console.log("viewer left",h.getStyle("left"));console.log("controller right",d.getStyle("right"));if((c-f.getLeft())>=f.getWidth()/2){if(h.getStyle("left")!="-50%"){h.setStyle("left","-50%")}if(d.getStyle("right")!="0"){d.setStyle("right",0)}}else{if(d.getStyle("right")!="-50%"){d.setStyle("right","-50%")}if(h.getStyle("left")!="0"){h.setStyle("left",0)}}},undefined,{delegate:".class-item"});b.on("mouseout",function(d,c){c=Ext.fly(c);c.child(".viewer").setStyle("left","-50%");c.child(".controller").setStyle("right","-50%")},undefined,{delegate:".class-item"})},itemclick:function(){}};this.callParent()},prepareData:function(c,b,a){var d=Ext.String.format("{0}年级{1}班<br/>{2}<br/> <b>{3}</b> <b>{4}</b>",c.grade_name,c.class_name,c.online?'<b style="color: green;">登陆上课中</b>':'<b style="color:red;">未登录</b>',c.lesson_name,c.teacher);c.online||(c.cls="offline");c.info=d;return c}});Ext.define("bbt.RemoteHelpPanel",{extend:"Ext.panel.Panel",alias:"widget.remotehelppanel",initComponent:function(){this.tbar=[{text:"刷新",name:"refresh",iconCls:"icon-refresh"}];this.autoScroll=true;this.items={xtype:"remotehelpview"};this.listeners={afterrender:function(){var a=this.child("toolbar[dock=top]");a.down("[name=refresh]").setHandler(this.reloadStore,this)}};this.callParent()},reloadStore:function(){var a=this.child("remotehelpview");a.store.load()}});Ext.define("bbt.NoticeWindow",{extend:"Ext.window.Window",alias:"widget.noticewindow",modal:true,draggable:false,resizable:false,closable:false,initComponent:function(){this.width=500;this.layout="fit";this.items=[{xtype:"form",bodyCls:"no-bg",margin:30,layout:"anchor",border:false,defaults:{anchor:"100%",margin:"0 0 10 0"},items:[{xtype:"checkbox",boxLabel:"启用校园电子公告",name:"enable"},{xtype:"textfield",name:"title",fieldLabel:"公告标题",labelWidth:65},{xtype:"textarea",name:"content",fieldLabel:"详细内容",margin:0,height:200,labelWidth:65}]}];this.buttonAlign="center";this.buttons=[{text:"确定",handler:function(){this.up("window").sendNotice()}},{text:"取消",handler:function(){this.up("window").destroy()}}];this.callParent();this.show()},sendNotice:function(){}})}else{Ext.define("bbt.Term",{extend:"bbt.ManageGrid",alias:"widget.term2",types:["春季学期","秋季学期"],fields:["uuid","school_year","term_type","start_date","end_date","schedule_time","deleted"],sorters:[{property:"school_year",direction:"DESC"},{property:"term_type",direction:"DESC"}],columns:[{text:"学年",dataIndex:"school_year",width:200},{text:"学期类型",dataIndex:"term_type",width:120},{text:"开始时间",dataIndex:"start_date",width:150,renderer:bbt.utils.strftime},{text:"结束时间",dataIndex:"end_date",width:150,renderer:bbt.utils.strftime},{text:"计划达标课时/班级",dataIndex:"schedule_time",width:120},{text:"状态",dataIndex:"deleted",renderer:function(a){return a?"已结转":"正常"}}],showOperateColumn:true,tbar:[{text:"添加学期",action:"add",iconCls:"icon-add"},{text:"编辑学期",action:"edit",iconCls:"icon-edit"}],importUrl:"/system/newterm/import/",listUrl:"/system/newterm/list/",addUrl:"/system/newterm/add/",removeUrl:"/system/newterm/delete/",updateUrl:"/system/newterm/edit/",actionMap:{add:"addTerm",edit:"updateTerm",remove:"removeTerm",gonext:"gonext",associate:"associate"},listeners:{edit:function(a,b){b.record.commit()},show:function(a){a.store.load()}},operates:{gonext:"学期结转",associate:"关联教材大纲"},pagination:true,operateRenderer:function(){var b=this,a='<a href="javascript:void(0);" action="associate">关联教材大纲</a>';return function(e,c,g){var h=Ext.Date.parse(g.get("start_date"),"Y-m-d"),d=Ext.Date.parse(g.get("end_date"),"Y-m-d"),f=new Date();f.setHours(0,0,0,0);if(g.raw.deleted){return""}if(f>d){g.raw.editable=false;return b.getOperateFn()()}return a}},associate:function(a,c){var b=c.get("uuid");this.bubble(function(e){var d=e.getLayout();if(d.isLayout&&d.setActiveItem){d.setActiveItem(1).term_uuid=b;return false}})},addTerm:function(){var b=this,a,c;a=Ext.apply(b.getTermWindowConfig(),{title:"添加学期",buttons:[{text:"确定",handler:function(){var g=this.up("window"),e=g.down("form"),f,d;f=b.checkForm(e);if(f!==true){return}e.getForm().findField("school_year").setValue(e.down("[fakeName=start_year]").getValue()+"-"+e.down("[fakeName=end_year]").getValue());if(b.addUrl){b.request(b.addUrl,{form:e},{success:function(h){b.store.reload();g.destroy()},maskId:b.createMask(g,"正在添加学期")})}else{b.store.add(e.getForm().getFieldValues());g.destroy()}}},{text:"关闭",margin:"0 20",handler:function(){this.up("window").destroy()}}]});c=Ext.create("Ext.window.Window",a);c.show()},removeTerm:function(){var c=this,b,a,d;a=c.getSelectionModel().getSelection();if(!a.length){Ext.Msg.alert("提示","请先选择学期！");return}b=a[0];d=function(){c.request(c.removeUrl,{uuid:b.get("uuid")},{success:function(){c.store.reload()},maskId:c.createMask(this,"正在删除学期")})};Ext.Msg.confirm("提示","删除学期将将会影响到作息时间，班级授课教师，统计分析等，确认要继续吗？",function(e){e=="yes"&&new bbt.DangerOperate({onPass:d}).show()})},updateTerm:function(){var g=this,b,f,d,k,h,j,e,a,c;k=g.getSelectionModel().getSelection();if(!k.length){Ext.Msg.alert("提示","请先选择学期！");return}d=k[0];if(d.raw.editable===false){Ext.Msg.alert("提示","学期已经过了，不能编辑！");return}b=Ext.apply(g.getTermWindowConfig(),{title:"编辑学期",buttons:[{text:"确定",handler:function(){var m=this.up("window"),i=m.down("form"),l;l=g.checkForm(i);if(l!==true){return}i.getForm().findField("school_year").setValue(i.down("[fakeName=start_year]").getValue()+"-"+i.down("[fakeName=end_year]").getValue());if(g.updateUrl){g.request(g.updateUrl,{uuid:d.get("uuid"),form:i},{form:i,maskId:g.createMask(m,"正在修改学期"),success:function(n){d.set(n.data);d.commit();m.destroy()}})}else{d.set(i.getForm().getFieldValues());d.commit();m.destroy()}}},{text:"关闭",margin:"0 20",handler:function(){this.up("window").destroy()}}]});h=d.get("school_year").split("-");f=Ext.create("Ext.window.Window",b);f.show();j=f.down("form").getForm();j.getFields().each(function(i){if(i.name=="end_date"||i.name=="schedule_time"){return}if(i.fakeName=="end_year"){i.setValue(h[1]);return}if(i.fakeName=="start_year"){i.setValue(h[0])}i.setReadOnly(true)});j.setValues(d.data)},_go_next:function(b){var a=this;this.request("/system/newterm/finish/",{uuid:b.get("uuid")},{success:function(){a.store.reload()}})},gonext:function(){var c=this,b,a;a=c.getSelectionModel().getSelection();if(!a.length){Ext.Msg.alert("提示","请先选择一行！");return}b=a[0];Ext.Msg.confirm("提示","该学期真的结束了吗？<br/>学期结转后，将清除下辖各学校服务器中该学期对应的｛学校作息时间｝、｛年级班级｝、｛班级课程表｝和｛班级课程授课老师｝信息，请问是否继续结转并开始新的学期？",function(d){d=="yes"&&new bbt.DangerOperate({onPass:function(){c._go_next(b)}}).show()})},prepareNextTerm:function(){},getTermWindowConfig:function(){var e=new Date().getFullYear(),c=e-4,a=e+5,d=[];for(;c<=a;c++){d.push([c,c+""])}var b={closable:false,resizable:false,width:322,modal:true,layout:"fit",items:[{xtype:"form",bodyCls:"no-bg",border:false,layout:"anchor",padding:20,defaults:{labelWidth:120,anchor:"100%",allowBlank:false},items:[{xtype:"combo",fakeName:"start_year",fieldLabel:"开始学年",editable:false,value:e,store:d,listeners:{change:function(h,g){var f=h.up("form").down("textfield[fakeName=end_year]");f.setValue(g+1+"")}}},{xtype:"textfield",fakeName:"end_year",value:e+1+"",fieldLabel:"结束学年",readOnly:true},{xtype:"combo",name:"term_type",store:this.types,value:"春季学期",editable:false,fieldLabel:"学年类型"},{xtype:"datefield",name:"start_date",editable:false,margin:"10 0",fieldLabel:"开始时间",format:"Y-m-d",validator:function(h){var j=this,g=j.getValue(),f,i;f=j.up("form").down("datefield[name=end_date]");i=f.getValue();if(g&&i&&g>i){return("开始时间不能大于结束时间！")}return true}},{xtype:"datefield",editable:false,name:"end_date",fieldLabel:"结束时间",format:"Y-m-d",validator:function(g){var i=this,h=i.getValue(),j,f;j=i.up("form").down("datefield[name=end_date]");f=j.getValue();if(f&&h&&f>h){return("开始时间不能大于结束时间！")}return true},listeners:{change:function(f){f.up("form").down("datefield[name=start_date]").validate()}}},{xtype:"textfield",fieldLabel:"计划达标课时/班级",name:"schedule_time",regex:/^[1-9]\d*/,regexText:"无效的数字",validator:function(f){f=parseInt(f);if(!isNaN(f)){return f<=2147483647?true:this.regexText}return this.regexText}},{xtype:"hidden",name:"school_year"}]}],buttonAlign:"right"};return b}});Ext.define("bbt.CourseOutline",{extend:"Ext.panel.Panel",alias:"widget.courseoutline",initComponent:function(){this.layout="border";this.bodyCls="no-bg";this.tbar=[{text:"<< 返回",action:"returnTerm"}];this.items=[{xtype:"panel",header:false,border:false,layout:"anchor",defaults:{anchor:"100%"},bodyStyle:{background:"url(/public/images/borderbg.png) repeat-y right"},region:"west",width:140,items:[{xtype:"boundlist",displayField:"grade_name",valueField:"value",style:{borderRight:"1px solid #99bce8 !important"},itemCls:"grade-item",tpl:'<ul style="background-color:#cbdaf0;"><tpl for="."><li role="option" class="grade-item"><a class="editor"></a>{grade_name}</li></tpl></ul><div role="line" style="position:absolute;height:31px;display:none;width:0px;border-right:1px solid #FFF;"></div>',store:new Ext.data.Store({data:[{value:"一",grade_name:"一年级（小学）"},{value:"二",grade_name:"二年级（小学）"},{value:"三",grade_name:"三年级（小学）"},{value:"四",grade_name:"四年级（小学）"},{value:"五",grade_name:"五年级（小学）"},{value:"六",grade_name:"六年级（小学）"},{value:"七",grade_name:"七年级（初中）"},{value:"八",grade_name:"八年级（初中）"},{value:"九",grade_name:"九年级（初中）"},{value:"十",grade_name:"十年级（高中）"},{value:"十一",grade_name:"十一年级（高中）"},{value:"十二",grade_name:"十二年级（高中）"}],fields:["grade_name","value","in_use"]})}]},{xtype:"tabpanel",layout:"fit",margin:10,region:"center",items:[{xtype:"panel",action:"addCourse",title:"+"}],updateCourseList:function(c){var b=this,d=b.ownerCt,a=new Ext.LoadMask(d,{msg:"loading..."});a.show();Ext.Ajax.request({url:"/system/term/syllabus/lesson-list/",method:"GET",params:{grade_name:c.get("value"),term_uuid:d.term_uuid},callback:function(g,f,h){var e=Ext.decode(h.responseText);if(e.status=="success"){d.RESOURCE_PLATFORM_HOST=e.data.RESOURCE_PLATFORM_HOST;Ext.each(e.data.records,function(i){b.insert(0,{xtype:"courseoutlineinfo",rawData:i})});b.setActiveTab(0)}a.hide();a.destroy()}});b.items.each(function(e){if(e.action!="addCourse"){b.remove(e,true)}})}}];this.listeners={afterrender:function(){var b=this,a=b.child("tabpanel"),c;b.down("toolbar[dock=top]").down("[action=returnTerm]").setHandler(b.returnTerm,b);c=b.down("boundlist");c.store.on("load",function(e,d){var f;if(e.count()>0){f=e.getAt(0);this.getSelectionModel().select(f)}},c);c.on("itemclick",function(d,i,g){var k=arguments[4],j=k.target,f,h;if(j.className!="editor"){return}h=!j.getAttribute("data-clicked");f=this.ownerCt.ownerCt.down("tabpanel");Ext.each(f.query("tab"),function(e){if(e.text!="+"){e.setClosable(h);if(!e.closeCallback){e.closeCallback=function(){var m=this,l;l=function(){Ext.Ajax.request({url:"/system/term/syllabus/lesson-del/",method:"POST",params:{id:m.card.rawData.id},callback:function(p,o,q){var n=Ext.decode(q.responseText);if(n.status=="success"){m.up("tabpanel").remove(m.card)}else{Ext.Msg.alert("提示",n.msg)}}})};Ext.Msg.confirm("提示","确定要删除课程 "+m.text+" 吗？",function(n){if(n=="yes"){new bbt.DangerOperate({onPass:l}).show()}});return false}}if(h){e.on("beforeclose",e.closeCallback)}else{e.un("beforeclose",e.closeCallback)}}});if(h){j.setAttribute("data-clicked",true);j.style.backgroundColor="#D3E1F1"}else{j.removeAttribute("data-clicked");j.style.backgroundColor="#FFF"}});c.on("select",function(e,g){var h,f,d;this.ownerCt.ownerCt.down("tabpanel").updateCourseList(g);f=this.getNode(g);h=Ext.fly(f).getOffsetsTo(this.el);d=this.getEl().down("[role=line]");d.setStyle({left:h[0]+Ext.fly(f).getWidth()+"px",top:h[1]-1+"px"});d.show()},c);a.down("tab").on("click",function(d,f){this.addCourse();return false},b);a.on("tabchange",function(d,f,e){if(f===e){return}if(d.is_from_zy){delete d.is_from_zy;return}if(f.action=="addCourse"){d.is_from_zy=true;d.setActiveTab(e)}})},show:function(){var a=this,b=a.down("boundlist");setTimeout(function(){b.store.load({params:{uuid:a.term_uuid}},50)})}};this.callParent()},enableSetting:function(){var a={xtype:"window",title:"同步设置",modal:true,__parent:this,closable:false,resizable:false,layout:"fit",width:350,minHeight:210,items:[{xtype:"grid",border:false,columns:[{text:"年级",dataIndex:"grade_name",flex:1},{text:"状态",dataIndex:"in_use",renderer:function(b){return b?"已启用":"未启用"},flex:1},{text:"操作",dataIndex:"xxx",renderer:function(c,b,d){if(!d.get("in_use")){return'<a href="javascript:void(0);" action="enable">启用</a>'}return""},flex:1}],store:this.down("boundlist").store,listeners:{itemclick:function(d,f,c,b,g){try{if(g.target.getAttribute("action")=="enable"){this.enableGrade(f)}}catch(g){}}},enableGrade:function(c){if(!c){return}var b=this.up("window").__parent.term_uuid,d=function(){Ext.Ajax.request({method:"POST",url:"/system/term/syllabus/grade-enable/",params:{grade_name:c.get("value"),term_uuid:b},callback:function(f,e,h){var g=Ext.decode(h.responseText);if(g.status=="success"){c.set("in_use",true);c.commit()}}})};Ext.Msg.confirm("提示","该年级执行启用操作后，下辖学校的本年级将使用当前各课程的教材大纲标题，作为教学内容进行选择。此操作将不可逆转，是否继续？",function(e){(e=="yes")&&new bbt.DangerOperate({onPass:d}).show()})}}],buttons:[{text:"关闭",handler:function(){this.up("window").destroy()}}],buttonAlign:"right",listeners:{afterrender:function(){var b=this.down("grid");Ext.Ajax.request({url:"/system/term/syllabus/grade-set/",method:"GET",params:{term_uuid:this.__parent.term_uuid},callback:function(f,e,g){var d=Ext.decode(g.responseText),c={};if(d.status!="success"){return}d=d.data.records;Ext.each(d,function(h){c[h.grade_name]=h.in_use});b.store.each(function(i){var h=i.get("value");if(h in c){i.set("in_use",c[h]);i.commit()}})}})}}};Ext.widget(a).show()},returnTerm:function(){this.bubble(function(b){var a=b.getLayout();if(a.isLayout&&a.setActiveItem){a.setActiveItem(0);return false}})},getSelectGrade:function(){var a=this.down("boundlist").getSelectionModel().getSelection();if(a.length){a=a[0];return a}else{return null}},reloadGrade:function(b,d){var c=d.result,a;if(c.status=="success"){a=this.down("boundlist").store;a.reload()}else{Ext.Msg.alert("提示",getErrorMsg(c))}},addKlass:function(){var a=["一","二","三","四","五","六","七","八","九","十","十一","十二"];a=Ext.Array.map(a,function(c){return{text:bbt.fullgrade(c),value:c}});var b={xtype:"window",title:"添加年级",__parent:this,modal:true,closable:false,resizable:false,width:300,layout:"fit",items:[{xtype:"form",bodyCls:"no-bg",border:false,layout:"anchor",items:[{xtype:"combo",margin:20,name:"grade_name",editable:false,allowBlank:false,displayField:"text",valueField:"value",queryMode:"local",fieldLabel:"年级",store:new Ext.data.Store({fields:["text","value"],data:a})}]}],buttons:[{text:"确定",handler:function(){var g=this.up("window"),f=g.down("form").getForm(),c=g.down("form").getForm().getValues(),e,d;if(!f.isValid()){return}f.submit({url:"/system/term/syllabus/grade-add/",params:{uuid:g.__parent.term_uuid},success:g.__parent.reloadGrade,failure:function(h,i){console.log(arguments)},scope:g.__parent});g.destroy()}},{text:"关闭",handler:function(){this.up("window").destroy()}}],buttonAlign:"right"};Ext.widget(b).show()},addCourse:function(){var d=this.getSelectGrade(),b,c=this.term_uuid,a=this.RESOURCE_PLATFORM_HOST;b={xtype:"window",title:"添加课程",__parent:this,modal:true,closable:false,resizable:false,width:400,layout:"fit",items:[{xtype:"form",border:false,margin:30,layout:"anchor",bodyCls:"no-bg",defaults:{anchor:"100%",allowBlank:false},items:[{xtype:"hidden",name:"syllabus_grade",value:d?d.get("value"):""},{xtype:"combo",name:"lesson_name",editable:false,fieldLabel:"课程",displayField:"lessonname__name",valueField:"lessonname__name",store:new Ext.data.Store({fields:["uuid","lessonname__name"],proxy:{url:a+"/view/api/lessonname/list/",type:"jsonp",reader:{type:"json",root:"data.records"}},pageSize:1000,listeners:{beforeload:function(){var e=this.owner.ownerCt.down("[name=syllabus_grade]").getValue();this.proxy.extraParams.grade_name=e}}}),listeners:{afterrender:function(){this.store.owner=this},change:function(g,e){var f=g.ownerCt.down("[name=publish]");if(f.is_store_loaded){f.store.load()}}}},{xtype:"combo",name:"publish",editable:false,displayField:"name",valueField:"name",fieldLabel:"出版社",maxLength:100,store:new Ext.data.Store({fields:["name"],proxy:{url:a+"/view/api/publish/list-by-lessonname/",type:"jsonp",reader:{type:"json",root:"data.records"}},listeners:{beforeload:function(){var e=this.owner.ownerCt.down("[name=lesson_name]").getValue(),f=this.owner.up("window").__parent.getSelectGrade().get("value");this.owner.is_store_loaded=true;if(e){this.proxy.extraParams.lessonname=e;this.proxy.extraParams.grade_name=f}else{return false}}}}),listeners:{afterrender:function(){this.store.owner=this},change:function(g,e){var f=g.ownerCt.down("[name=date]");if(f.is_store_loaded){f.store.load()}}}},{xtype:"combo",name:"date",editable:false,displayField:"text",valueField:"value",fieldLabel:"出版日期",maxLength:100,store:new Ext.data.Store({fields:["year","month","number","remark","cover_pic","version_pic"],proxy:{url:a+"/view/api/bookversion/list-by-something/",type:"jsonp",reader:{type:"json",root:"data.records"},pageParam:undefined},listeners:{beforeload:function(){var e=this.owner.ownerCt,f={};f.lessonname=e.down("[name=lesson_name]").getValue();f.grade_name=d.get("value");f.publish=e.down("[name=publish]").getValue();this.owner.is_store_loaded=true;if(!(f.lessonname&&f.publish)){return false}Ext.apply(this.proxy.extraParams,f)},load:function(e){e.each(function(g){var i=g.get("year"),f=g.get("month"),h=g.get("number");g.set("text",Ext.String.format("{0}年{1}月第{2}版",i,f,h));g.set("value",i+"-"+f+"-"+h)})}}}),listeners:{afterrender:function(){this.store.owner=this}}}]}],buttons:[{text:"确定",handler:function(){var j=this.up("window"),i=j.down("form").getForm(),h,g,f,e;if(!i.isValid()){return}e=i.findField("date");e=e.findRecordByValue(e.getValue());f=new Ext.LoadMask(j,{msg:"正在提交..."});f.show();i.submit({params:{term_uuid:c,remark:e.get("remark"),cover_pic:e.get("cover_pic"),version_pic:e.get("version_pic")},url:"/system/term/syllabus/remote-get/",success:function(k,m){var l=m.result;f.destroy();j.destroy();if(l.status=="success"){h.insert(g,{xtype:"courseoutlineinfo",rawData:l.data.records});h.setActiveTab(g)}},failure:function(k,l){f.destroy();j.destroy();Ext.Msg.alert("提示",l.result.msg)}});h=j.__parent.down("tabpanel");g=h.items.getCount()-1}},{text:"关闭",handler:function(){this.up("window").destroy()}}],buttonAlign:"right"};Ext.widget(b).show()}});Ext.define("bbt.CourseOutlineInfo",{extend:"Ext.panel.Panel",alias:"widget.courseoutlineinfo",grade_name:null,lesson_name:null,importUrl:null,initComponent:function(){var a=this.rawData||{};this.layout={type:"hbox",align:"stretch"};this.defaults={border:false};this.title=a.lesson_name||"";this.items=[{xtype:"panel",bodyStyle:{borderRightWidth:"1px !important"},flex:1,layout:{type:"vbox",align:"stretch"},defaults:{margin:10},defaultType:"displayfield",items:[{xtype:"checkbox",name:"in_use",fieldLabel:"是否启用同步",checked:a.in_use,disabled:a.in_use,listeners:{change:function(g,i){if(!i){return}var c=g.up("courseoutlineinfo").title,b=g.up("courseoutline"),f=b.getSelectGrade().get("value"),j=b.term_uuid,d=g.ownerCt.down("[name=publish]").getValue(),e=g.ownerCt.down("[name=bookversion]")._value,h;h=function(){Ext.Ajax.request({url:"/system/term/syllabus/lesson-enable/",method:"POST",params:{bookversion:e,publish:d,lesson_name:c,grade_name:f,term_uuid:j},callback:function(m,l,n){var k=Ext.decode(n.responseText);if(k.status=="success"){g.setDisabled(true)}else{g.setValue(false);Ext.Msg.alert("提示",k.msg||"启用失败")}}})};new bbt.DangerOperate({onPass:h,onFail:function(){g.setValue(false)}}).show()}}},{name:"publish",fieldLabel:"出版社",value:a.publish},{name:"bookversion",fieldLabel:"版本日期",_value:a.bookversion,value:a.bookversion?a.bookversion.replace("-","年").replace("-","月第")+"版":"",},{name:"volume",fieldLabel:"书册",value:a.volume},{xtype:"displayfield",fieldLabel:"备注",name:"remark",value:a.remark||""},{xtype:"displayfield",labelWidth:0,labelSeparator:"",value:"教材贴图:",},{xtype:"container",layout:{type:"hbox",align:"stretch"},flex:1,defaults:{flex:1},items:[{xtype:"image",margin:"0 5 0 0",src:a.picture_host},{xtype:"image",margin:"0 0 0 5",src:a.picture_url}]}]},{xtype:"treepanel",bodyStyle:{borderTopWidth:0},rootVisible:false,useArrows:true,store:new Ext.data.TreeStore({root:{expanded:true,text:""},loadId:a.id,listeners:{beforeload:function(b){Ext.Ajax.request({method:"GET",url:"/system/term/syllabus/content-list/",params:{id:b.loadId},callback:function(i,h,j){var g=Ext.decode(j.responseText),d={},e,f,c;if(g.status!="success"){return}Ext.each(g.data.records,function(l){var n,k,m;if(!l){return}n=l.id;k=l.parent_id;if(k){m=d[k];if(!m){m=d[k]={id:k,expanded:true,children:[]}}m.children.push({text:l.title,id:n,seq:l.seq,leaf:true})}else{if(!d[n]){d[n]={text:l.title,id:n,seq:l.seq,expanded:true,children:[]}}else{d[n].seq=l.seq;d[n].text=l.title}}});f=function(l,k){if(l.seq<k.seq){return -1}else{if(l.seq>k.seq){return 1}}return 0};e=Ext.Object.getKeys(d);d=Ext.Array.map(e,function(l){d[l].children.sort(f);return d[l]});d.sort(f);c=b.getRootNode();c.removeAll();d.length&&c.appendChild(d)}});return false}}}),flex:1}];this.callParent()}});Ext.define("bbt.Lesson",{extend:"bbt.ManageGrid",alias:"widget.lesson2",fields:["uuid","name","types"],columns:[{xtype:"rownumberer",text:"序号",width:50},{text:"课程名称",dataIndex:"name",width:150},{text:"适用学校类型",width:120,dataIndex:"types",renderer:function(a){return typeof a=="string"?a:a.join("，")}}],pagination:true,showOperateColumn:true,tbar:[{text:"添加课程",action:"add",iconCls:"icon-add"},{text:"编辑课程",action:"edit",iconCls:"icon-edit"}],listUrl:"/system/new_lesson_name/list/",addUrl:"/system/new_lesson_name/add/",updateUrl:"/system/new_lesson_name/edit/",removeUrl:"/system/new_lesson_name/delete/",importUrl:"/system/new_lesson_name/import/",actionMap:{add:"addCourse",edit:"updateCourse",remove:"removeCourse"},operates:{remove:"删除"},canEdit:false,listeners:{show:function(){this.store.load()}},addCourse:function(){var b=this,a,c;a=Ext.apply(b.getCourseWindowConfig(),{title:"添加课程",buttons:[{text:"确定",handler:function(){var e=this.up("window"),d=e.down("form");if(!d.getForm().isValid()){return}b.request(b.addUrl,{form:d},{maskId:b.createMask(e,"正在添加课程"),success:function(f){b.store.reload();e.destroy()}})}},{text:"关闭",margin:"0 20",handler:function(){this.up("window").destroy()}}]});c=Ext.create("Ext.window.Window",a);c.show()},updateCourse:function(){var d=this,c,e,b,a;a=d.getSelectionModel().getSelection();if(!a.length){Ext.Msg.alert("提示","请先选择课程！");return}b=a[0];c=Ext.apply(d.getCourseWindowConfig(),{title:"编辑课程",buttons:[{text:"确定",handler:function(){var g=this.up("window"),f=g.down("form");if(!f.getForm().isValid()){Ext.Msg.alert("提示","请填写课程！");return}d.request(d.updateUrl,{uuid:b.get("uuid"),form:f},{form:f,maskId:d.createMask(g,"正在修改课程"),success:function(h){d.store.reload();g.destroy()}})}},{text:"关闭",margin:"0 20",handler:function(){this.up("window").destroy()}}]});e=Ext.create("Ext.window.Window",c);e.down("form").getForm().setValues(b.data);e.down("textfield").setReadOnly(true);e.show()},removeCourse:function(e){var d=this,c,b,a,f;b=d.getSelectionModel().getSelection();if(!b.length){Ext.Msg.alert("提示","请先选择课程！");return}c=b[0];f=function(){d.request(d.removeUrl,{uuid:c.get("uuid")},{success:function(){d.store.reload()},maskId:d.createMask(this,"正在删除课程")})};Ext.Msg.confirm("提示","删除课程将会影响班级授课教师信息，统计分析等，确认要删除吗？",function(g){g=="yes"&&new bbt.DangerOperate({onPass:f}).show()})},getCourseWindowConfig:function(){var a={modal:true,closable:false,width:350,layout:"fit",items:[{xtype:"form",border:false,margin:20,bodyCls:"no-bg",layout:"anchor",defaults:{anchor:"100%"},items:[{xtype:"textfield",fieldLabel:"课程名称",maxLength:20,allowBlank:false,name:"name",listeners:{blur:function(){var c=this.getValue(),b;b=c.replace(/[ 　]/g,"");if(b.length!=c.length){this.setValue(b)}}}},{xtype:"checkboxgroup",fieldLabel:"适用学校类型",columns:1,vertical:true,items:[{boxLabel:"小学",name:"types",inputValue:"小学",checked:true},{boxLabel:"初中",name:"types",inputValue:"初中",checked:true},{boxLabel:"高中",name:"types",inputValue:"高中",checked:true}]}]}],buttonAlign:"right"};return a}});Ext.define("bbt.ResourceType",{extend:"bbt.ManageGrid",alias:"widget.bbt_resource_type",tbar:[{text:"添加资源类型",action:"system_resource_add",iconCls:"icon-add"},{text:"删除资源类型",action:"system_resource_delete",iconCls:"icon-delete"}],columns:[{text:"资源类型",dataIndex:"value",width:380},{text:"备注",dataIndex:"remark",flex:1}],listeners:{show:function(){this.store.load()}},showOperateColumn:false,actionMap:{system_resource_add:"addResource",system_resource_delete:"deleteResource"},pagination:true,fields:["uuid","value","remark"],listUrl:"/system/resource/resource-type/",addUrl:"/system/resource/resource-type/add/",removeUrl:"/system/resource/resource-type/delete/",addResource:function(){var b=this,a,c;a=Ext.apply(b.getResourceWindowConfig(),{title:"添加资源类型",buttons:[{text:"确定",handler:function(){var e=this.up("window"),d=e.down("form");if(!d.getForm().isValid()){return}b.request(b.addUrl,{form:d},{maskId:b.createMask(e,"正在添加资源类型"),success:function(f){b.store.reload();e.destroy()}})}},{text:"关闭",margin:"0 20",handler:function(){this.up("window").destroy()}}]});c=Ext.create("Ext.window.Window",a);c.show()},editResource:function(){var d=this,b,e,c,a;a=d.getSelectionModel().getSelection();if(!a.length){Ext.Msg.alert("提示","请先选择资源类型！");return}c=a[0];b=Ext.apply(d.getResourceWindowConfig(),{title:"编辑资源类型",buttons:[{text:"确定",handler:function(){var g=this.up("window"),f=g.down("form");if(!f.getForm().isValid()){Ext.Msg.alert("提示","请填写资源类型！");return}apiRequest.target=g;apiRequest.msg="正在编辑资源类型："+c.get("value");apiRequest(d.updateUrl,{id:c.get("uuid"),form:f,waitTarget:g},function(h){c.set(h.data);c.commit();g.destroy()})}},{text:"关闭",margin:"0 20",handler:function(){this.up("window").destroy()}}]});e=Ext.create("Ext.window.Window",b);e.down("form").getForm().setValues(c.data);e.show()},deleteResource:function(){var d=this,b,e,c,a;a=d.getSelectionModel().getSelection();if(!a.length){Ext.Msg.alert("提示","请先选择资源类型！");return}c=a[0];d.request(d.removeUrl,{uuid:c.get("uuid")},{maskId:d.createMask(d,"正在删除资源类型："+c.get("value")),success:function(){d.store.reload()}})},refreshResource:function(){this.store.reload()},getResourceWindowConfig:function(){var a={modal:true,closable:false,width:350,height:250,layout:"fit",items:[{xtype:"form",border:false,margin:20,bodyCls:"no-bg",layout:"anchor",defaults:{anchor:"100%"},items:[{xtype:"textfield",fieldLabel:"资源类型",maxLength:20,allowBlank:false,name:"value"},{xtype:"textarea",height:95,name:"remark",maxLength:180,fieldLabel:"备注"}]}],buttonAlign:"right"};return a}});Ext.define("bbt.ResourceFrom",{extend:"bbt.ManageGrid",alias:"widget.bbt_resource_from",tbar:[{text:"添加资源来源",action:"system_resource_add",iconCls:"icon-add"},{text:"删除资源来源",action:"system_resource_delete",iconCls:"icon-delete"}],columns:[{text:"资源来源",dataIndex:"value",width:380},{text:"备注",dataIndex:"remark",flex:1}],listeners:{show:function(){this.store.load()}},showOperateColumn:false,actionMap:{system_resource_add:"addResource",system_resource_delete:"deleteResource"},pagination:true,fields:["uuid","value","remark"],listUrl:"/system/resource/resource-from/",addUrl:"/system/resource/resource-from/add/",removeUrl:"/system/resource/resource-from/delete/",addResource:function(){var b=this,a,c;a=Ext.apply(b.getResourceWindowConfig(),{title:"添加资源来源",buttons:[{text:"确定",handler:function(){var e=this.up("window"),d=e.down("form");if(!d.getForm().isValid()){return}b.request(b.addUrl,{form:d},{maskId:b.createMask(e,"正在添加资源来源"),success:function(f){b.store.reload();e.destroy()}})}},{text:"关闭",margin:"0 20",handler:function(){this.up("window").destroy()}}]});c=Ext.create("Ext.window.Window",a);c.show()},editResource:function(){var d=this,b,e,c,a;a=d.getSelectionModel().getSelection();if(!a.length){Ext.Msg.alert("提示","请先选择资源来源！");return}c=a[0];b=Ext.apply(d.getResourceWindowConfig(),{title:"编辑资源来源",buttons:[{text:"确定",handler:function(){var g=this.up("window"),f=g.down("form");if(!f.getForm().isValid()){Ext.Msg.alert("提示","请填写资源来源！");return}apiRequest.target=g;apiRequest.msg="正在编辑资源来源："+c.get("value");apiRequest(d.updateUrl,{id:c.get("uuid"),form:f,waitTarget:g},function(h){c.set(h.data);c.commit();g.destroy()})}},{text:"关闭",margin:"0 20",handler:function(){this.up("window").destroy()}}]});e=Ext.create("Ext.window.Window",b);e.down("form").getForm().setValues(c.data);e.show()},deleteResource:function(){var d=this,b,e,c,a;a=d.getSelectionModel().getSelection();if(!a.length){Ext.Msg.alert("提示","请先选择资源来源！");return}c=a[0];d.request(d.removeUrl,{uuid:c.get("uuid")},{maskId:d.createMask(d,"正在删除资源来源："+c.get("value")),success:function(){d.store.reload()}})},refreshResource:function(){this.store.reload()},getResourceWindowConfig:function(){var a={modal:true,closable:false,width:350,height:250,layout:"fit",items:[{xtype:"form",border:false,margin:20,bodyCls:"no-bg",layout:"anchor",defaults:{anchor:"100%"},items:[{xtype:"textfield",name:"value",allowBlank:false,fieldLabel:"资源来源",maxLength:50},{xtype:"textarea",height:95,maxLength:180,name:"remark",fieldLabel:"备注"}]}],buttonAlign:"right"};return a}});Ext.define("bbt.Resource",{extend:"Ext.tab.Panel",alias:"widget.bbt_resource",defaults:{border:false},items:[{title:"资源来源管理",xtype:"bbt_resource_from"},{title:"资源类型管理",xtype:"bbt_resource_type"}]});Ext.Object.each({province:"省",city:"地市州",country:"区县市",town:"乡镇",school:"学校"},function(b,c){var a=new Ext.data.Store({storeId:b+"Store",fields:["name","uuid","group_type","parent__uuid","children"],listeners:{load:function(d){d.insert(0,[{name:"所有"}])}}});bbt.ToolBox.register(b,{xtype:"combo",name:b+"_name",fieldLabel:c,labelWidth:c.length===1?20:45,width:100+(c.length===1?20:45),queryMode:"local",store:a,editable:false,displayField:"name",submitField:"name",valueField:"uuid",forceSelection:true,listeners:{afterrender:function(){var g=this,h="province city country town school".split(" "),e=g.name.replace("_name",""),f=Ext.Array.indexOf(h,e),d=Ext.Array.indexOf(h,bbt.UserInfo.level);if(d+1!==f){return}setTimeout(function(){g.setValue("")},300)},change:function(h,j){var k=["province","city","country","town","school"],g=h.name.replace("_name",""),l=false,e,i,f,d;Ext.each(k,function(m){var n;if(l){n=h.ownerCt.down("[name="+m+"_name]");if(n){n.store.loadData([{name:"所有"}]);n.setValue("")}}if(m===g){l=true}});if(!j){d=h.ownerCt.ownerCt;e=d.down("[name=grade_name]");if(e){e.store.loadData([{name:"所有"}]);e.setValue("")}e=d.down("[name=lesson_period]");if(e){e.store.loadData([{sequence:"所有"}]);e.setValue("")}e=d.down("[name=lesson_name]");if(e){e.store.loadData([{name:"所有"}]);e.setValue("所有")}}else{if(g=="school"){d=h.ownerCt.ownerCt;e=d.down("[name=grade_name]");e&&e.store.load();e=d.down("[name=lesson_period]");e&&e.store.load();e=d.down("[name=lesson_name]");e&&e.store.load()}else{i=h.findRecordByValue(j);i&&(i=i.raw.children);if(i){f=k[Ext.Array.indexOf(k,g)+1];f=h.ownerCt.down("[name="+f+"_name]");if(f){f.store.loadData(i);f.store.fireEvent("load",f.store)}}}}}}})});bbt.loadGroup();Ext.define("bbt.NodeManager",{extend:"bbt.ManageGrid",alias:"widget.bbt_nodemanager",columns:[{text:"服务器名称",dataIndex:"name",width:200},{text:"服务器密钥",dataIndex:"communicate_key",width:150},{text:"同步 ID",width:60,dataIndex:"last_upload_id"},{text:"状态",width:40,dataIndex:"sync_status"},{text:"最后同步时间",width:150,dataIndex:"last_upload_time"},{text:"最后连接时间",width:150,dataIndex:"last_active_time"},{text:"版本",width:40,dataIndex:"db_version"},{text:"备注",dataIndex:"remark",width:200}],viewConfig:{enableTextSelection:true},pagination:true,showOperateColumn:true,tbar:[{text:"添加",action:"system_node_add",iconCls:"icon-add"},{text:"删除",action:"system_node_delete",iconCls:"icon-delete"}],fields:["id","name","host","communicate_key","remark","last_upload_id","last_active_time","last_upload_time","db_version","sync_status"],listUrl:"/system/node/list/",exportUrl:"/system/node/backup/",addUrl:"/system/node/add/",removeUrl:"/system/node/delete/",updateUrl:"/system/node/edit/",operates:{},actionMap:{system_node_add:"addNode",system_node_delete:"deleteNode",unbind:"unbindNode","export":"exportNode"},listeners:{show:function(){this.store.load()}},addNode:function(){var b=this,a,c;a=Ext.apply(b.getNodeWindowConfig(),{title:"添加节点",buttons:[{text:"确定",handler:function(){var f=this.up("window"),d=f.down("form"),e;e=checkForm(d);if(e!==true){return}b.request(b.addUrl,{form:d},{maskId:b.createMask(f,"正在添加节点"),success:function(g){b.store.reload();f.destroy()}})}},{text:"关闭",margin:"0 20 0 0",handler:function(){this.up("window").destroy()}}]});c=Ext.create("Ext.window.Window",a);c.show()},editNode:function(){var d=this,b,e,c,a;a=d.getSelectionModel().getSelection();if(!a.length){Ext.Msg.alert("提示","请先选择节点！");return}c=a[0];b=Ext.apply(d.getNodeWindowConfig(),{title:"编辑节点",buttons:[{text:"确定",handler:function(){var h=this.up("window"),f=h.down("form"),g;g=checkForm(f);if(g!==true){return}d.request(d.updateUrl,{id:c.get("id"),form:f},{maskId:d.createMask(h,"正在修改节点"),success:function(i){c.set(i.data);c.commit();h.destroy()}})}},{text:"关闭",handler:function(){this.up("window").destroy()}}]});e=Ext.create("Ext.window.Window",b);e.down("form").getForm().setValues(c.data);e.show()},deleteNode:function(){var c=this,b,a,d;a=c.getSelectionModel().getSelection();if(!a.length){Ext.Msg.alert("提示","请先选择节点！");return}b=a[0];Ext.Msg.confirm("提示","删除节点将清空该节点下所有数据，是否确定删除？",function(e){if(e!="yes"){return}if(b.get("last_upload_id")>0){new bbt.DangerOperate({onPass:d}).show()}else{d()}});d=function(){c.request(c.removeUrl,{id:b.get("id")},{maskId:c.createMask(c,"正在删除节点数据……"),method:"POST",success:function(){c.store.reload()}})}},exportNode:function(a,c){var b=this;b.request(b.exportUrl,{id:c.get("id")},{method:"GET",maskId:b.createMask(b,"正在准备数据……"),success:function(e,d){downloadFile(d.url,"")}})},getNodeWindowConfig:function(){var a={width:350,modal:true,closable:false,resizable:false,layout:"fit",items:[{xtype:"form",bodyCls:"no-bg",border:false,layout:"anchor",padding:20,defaults:{labelWidth:75,anchor:"100%",allowBlank:false},items:[{xtype:"textfield",name:"name",fieldLabel:"学校名称",hidden:(bbt.UserInfo.level!=="country"),disabled:(bbt.UserInfo.level!=="country")},{xtype:"panel",border:false,bodyCls:"no-bg",layout:"hbox",margin:"0 0 5 0",items:[{xtype:"textfield",labelWidth:75,name:"communicate_key",fieldLabel:"密钥",readOnly:true,validator:function(b){return/^[0-9A-F]{16}$/.test(b)?true:"只能填写16位数字或大写字母ABCDEF，不可为空"}},{xtype:"button",margin:"0 0 0 15",text:"自动生成",handler:function(){var f="0123456789ABCDEF",g=new Date().getTime()+"",b=g.length,e=0,c=[],d;for(;e<b;e++){d=parseInt(g.charAt(e))*(Math.random()>0.5?1:-1);if(d<0){d=16+d}c.push(f.charAt(d))}this.up("panel").down("textfield").setValue(c.join("")+"222")}}]},{xtype:"textarea",name:"remark",maxLength:180,height:50,fieldLabel:"备注",allowBlank:true}]}]};return a}});Ext.define("bbt.LoginStatus",{extend:"Ext.view.View",alias:"widget.loginstatus",autoScroll:true,tpl:['<tpl for=".">','<div class="class-item">','<div class="status-icon {cls}">',"</div>",'<div class="class-info">{info}</div>',"</div>","</tpl>",'<div style="clear:both;height:15px;"></div>'],constructor:function(){var a=new Ext.data.Store({fields:["grade_name","class_name","lesson_name","online","login_time"],proxy:{url:"/global/login-status/",type:"ajax",reader:{type:"json",root:"data.records",totalProperty:"data.record_count"}}});this.store=a;a.load();this.callParent()},prepareData:function(c,b,a){var d=Ext.String.format("{0}年级{1}班<br/>{2}<br/>已使用{3}分钟",c.grade_name,c.class_name,c.lesson_name,Math.floor(c.login_time/60));c.online||(c.cls="offline");c.info=d;return c}});Ext.define("bbt.LoginStatusPanel",{extend:"Ext.panel.Panel",alias:"widget.loginstatuspanel",tbar:[{xtype:"tbtext",text:"当前不在上课!",style:{fontWeight:"bold"}}],items:[{xtype:"loginstatus"}],layout:"fit",listeners:{afterrender:function(){var a=this.down("loginstatus"),b=a.store;b.on("load",function(c){try{var f=c.proxy.reader.rawData;this.updateJieci(f.status=="success"?f.data.lesson_period:f.msg)}catch(d){console.log(d)}},this);this.store=b}},updateJieci:function(a){var b;if(typeof a=="string"){b="当前不在上课!";return}else{if(a){b=Ext.String.format("当前节次：第{0}节    节次时间：{1}-{2}",a.sequence,a.start_time,a.end_time)}else{b="当前不在上课!"}}this.down("toolbar[dock=top]").down("tbtext").setText(b)},setTreeStyle:function(){var b=Ext.getCmp("content-panel").down("treepanel"),a;b.on("itemcollapse",function(d){var c=this.getView().getNode(d);c=Ext.fly(c);c.down(".x-grid-cell-inner").setStyle({backgroundColor:"#FFF",cursor:"default"})});b.on("itemexpand",function(d){var c=this.getView().getNode(d);c=Ext.fly(c);c.down(".x-grid-cell-inner").setStyle({backgroundColor:"#FFF",cursor:"default"})});a=function(){b.getRootNode().cascadeBy(function(d){var c;if(d.raw.group_type!="school"){c=b.getView().getNode(d);if(c){c=Ext.fly(c);c.down(".x-grid-cell-inner").setStyle({backgroundColor:"#FFF",cursor:"default"})}}});b.un("load",a)};if(b.isStoreLoaded){a()}else{b.on("load",a)}},onLevelChange:function(a,b){if(a!="school"){return}this.store.load({params:{uuid:b}})}})}Ext.define("bbt.UserManager",{extend:"bbt.ManageGrid",alias:"widget.bbt_usermanager",fields:["role__name","created_at","permitted_groups","remark","email","level","mobile","qq","password","password_confirmation","role","sex","status","username","realname","uuid"],listUrl:"/system/user/list/",removeUrl:"/system/user/delete/",updateUrl:"/system/user/edit/",addUrl:"/system/user/add/",showOperateColumn:false,checkPrivilegeOnAction:true,pagination:true,sorters:[{property:"username",direction:"ASC"}],columns:[{text:"用户名",dataIndex:"username"},{text:"所属角色",dataIndex:"role__name"},{text:"真实姓名",dataIndex:"realname"},{text:"性别",dataIndex:"sex",renderer:function(a){return{male:"男",female:"女"}[a]}},{text:"QQ",dataIndex:"qq"},{text:"手机",dataIndex:"mobile"},{text:"电子邮箱",dataIndex:"email"},{text:"状态",dataIndex:"status",renderer:function(a){return{active:"激活",suspended:"停用"}[a]}},{text:"备注",dataIndex:"remark",flex:1}],tbar:[{text:"添加用户",action:"system_user_add",icon:"/public/images/user_add.png"},{text:"编辑用户",action:"system_user_edit",icon:"/public/images/user_edit.png"},{text:"删除用户",action:"system_user_delete",icon:"/public/images/user_delete.png"},{text:"刷新",action:"refresh",iconCls:"icon-refresh"}],actionMap:{system_user_add:"addUser",system_user_edit:"editUser",system_user_delete:"deleteUser",refresh:"refreshUser"},listeners:{show:function(){this.store.load()}},checkPassword:function(b,a,c){if(arguments.length===1){a="password",c="password_confirmation"}b.xtype==="form"&&(b=b.getForm());var e=b.findField(a).getValue();var d=b.findField(c).getValue();return e===d},addUser:function(){var b=this,a,c;a=Ext.apply(b.getUserWindowConfig(),{buttons:[{text:"保存",handler:function(){var h=this.up("window"),f=h.down("form"),e,d,g,i;g=b.checkForm(f);if(g!==true){return}if(!b.checkPassword(f)){Ext.Msg.alert("提示","密码与确认密码不一致！");return}e=h.down("treepanel");d=b.getGroups(e);if(!d){Ext.Msg.alert("提示","管理范围必须选择",function(){e.up("fieldset").getEl().highlight("#F22",{duration:2000})});return}i=f.getForm().findField("permitted_groups");i.setValue(i.getValue()+","+d);b.request(b.addUrl,{form:f},{success:function(j){b.store.reload();h.destroy()},maskId:b.createMask(h,"正在添加用户")})}},{text:"关闭",margin:"0 10 0 20",handler:function(){this.up("window").destroy()}}]});c=Ext.create("Ext.window.Window",a);c.show();setTimeout(function(){b.initUserWindowEvents(c,"add")},1)},editUser:function(){var e=this,c,f,b,a,d;a=e.getSelectionModel().getSelection();if(!a.length){Ext.Msg.alert("提示","请先选择用户！");return}b=a[0];c=Ext.apply(this.getUserWindowConfig(),{buttons:[{text:"保存",handler:function(){var k=this.up("window"),i=k.down("form"),h,g,j,l;j=checkForm(i);if(j!==true){return}if(!checkPassword(i)){Ext.Msg.alert("提示","密码与确认密码不一致！");return}tree=k.down("treepanel");g=e.getGroups(tree);if(!g){Ext.Msg.alert("提示","管理范围必须选择",function(){tree.up("fieldset").getEl().highlight("#F22",{duration:2000})});return}l=i.getForm().findField("permitted_groups");l.setValue(l.getValue()+","+g);e.request(e.updateUrl,{uuid:b.get("uuid"),form:i},{maskId:e.createMask(k,"正在修改用户"),success:function(m){b.set(m.data);b.commit();k.destroy()}})}},{text:"关闭",margin:"0 10 0 20",handler:function(){this.up("window").destroy()}}]});f=Ext.create("Ext.window.Window",c);e.getUserDetail(b.get("uuid"),function(i){var h={},g,j;Ext.each(i.permitted_groups,function(k){h[k.group__name]=""});g=f.down("treepanel");g.userGroups=h;g.selectUserGroups&&g.selectUserGroups();f.show();j=f.down("form").getForm();j.setValues(i.user);j.findField("password").setValue("")});f.setTitle("编辑用户");this.initUserWindowEvents(f,"edit")},deleteUser:function(){var d=this,c,e,b,a;a=d.getSelectionModel().getSelection();if(!a.length){Ext.Msg.alert("提示","请先选择用户！");return}b=a[0];d.request(d.removeUrl,{uuid:b.raw.uuid},{maskId:d.createMask(d,"正在删除用户"),success:function(){d.store.reload()}})},refreshUser:function(){this.store.reload()},initUserWindowEvents:function(e,d){var b=e.down("treepanel"),c;if(d=="add"){e.down("textfield[name=password]").on("keyup",function(){var f=this.getValue(),g=this.up("form").down("textfield[name=password]").getValue();if(!g){return}if(f!=g){this.markInvalid("密码与确认密码不一致")}});e.down("[name=password_confirmation]").on("keyup",function(){var f=this.getValue(),g=this.up("form").down("textfield[name=password]").getValue();if(f!=g){this.markInvalid("密码与确认密码不一致")}})}else{if(d=="edit"){e.down("combo[name=role]").allowBlank=true;e.down("textfield[name=password]").allowBlank=true;e.down("textfield[name=password_confirmation]").allowBlank=true}}if(!b){return}Ext.apply(b,{makeCurrentRoot:function(){var i=bbt.UserInfo.level,f=this.getRootNode(),g=f.getChildAt(0),h=[];while(g.raw.group_type!=i){h.push(g.raw.uuid);g=g.getChildAt(0)}this.walk(g.childNodes,function(j){j.set("checked",false)});g.set("checked",true);this.setGroup(h,true);f.removeAll();f.appendChild(g);d=="edit"&&this.selectUserGroups()},setGroup:function(h,f){if(Ext.isArray(h)){h=h.join(",")}var g=this.up("window").down("hidden[name=permitted_groups]");if(g){if(f){g.setValue(h)}else{g.setValue(g.getValue()+","+h)}}},walk:function(h,f){var g=this;if(!Ext.isArray(h)){h=[h]}Ext.each(h,function(i){f(i);!i.leaf&&Ext.each(i.childNodes,function(j){g.walk(j,f)})})},selectUserGroups:function(){var f=this.userGroups;if(!f){return}this.walk(this.getRootNode(),function(g){if(g.get("text") in f){g.set("checked",true)}})},filterNodes:function(g,i,f){var h=this.compareLevel;i=i||bbt.UserInfo.level,f=f||{};this.walk(g,function(j){switch(h(j.group_type,i)){case 1:j.checked=null;break;case 0:j.checked=(j.uuid in f);break;case -1:j.checked=(j.uuid in f);break}});return g},closest:function(f,h){var g=f;while(g&&g.raw.group_type!==h){g=g.parentNode}return g},unSelectNodes:function(g){if(g.get("checked")){g.set("checked",false)}var f=arguments.callee;!g.get("leaf")&&g.eachChild(f)},selectNodesByLevel:function(g,i){var f=function(k,j){j(k);!k.get("leaf")&&k.eachChild(function(l){f(l,j)})},h=[];f(g,function(j){if(j.raw.group_type===i){h.push(j)}});return h},selectParent:function(f){var g=f.parentNode;while(g){g.set("checked",true);g=g.parentNode}},hideParent:function(g,l){var h=this.selectNodesByLevel(g,l),j,f,k;for(j=0,f=h.length;j<f;j++){k=h[j].parentNode;while(k){k.set("hidden",true);k=k.parentNode}}},unSelectParent:function(g,l){var h=this.selectNodesByLevel(g,l),j,f,k;for(j=0,f=h.length;j<f;j++){k=h[j].parentNode;while(k){k.set("checked",false);k=k.parentNode}}},fixSelected:function(){var h=this,f=h.down("treepanel"),g;if(!f){return}g=h.selectNodesByLevel(f.getRootNode(),bbt.UserInfo.level);Ext.each(g,function(i){if(i.get("checked")){h.selectParent(i);return false}})},compareLevel:function(h,f){var g=["province","city","country","town","school","grade"],j,i;j=Ext.Array.indexOf(g,h);i=Ext.Array.indexOf(g,f);if(!~j||!~i){return 1}if(j<i){return 1}else{if(j===i){return 0}else{if(j>i){return -1}}}}});c=function(){b.makeCurrentRoot();b.store.un("load",c)};if(b.store.isLoading()){b.store.on("load",c)}else{b.makeCurrentRoot()}b.on("checkchange",function(f,g){var h=bbt.UserInfo.level;if(f.raw.group_type==h){f.set("checked",true);return}if(g){f.bubble(function(i){i.set("checked",true)})}f.cascadeBy(function(i){i.set("checked",g)})});var a=e.down("form").getForm().getFields();a.each(function(g){g.isValid()||g.reset()})},getUserWindowConfig:function(){var b=new Ext.data.TreeStore({autoLoad:true,loading:true,listeners:{beforeload:function(e){var d=function(i,h,l){var j,g,f;try{j=Ext.decode(l.responseText);if(j.status=="success"){j.data.grade=[];g=bbt.utils.parseGroupData(j.data);f=e.getRootNode();f.removeAll();g=f.appendChild(g);e.fireEvent("load",e);e.loading=false}}catch(k){}};Ext.Ajax.request({url:"/group/",callback:d});return false}}}),c=new Ext.data.Store({fields:["uuid","name"],autoLoad:true,proxy:{type:"ajax",url:"/system/role/list/",reader:{type:"json",root:"data.records",totalProperty:"data.record_count"}}}),a;a={width:650,height:380,modal:true,closable:false,resizable:false,title:"添加用户",layout:"fit",items:[{xtype:"form",bodyCls:"no-bg",border:false,layout:{type:"hbox",align:"stretch",padding:10},items:[{xtype:"fieldset",bodyCls:"no-bg",title:"用户信息",flex:2,layout:{type:"vbox",align:"stretch"},items:[{xtype:"panel",border:false,bodyCls:"no-bg",layout:{type:"hbox",align:"stretch"},defaults:{flex:1,border:false,bodyCls:"no-bg"},defaultType:"panel",items:[{margin:"0 2 0 0",layout:{type:"vbox",align:"stretch"},defaultType:"textfield",defaults:{margin:"5 1",labelWidth:60},items:[{fieldLabel:"用户名",maxLength:20,name:"username",allowBlank:false},{fieldLabel:"真实姓名",maxLength:100,name:"realname"},{fieldLabel:"登录密码",maxLength:128,inputType:"password",name:"password",enableKeyEvents:true,allowBlank:false},{fieldLabel:"手机",maxLength:20,name:"mobile"},{fieldLabel:"QQ",maxLength:20,name:"qq"}]},{margin:"0 0 0 2",layout:{type:"vbox",align:"stretch"},defaultType:"textfield",defaults:{margin:"5 1",labelWidth:60},items:[{fieldLabel:"所属角色",name:"role",allowBlank:false,editable:false,displayField:"name",valueField:"uuid",store:c,queryMode:"local",xtype:"combo",listeners:{boxready:function(){var g=this,e=g.store,f,d=g.value;f=function(){g.setValue(undefined);g.setValue(d);e.un("load",f)};if(d&&e.isLoading()){e.on("load",f)}}}},{fieldLabel:"性别",name:"sex",maxLength:20,value:"male",store:[["male","男"],["female","女"]],editable:false,xtype:"combo"},{fieldLabel:"重复密码",inputType:"password",name:"password_confirmation",enableKeyEvents:true,maxLength:128,allowBlank:false},{fieldLabel:"电子邮箱",maxLength:200,name:"email"},{fieldLabel:"状态",store:[["active","激活"],["suspended","停用"]],value:"active",queryMode:"local",name:"status",editable:false,xtype:"combo"},{xtype:"hidden",name:"level",value:bbt.UserInfo.level}]}]},{margin:"8 0 0 0",labelWidth:60,xtype:"textareafield",fieldLabel:"备注",maxLength:180,name:"remark"},{xtype:"hidden",name:"permitted_groups"}]},{xtype:"fieldset",title:"管理范围",area:true,flex:1,margin:"0 0 0 10",layout:"fit",items:[{xtype:"treepanel",autoScroll:true,bodyCls:"no-bg",overflowY:"auto",rootVisible:false,store:b}]}]}],buttonAlign:"right"};return a},getGroups:function(c){var b=[],a;a=function(d){if(d.get("checked")){b.push(d.raw.uuid)}if(!d.isLeaf()){d.eachChild(a)}};c.getRootNode().eachChild(a);return b.join(",")},getUserDetail:function(b,a){this.request("/system/user/detail/",{uuid:b},{method:"GET",success:a})},setGroups:function(d,f,b){var a={},c,e;this.getGroupDetails(function(g){b&&b(g,a)});if(f.permitted_groups&&f.permitted_groups.length){Ext.each(f.permitted_groups,function(h){a[h.group]=""})}},_edit:function(c){var f=this,d,g,b,e,a;a=function(h){var i=typeof h=="string"?g.down(h):i;if(i){i.ownerCt.remove(i)}};d=Ext.apply(this.getUserWindowConfig(),{buttons:[{text:"保存",handler:function(){var l=this.up("window"),j=l.down("form"),i,h,k;k=checkForm(j);if(k!==true){return}if(!checkPassword(j)){Ext.Msg.alert("提示","密码与确认密码不一致！");return}apiRequest.target=l;apiRequest.msg="正在修改信息";apiRequest("/update_details/",{id:c.get("uuid"),form:j},function(){l.destroy()})}},{text:"关闭",handler:function(){this.up("window").destroy()}}]});g=Ext.create("Ext.window.Window",d);g.setTitle("用户信息");a("[area]");a("combo[name=status]");a("combo[name=level]");g.down("textfield[name=username]").setReadOnly(true);g.down("combo[name=role]").setReadOnly(true);g.setWidth(Math.round(g.width*0.67));e=g.down("form").getForm();e.getFields().each(function(h){h.allowBlank=true});e.setValues(c.data);e.findField("password").setValue("");e.findField("role").setValue(c.raw.role_name);this.initUserWindowEvents(g,"edit");g.show()},statics:{editCurrentUser:function(){Ext.Ajax.request({url:"/details/",success:function(c){var b=Ext.decode(c.responseText);if(b.status=="success"){var a=new bbt.UserManager();a.store.removeAll();a.store.add(b.data);a._edit(a.store.first())}},failure:function(a){Ext.Msg.alert("提示",getErrorMsg(decodeResponse(a)))}})}}});Ext.define("Privilege",{extend:"Ext.data.Model",fields:["name","key","privileges"]});Ext.create("Ext.data.TreeStore",{storeId:"PrivilegeTreeStore",model:"Privilege",autoLoad:false,root:{text:"所有权限",expanded:true,children:[{text:"loading",leaf:true}]},proxy:{url:"/privileges/",type:"ajax",reader:{type:"json",root:"data"}},listeners:{load:function(a,c){var b=function(d){if(d.get("checked")===null){d.set("checked",false)}if(d.get("name")){d.set("text",d.get("name"))}if(d.get("privileges")){d.appendChild(d.get("privileges"));d.set("privileges",null);d.set("leaf",false)}else{d.set("leaf",true)}if(!d.isLeaf()){d.eachChild(b)}};c.eachChild(b)}}});Ext.define("bbt.RoleManager",{extend:"bbt.ManageGrid",alias:"widget.bbt_rolemanager",columns:[{text:"角色名称",dataIndex:"name",width:140},{text:"备注",dataIndex:"remark",flex:9}],pagination:true,tbar:[{text:"添加角色",action:"system_role_add",iconCls:"icon-add"},{text:"编辑角色",action:"system_role_edit",iconCls:"icon-edit"},{text:"删除角色",action:"system_role_delete",iconCls:"icon-delete"},{text:"刷新",action:"refresh",iconCls:"icon-refresh"}],fields:["uuid","name","remark"],listUrl:"/system/role/list/",addUrl:"/system/role/add/",updateUrl:"/system/role/edit/",removeUrl:"/system/role/delete/",detailUrl:"/system/role/detail/",showOperateColumn:false,actionMap:{system_role_add:"addRole",system_role_edit:"editRole",system_role_delete:"deleteRole",refresh:"refreshRole"},listeners:{show:function(){this.store.load()}},addRole:function(){var b=this,a,c;a=Ext.apply(this.getRoleWindowConfig(),{buttons:[{text:"保存",handler:function(){var g=this.up("window"),e=g.down("form"),d,f;f=checkForm(e);if(f!==true){return}e.getForm().findField("privileges").setValue(b.getPrivileges(g.down("treepanel").store));b.request(b.addUrl,{form:e},{maskId:b.createMask(g,"正在添加角色"),success:function(h){b.store.reload();g.destroy()}})}},{text:"关闭",margin:"0 10 0 20",handler:function(){this.up("window").destroy()}}]});c=Ext.create("Ext.window.Window",a);this.initRoleWindowEvents(c);c.show()},editRole:function(){var c=this,b,d,e,a;a=c.getSelectionModel().getSelection();if(!a.length){Ext.Msg.alert("提示","请先选择角色！");return}e=a[0];b=Ext.apply(this.getRoleWindowConfig(),{buttons:[{text:"保存",handler:function(){var i=this.up("window"),g=i.down("form"),f,h;h=checkForm(g);if(h!==true){return}g.getForm().findField("privileges").setValue(c.getPrivileges(i.down("treepanel").store));c.request(c.updateUrl,{uuid:e.get("uuid"),form:g},{maskId:c.createMask(i,"正在修改角色"),success:function(j){e.set(j.data);e.commit();i.destroy()}})}},{text:"关闭",margin:"0 10 0 20",handler:function(){this.up("window").destroy()}}]});d=Ext.create("Ext.window.Window",b);d.setTitle("编辑角色");d.down("form").getForm().setValues(e.data);this.initRoleWindowEvents(d);d.show();c.request(c.detailUrl,{uuid:e.get("uuid")},{method:"GET",success:function(g){var f=d.down("treepanel");f.myPrivileges=g.privilege;f.allPrivileges&&f.markPrivileges()}})},refreshRole:function(){this.store.reload()},deleteRole:function(){var c=this,b,d,e,a;a=c.getSelectionModel().getSelection();if(!a.length){Ext.Msg.alert("提示","请先选择角色！");return}e=a[0];c.request(c.removeUrl,{uuid:e.get("uuid")},{maskId:c.createMask(c,"正在删除角色"),success:function(){c.store.reload()}})},getRoleWindowConfig:function(){var a={width:570,closable:false,modal:true,title:"添加角色",items:[{xtype:"form",height:250,padding:10,bodyCls:"no-bg",border:false,layout:{type:"hbox",align:"stretch"},items:[{xtype:"fieldset",flex:4,bodyCls:"no-bg",title:"角色基本信息",layout:{type:"vbox",align:"stretch"},defaults:{labelWidth:80},items:[{xtype:"textfield",fieldLabel:"角色名称",maxLength:100,name:"name",allowBlank:false},{margin:"8 0 0 0",flex:9,xtype:"textareafield",maxLength:180,fieldLabel:"备注",name:"remark"},{xtype:"hidden",name:"privileges"}]},{xtype:"fieldset",bodyCls:"no-bg",margin:"0 0 0 10",title:"角色权限",layout:"fit",flex:4,items:[{xtype:"treepanel",bodyCls:"no-bg",overflowY:"auto",rootVisible:false,store:"PrivilegeTreeStore",myPrivileges:null,allPrivileges:null,markPrivileges:function(){var c={},b=this.allPrivileges;Ext.each(this.myPrivileges,function(d){c[d.privilege]=""});walk=function(d){if(d.get("key") in c){d.set("checked",true)}d.eachChild(walk)};Ext.each(b,walk)},listeners:{afterrender:function(){var b=this;this.store.reload({callback:function(c){b.allPrivileges=c;if(b.myPrivileges){b.markPrivileges()}}})}}}]}]}],buttonAlign:"right"};return a},initRoleWindowEvents:function(c,b){var a=c.down("treepanel");a.on("checkchange",function(d,e){if(e){d.bubble(function(f){f.set("checked",true)})}d.cascadeBy(function(f){f.set("checked",e)})});a.on("afterrender",function(){var d=function(e){e.set("checked",false);if(!e.isLeaf()){e.eachChild(d)}};this.store.getRootNode().eachChild(d)})},getPrivileges:function(c){var b=[],a;a=function(d){if(d.get("checked")){b.push(d.get("key"))}if(!d.isLeaf()){d.eachChild(a)}};c.getRootNode().eachChild(a);b=b.join(",");if(b.indexOf("general_statistic")===-1){b+=",general_statistic"}return b},getRoleDetail:function(c,b,a){bbt.request("/system/role/detail/",{uuid:c.get("uuid")},a)},setPrivileges:function(b,e){var a={},c,f="no",d="yes";Ext.each(e,function(g){a[g]=""});c=function(i){var g=0,h=0;if(i.get("key") in a){if(i.isLeaf()){i.set("checked",true);return d}}else{return f}i.eachChild(function(j){if(d===c(j)){g++}h++});if(g===h){i.set("checked",true);return d}else{return f}};b.getRootNode().eachChild(c)}});Ext.define("bbt.SystemSettings",{extend:"Ext.window.Window",alias:"widget.bbt_setting",getDetails:function(){var a=this;apiRequest.msg="正在修改系统设置";apiRequest.target=a;apiRequest("/system/sync_server/list/",{},function(c){var b=a.down("form").getForm();Ext.each(c.data,function(d){var e=b.findField(d.name.replace("sync_server_",""));e&&e.setValue(d.value)})})},initComponent:function(){Ext.apply(this,this.getPopConfig());this.callParent();this.show();this.getDetails()},getPopConfig:function(){var a={title:"上级服务器设置",resizable:false,closable:false,modal:true,width:450,layout:"fit",items:[{xtype:"form",bodyCls:"no-bg",layout:{type:"vbox",align:"center",pack:"center"},defaultType:"textfield",defaults:{width:320},border:false,items:[{fieldLabel:"IP 地址",name:"host",margin:"40 0 0 0",validator:function(b){var c=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,d;if(!b){return"IP地址不可为空！"}if(~b.indexOf(":")){d=b.split(":");d[1]=parseInt(d[1]);return c.test(d[0])&&!isNaN(d[1])&&d[1]>=0&&d[1]<65536||msg}else{return c.test(b)||"错误的IP地址！"}}},{margin:"10 0",fieldLabel:"端口号",name:"port",value:bbt.UserInfo.level=="country"?"8000":"",emptyText:"不可为空",allowBlank:false,validator:function(b){var c=/^\d+$/.test(b);if(!b){return"端口号不可为空！"}if(c){b=parseInt(b);return(b>=0&&b<=65535)?true:msg}return"错误的端口号！"}},{fieldLabel:"密钥",name:"key",invalidText:"只能填写16位数字或大写字母ABCDEF",margin:"0 0 40 0",allowBlank:false,regex:/^[0-9A-F]{16}$/}]}],buttonAlign:"center",buttons:[{xtype:"button",text:"确定",margin:"0 10 10 10",handler:function(){var c=this.up("window"),b=c.down("form"),d;d=checkForm(b);if(d!==true){return}b=b.getForm();b.waitTarget=c;b.submit({url:"/system/sync_server/add/",waitMsg:"正在提交数据……",success:function(e,g){var f=g.result;if(f.status=="success"){Ext.Msg.alert("提示",f.msg,function(){c.destroy()})}}})}},{xtype:"button",margin:"0 10 10 10",text:"关闭",handler:function(){this.up("window").destroy()}}]};return a}});Ext.define("bbt.DesktopPreviewSettings",{extend:"Ext.window.Window",alias:"widget.preview_settings",getDetails:function(){var a=this;apiRequest.msg="loading ...";apiRequest.target=a;apiRequest("/system/desktop-preview/get/",{},function(c){var b=a.down("form").getForm();Ext.each(c.data.records,function(d){var e=b.findField(d.name);if(e&&d.value){e.setValue(d.value)}})})},initComponent:function(){Ext.apply(this,this.getPopConfig());this.callParent();this.show();this.getDetails()},getPopConfig:function(){var a={title:"桌面预览设置",resizable:false,closable:false,modal:true,width:400,layout:"fit",items:[{xtype:"form",margin:30,layout:"anchor",defaults:{anchor:"100%",labelWidth:140},bodyCls:"no-bg",border:false,items:[{xtype:"numberfield",name:"desktop-preview-interval",fieldLabel:"截屏时间间隔（分钟）",value:5,minValue:5,maxValue:10,editable:false},{xtype:"numberfield",name:"desktop-preview-days-to-keep",fieldLabel:"记录保存时间（天）",value:150,minValue:10,maxValue:150,editable:false},{xtype:"combo",name:"cloud-service-provider",fieldLabel:"云存储服务商",store:["upyun"],value:"upyun",editable:false},{xtype:"textfield",name:"cloud-service-username",fieldLabel:"云存储用户名",maxLength:100,allowBlank:false,enableKeyEvents:true,listeners:{keydown:function(){if(this._fired){return}var b=this.ownerCt.down("[name=cloud-service-password]");b.setValue("");this._fired=true}}},{xtype:"textfield",name:"cloud-service-password",inputType:"password",fieldLabel:"云存储密码",maxLength:100,allowBlank:false}]}],buttonAlign:"center",buttons:[{xtype:"button",text:"确定",margin:"0 10 10 10",handler:function(){var e=this.up("window"),b=e.down("form"),f,d,c;f=checkForm(b);if(f!==true){return}b=b.getForm();b.waitTarget=e;d=function(){b.submit({url:"/system/desktop-preview/verify/",waitMsg:"正在提交数据……",success:function(g,i){var h=i.result;if(h.status=="success"){c()}},failure:function(g,h){Ext.Msg.alert("提示",h.result.msg)}})};c=function(){b.submit({url:"/system/desktop-preview/set/",waitMsg:"正在提交数据……",success:function(g,i){var h=i.result;if(h.status=="success"){Ext.Msg.alert("提示",h.msg,function(){e.destroy()})}}})};d()}},{xtype:"button",margin:"0 10 10 10",text:"关闭",handler:function(){this.up("window").destroy()}}]};return a}});Ext.define("bbt.AssetView",{extend:"Ext.view.View",alias:"widget.assetview",itemMaxWidth:340,itemMaxHeight:225,itemMaxImage:128,itemMinWidth:165,itemMinHeight:109,itemMinImage:64,MaxMode:"max",MinMode:"min",mode:"A",isSchool:bbt.UserInfo.isSchool(),constructor:function(){var b=Ext.create("Ext.data.Store",{fields:["uuid","name","icon","unit_name","unit_count"],proxy:{url:this.isSchool?"/asset/asset-type/":"/asset/asset-type/aggregate/",type:"ajax",reader:{type:"json",root:"data.records",totalProperty:"data.record_count"}},pageSize:100}),a;b.load();this.store=b;if(this.displayMode!=this.MinMode){this.displayMode=this.MaxMode}this.addEvents("assetpici","assetaddreport","assetstop","assettypeadd");this.listeners={afterrender:function(){var c=this.getEl();c.on("mouseover",function(d){Ext.get(d.target).addCls(["x-over","x-btn-over","x-btn-default-small-over"])},undefined,{delegate:"a.x-btn[action]"});c.on("mouseout",function(d){Ext.get(d.target).removeCls(["x-over","x-btn-over","x-btn-default-small-over"])},undefined,{delegate:"a.x-btn[action]"})},itemmouseenter:function(m,c,n,h,j){if(m.isEditing(n)){return}var d=Ext.get(n).down("img"),f,l={},g,k=m.displayMode===m.MaxMode;if(k){g=m.itemMaxImage*1.2;l.width=l.height=g+"px";l.marginTop=(m.itemMaxHeight-g)/2+"px"}else{g=m.itemMinImage*1.2;l.width=l.height=g+"px";l.marginTop=(m.itemMinHeight-g)/2+"px"}f=m.animateData[d.id];if(f){f.end()}m.animateData[d.id]=Ext.create("Ext.fx.Anim",{target:d,duration:400,delay:20,to:l});Ext.get(n).addCls("hover")},itemmouseleave:function(m,c,n,h,j){if(m.isEditing(n)){return}var d=Ext.get(n).down("img"),f,l={},g,k=m.displayMode===m.MaxMode;if(k){g=m.itemMaxImage;l.width=l.height=g+"px";l.marginTop=(m.itemMaxHeight-g)/2+"px"}else{g=m.itemMinImage;l.width=l.height=g+"px";l.marginTop=(m.itemMinHeight-g)/2+"px"}f=m.animateData[d.id];if(f){f.end()}m.animateData[d.id]=Ext.create("Ext.fx.Anim",{target:d,duration:400,delay:20,to:l});Ext.get(n).removeCls("hover")}};if(this.displayMode===this.MaxMode){this.cls="big-view"}else{this.cls="small-view"}if(!this.isSchool){this.cls+=" not-school";this.listeners.itemclick=function(c,h,g,f,j){var d=Ext.get(j.target);if(d.is("a[action]")){switch(d.getAttribute("action")){case"pici":c.fireEvent("assetpici",c,h,f);break}}}}else{this.listeners.itemclick=function(c,h,g,f,j){var d=Ext.get(j.target);if(d.is("a[action]")){switch(d.getAttribute("action")||d.dom.getAttribute("action")){case"pici":c.fireEvent("assetpici",c,h,f);break;case"add":c.fireEvent("assetaddreport",c,h,f);break;case"stop":c.fireEvent("assetstop",c,h,f);break}}}}this.callParent()},animateData:{},prepareData:function(d,b,a){var c=this.displayMode===this.MaxMode;if(c){d.itemWidth=this.itemMaxWidth;d.itemHeight=this.itemMaxHeight;d.itemImageSize=this.itemMaxImage}else{d.itemWidth=this.itemMinWidth;d.itemHeight=this.itemMinHeight;d.itemImageSize=this.itemMinImage}if(typeof d.unit_count!="number"){d.unit_count=0}if(d.name!="添加新类型"){d.emptyCls="";d.isItem=true}else{d.emptyCls="empty-asset-item"}d.itemImageMarginTop=(d.itemHeight-d.itemImageSize)/2;d.mode=this.mode;return d},showBigIcon:function(){this.displayMode=this.MaxMode;this.mode="A";this.refresh();this.removeCls("small-view");this.addCls("big-view")},showSmallIcon:function(){this.displayMode=this.MinMode;this.mode="a";this.refresh();this.removeCls("big-view");this.addCls("small-view")},toggleIcon:function(){if(this.displayMode==this.MaxMode){this.showSmallIcon()}else{this.showBigIcon()}},showRemoveLayer:function(){var a=this;Ext.each(a.getEl().query(a.itemSelector),function(c){var b=a.getRecord(c),d;if(b.raw.cannot_delete===true){return}if(Ext.get(c).is(".empty-asset-item")){return}d=document.createElement("a");d.className="remove-trigger";Ext.get(c).insertFirst(d);Ext.get(d).on("click",function(){var e=Ext.get(this),f=e.up("div.asset-item"),g;g=a.getRecord(f);a.fireEvent("assettyperemove",a,g)})})},isEditing:function(a){try{return Ext.get(a).query(".remove-trigger").length>0}catch(b){return false}},itemSelector:"div.asset-item",tpl:['<div class="asset-view">','<div class="asset-view-inner">','<tpl for=".">','<div class="asset-item {emptyCls}" style="width:{itemWidth}px;height:{itemHeight}px;">','<div class="item-icon">','<img style="margin-top:{itemImageMarginTop}px;height:{itemImageSize}px;width:{itemImageSize}px" src="{[ bbtConfig.getAssetIcon(values.icon) ]}"/>',"</div>",'<div class="item-details">',"<p><strong>{name}</strong></p>",'<tpl if="isItem">','<p class="single"><strong>{unit_count} {unit_name}</strong></p>','<p class="pici"><a href="javascript:void(0);" action="pici">批次详情</a></p>','<p><a action="add" class="x-btn x-btn-default-small add-btn">新增{[values.mode=="A"?"申报":""]}</><a action="stop" class="x-btn x-btn-default-small">停用{[values.mode=="A"?"申报":""]}</a></p>',"</tpl>","</div>","</div>","</tpl>",'<div style="clear:both;"></div>',"</div></div>"]});Ext.define("bbt.AssetManager",{extend:"Ext.panel.Panel",alias:"widget.assetmgr",exportUrl:"/asset/asset-type/export/",isSchool:bbt.UserInfo.isSchool(),initComponent:function(){var a=[{xtype:"combo",action:"displayStyle",name:"_",editable:false,value:"big",store:[["big","大图标"],["small","小图标"]]}];if(!this.isSchool){this.title="资产管理 > 资产统计";a.unshift(bbt.ToolBox.get("school"));a.unshift(bbt.ToolBox.get("town"));if(bbt.UserInfo.level=="city"){a.unshift(bbt.ToolBox.get("country"))}a.push({xtype:"button",text:"查询",iconCls:"icon-query",handler:function(){var b=this.up("toolbar").query("field"),c={};Ext.each(b,function(e){var d;if(e.name=="_"){return}if(e.submitField){d=e.findRecordByValue(e.getValue());c[e.name]=d.get(e.submitField)}else{c[e.name]=e.getValue()}if(c[e.name]=="所有"){c[e.name]=""}});this.up("assetmgr").getView().store.reload({params:c})}})}else{}a.push("->");a.push({xtype:"button",action:"export",iconCls:"icon-export",text:"报表导出"});Ext.apply(this,{bodyStyle:{overflow:"auto"},tbar:a,items:[{xtype:"assetview",border:false}],listeners:{afterrender:function(){var b=this.down("toolbar[dock=top]"),c=this;b.down("combo[action=displayStyle]").on("change",function(e,d){c.getView().toggleIcon()});b.down("button[action=export]").setHandler(c.doExport,c)},boxready:function(){if(!this.isSchool){Ext.each(this.down("toolbar").query("combo"),function(b){if(b.name=="_"){return}b.setValue("")})}}}});this.callParent();bbt.autoArea(this)},saveAreaStatus:function(){var b=[],a=this.down("toolbar[dock=top]");Ext.each(["province","city","country","town","school"],function(c){var d=a.down("combo[name="+c+"_name]");if(d){b.push([d.name,d.getValue()])}});this._area_values=b},recoveryAreaStatus:function(){var a=this.down("toolbar[dock=top]"),b=this._area_values;if(!b){return}Ext.each(b,function(c){a.down("combo[name="+c[0]+"]").setValue(c[1])});delete this._area_values},doExport:function(){var b=this,a=b.getView().store;Ext.Ajax.request({url:b.exportUrl,params:a.lastOptions.params,success:function(f){try{var c=Ext.decode(f.responseText);downloadFile(c.url,"")}catch(d){Ext.Msg.alert("提示","服务器错误！")}},failure:function(){}})},initEvents:function(){var b=this,a=b.getView();a.on({assetpici:function(c,f,e){var d=new bbt.AssetPCi({title:f.get("name")+" - 批次详情",showOperateColumn:false,assetType:f});b.saveAreaStatus();d.__parent=b;d.show()},assetaddreport:function(d,f,e){var c=new bbt.ReportAsset(),g;g=c.down("combo[name=asset_type]");g.store=d.store;g.setValue(f.raw.uuid);g.setReadOnly(true);c.assetTypeModel=f;c.show()},assetstop:function(c,f,e){var d=new bbt.AssetPCi({title:f.get("name")+" - 批次详情",showOperateColumn:true,assetType:f});b.saveAreaStatus();d.__parent=b;d.show()},assettypeadd:function(){var c=new bbt.NewAsset();c.assetManager=b;c.show()},assettyperemove:function(c,d){return b.removeAssetType(c,d)}})},getView:function(){return this.items.get(0)},removeAssetType:function(a,b){Ext.Ajax.request({url:"/asset/asset_type/delete/",params:{uuid:b.get("uuid")},method:"POST",callback:function(d,c,f){var e=Ext.decode(f.responseText);if(e.status=="success"){a.store.remove(b)}else{Ext.Msg.alert("提示",e.msg)}}})}});Ext.define("bbt.AssetPCi",{extend:"Ext.window.Window",alias:"widget.asset_pci",initComponent:function(){var d,c,a;if(bbt.UserInfo.isSchool()){d={asset_type_uuid:this.assetType.get("uuid")}}else{d=Ext.apply(this._get_other_level_params(),this.assetType.store.lastOptions.params)}c={xtype:"mgrgridbase",listUrl:bbt.UserInfo.isSchool()?"/asset/":"/asset/aggregate/",proxy:{type:"ajax",url:bbt.UserInfo.isSchool()?"/asset/":"/asset/aggregate/",reader:{type:"json",root:"data.records",totalProperty:"data.record_count"},extraParams:d,startParam:undefined},pageSize:15,assetType:this.assetType,pagination:true,border:false,fields:["reported_at","status","asset_from","device_model","number","reported_by","remark","asset_type__name","asset_type__school__parent__name","asset_type__school__name","asset_type__school__parent__parent__name"],listeners:{show:function(){var f=this.store.proxy.extraParams,e;e=this.down("toolbar[dock=top]");if(!f){f={}}if(!this.showOperateColumn){f.status="在用"}else{f.status="";e.down("combo[name=status]").setValue("")}this.store.on("beforeload",function(g){g.proxy.extraParams.page=g.currentPage});this.store.load({params:f});Ext.each("school town country city".split(" "),function(h){var g=e.down("combo[name="+h+"_name]");if(g){!g.value&&g.setValue("")}})}},columns:[{text:"申报时间",dataIndex:"reported_at",width:150,renderer:function(e){return e?e.replace("T"," "):""}},{text:"资产状态",dataIndex:"status",width:60,hidden:this.showOperateColumn},{text:"设备型号",dataIndex:"device_model"},{text:"数量",width:50,dataIndex:"number"},{text:"资产来源",dataIndex:"asset_from"},{text:"申报用户",width:60,dataIndex:"reported_by"},{text:"备注",flex:1,dataIndex:"remark"}],tbar:bbt.ToolBox.convert(["year","assetStatus","report_user","iDeviceModel","remark","query"]),showOperateColumn:this.showOperateColumn,operates:{stop:"停用"},actionMap:{stop:"onStop"},operateRenderer:function(){return function(f,e,g){if(g.get("status")=="在用"){return'<a href="javascript:void(0);" action="stop">停用</a>'}else{return""}}},onStop:function(f,l,k,h,n){var j=this,m,g={xtype:"window",modal:true,closable:false,resizable:false,title:"停用"+l.get("asset_type__name"),layout:"fit",items:[{xtype:"form",border:false,bodyCls:"no-bg",margin:30,layout:"anchor",items:[{xtype:"textfield",fieldLabel:"停用数量",anchor:"100%",name:"number",regex:/^[1-9]\d*$/,regexText:"无效的数字",allowBlank:false},{xtype:"hidden",name:"uuid",value:l.raw.uuid}]}],buttons:[{text:"停用",handler:function(){var o=this.up("window"),i=o.down("form"),p,e;p=bbt.utils.checkForm(i);if(p!==true){return}i=i.getForm();e=i.findField("number").getValue();i.waitTarget=o;i.submit({url:"/asset/delete/",method:"POST",waitMsg:"正在停用",success:function(){e=parseInt(e)||0;l.store.reload();o.totalStop+=e;o.destroy()},failure:function(r,q){var t;try{t=q.result.msg}catch(s){}Ext.Msg.alert("提示",t)}})}},{text:"关闭",handler:function(){this.up("window").destroy()}}],buttonAlign:"center"};m=Ext.widget("window",g);m.show();m.totalStop=0;m.on("beforedestroy",function(){if(this.totalStop>0){j.assetType.set("unit_count",j.assetType.get("unit_count")-this.totalStop)}})}};if(!bbt.UserInfo.isSchool()){var b=["town","school",c.tbar.shift()];if(bbt.UserInfo.level=="city"){b.unshift("country")}c.dockedItems=[{xtype:"toolbar",dock:"top",items:bbt.ToolBox.convert(b)}];a=c.columns.pop();c.columns.unshift({text:"学校",width:160,dataIndex:"asset_type__school__name"});c.columns.unshift({text:"街道乡镇",width:160,dataIndex:"asset_type__school__parent__name"});if(bbt.UserInfo.level=="city"){c.columns.unshift({text:"区县市",width:160,dataIndex:"asset_type__school__parent__parent__name"})}c.columns.push(a)}Ext.apply(this,{modal:true,layout:"fit",width:860,height:500,items:[c]});this.callParent()},listeners:{afterrender:function(){var a=this;try{Ext.isIE8&&setTimeout(function(){a.center()},10)}catch(b){}},beforedestroy:function(){var a=this.__parent;a.recoveryAreaStatus()}},_get_other_level_params:function(){var b={},a=this.assetType;b.name=a.get("name");b.icon=a.get("icon");b.unit_name=a.get("unit_name");return b}});Ext.define("bbt.ReportAsset",{extend:"Ext.window.Window",alias:"widget.report_asset",addUrl:"/asset/add/",initComponent:function(){Ext.apply(this,{title:"新增申报",modal:true,closable:false,resizable:false,width:400,height:300,layout:"fit",items:[{xtype:"form",border:false,bodyCls:"no-bg",margin:30,defaults:{anchor:"100%",margin:"10 0 0 0",allowBlank:false},items:[{xtype:"combo",fieldLabel:"资产类型",name:"asset_type",displayField:"name",valueField:"uuid",queryMode:"local"},{xtype:"textfield",fieldLabel:"设备型号",maxLength:100,name:"device_model"},{xtype:"textfield",fieldLabel:"数量",name:"number",regex:/^\d+$/,regexText:"无效的数字"},{xtype:"combo",fieldLabel:"资产来源",maxLength:10,editable:false,store:["校自主采购","县级电教采购","地级电教采购","省级电教采购","其他"],name:"asset_from"},{xtype:"textfield",fieldLabel:"备注",maxLength:180,allowBlank:true,name:"remark"}]}],buttons:[{text:"确定",action:"save",margin:"0 50 5 0"},{text:"关闭",action:"close"}],buttonAlign:"center",listeners:{boxready:function(){var a=this,b={save:a.onSave,close:a.close};Ext.each(a.query("button[action]"),function(c){c.setHandler(b[c.action],a)})}}});this.callParent()},onSave:function(){var d=this,c=d.down("form"),e,a,b;e=checkForm(c);if(e!==true){return}c=c.getForm();b=c.findField("number").getValue();a=function(f,h){var g=h.result||{};if(g.status=="success"){b=parseInt(b)||0;d.assetTypeModel.set("unit_count",d.assetTypeModel.get("unit_count")+b);d.askAddAgain()}};c.waitTarget=d;c.submit({url:d.addUrl,waitMsg:"正在申报……",success:a,failure:a})},close:function(){this.destroy()},askAddAgain:function(){var b=this,a={title:"提示",modal:true,autoShow:true,closable:false,resizable:false,width:200,items:[{xtype:"panel",header:false,bodyCls:"no-bg",border:false,margin:"30 15",html:'<p style="text-align: center;">申报成功！</a>'}],buttons:[{text:"继续申报 >>",handler:function(){b.resetForm();this.up("window").destroy()}},{text:"关闭",handler:function(){this.up("window").destroy();b.destroy()}}],buttonAlign:"center"};new Ext.window.Window(a)},resetForm:function(){var b=this.down("form").getForm(),a=b.findField("asset_type").getValue();b.reset();b.findField("asset_type").setValue(a)}});Ext.define("bbt.NewAsset",{extend:"Ext.window.Window",alias:"widget.bbt_newast",initComponent:function(){var b={xtype:"form",bodyCls:"no-bg",margin:30,border:false,defaults:{allowBlank:false},items:[{xtype:"combo",fieldLabel:"设备图标",name:"icon",editable:false,displayField:"text",valueField:"value",listConfig:{getInnerTpl:function(c){return'<img style="float:left; width: 48px;height: 48px" src="/public/images/asset/{value}.png"/> <span style="line-height:48px;margin-left:10px;">{text}</span>'}},store:new Ext.data.Store({data:[{text:"台式计算机",value:"pc"},{text:"电子白板",value:"whiteboard"},{text:"投影仪",value:"projector"},{text:"视频展台",value:"visual_presenter"},{text:"教室中控台",value:"center_console"},{text:"大屏显示器",value:"lfd"},{text:"笔记本",value:"notebook"},{text:"打印机",value:"printer"},{text:"瘦终端",value:"thin_terminal"},{text:"网络交换机",value:"switchboard"},{text:"其他教具1",value:"others1"},{text:"其他教具2",value:"others2"},{text:"其他教具3",value:"others3"}],fields:["text","value"]})},{xtype:"textfield",fieldLabel:"设备类型名称",name:"name"},{xtype:"textfield",fieldLabel:"数量单位",name:"unit_name",maxLength:2}]},a=this;Ext.apply(this,{title:"新增资产类型",modal:true,closable:false,resizable:false,width:350,height:200,buttons:[{text:"确定",action:"save",margin:"5 50 5 5"},{text:"关闭",action:"close"}],buttonAlign:"center",items:[b],listeners:{afterrender:function(){this.down("button[action=save]").on("click",this.onSave,this);this.down("button[action=close]").on("click",this.close,this)}}});this.callParent()},notifyRefresh:function(a){if(this.assetManager){this.assetManager.getView().store.load()}},askAddAgain:function(){var b=this,a={title:"提示",modal:true,autoShow:true,closable:false,width:250,items:[{xtype:"panel",margin:"30 10",border:false,bodyCls:"no-bg",html:'<p style="text-align:center;">添加资产类型成功！</p>'}],buttons:[{text:"继续添加 >>",handler:function(){b.resetForm();this.up("window").destroy()}},{text:"关闭",handler:function(){this.up("window").destroy();b.destroy()}}],buttonAlign:"center"};new Ext.window.Window(a)},resetForm:function(){var a=this.down("form").getForm();a.reset();a.findField("icon").expand()},onSave:function(){var c=this,b=c.down("form"),d,a;d=checkForm(b);if(d!==true){return}a=function(e,g){var f=g.result||{};if(f.status=="success"){c.notifyRefresh();c.askAddAgain()}else{Ext.Msg.alert("提示",getErrorMsg(f))}};b.getForm().submit({url:"/asset/asset_type/add/",success:a,failure:a})},close:function(){this.destroy()}});Ext.define("bbt.DangerOperate",{extend:"Ext.window.Window",alias:"widget.dangerwin",initComponent:function(){Ext.apply(this,{title:"授权",modal:true,closable:false,resizable:false,width:260,height:170,layout:"fit",items:[{xtype:"form",border:false,bodyCls:"no-bg",margin:30,layout:"anchor",items:[{anchor:"100%",xtype:"textfield",labelAlign:"top",fieldLabel:"请输入超级管理员的密码",name:"password",inputType:"password"}]}],buttons:[{text:"确定",handler:function(){var b=this.up("dangerwin"),a=b.down("[name=password]").getValue();b.validatePassword(a)}},{text:"取消",handler:function(){var a=this.up("window");a.onFail&&a.onFail();a.destroy()}}]});this.callParent()},validatePassword:function(b){var a=this;Ext.Ajax.request({method:"POST",url:"/system/sudo/",params:{password:b},callback:function(d,c,f){var e=Ext.decode(f.responseText);if(e.status=="success"){a.onPass&&a.onPass()}else{a.onFail&&a.onFail();Ext.Msg.alert("提示","密码错误！")}a.destroy()}})}});Ext.define("bbt.SystemRestore",{extend:"Ext.window.Window",alias:"widget.bbt_restore",autoShow:true,modal:true,width:400,height:300,items:[{xtype:"form",margin:40,border:false,layout:"anchor",bodyCls:"no-bg",items:[{xtype:"fileuploadfield",fieldLabel:"选择文件并导入",name:"excel",anchor:"100%",buttonText:"..."}]}],layout:"fit",buttons:[{text:"确定",handler:function(){var b=this.up("window").down("form"),a;a=function(c,e){var d=e.result;Ext.Msg.alert("提示",d.msg||"服务器错误！")};b.submit({url:"/system/restore/",success:a,failure:a})}},{text:"关闭",handler:function(){this.up("window").destroy()}}],buttonAlign:"center"});Ext.define("bbt.ColorBlockView",{extend:"Ext.view.View",alias:"widget.colorblock",itemSelector:"div.color-block-item",tpl:['<div class="color-block-view">','<div class="color-block-view-inner">','<tpl for=".">','<div class="color-block-item" style="background-color:#{bgcolor}">','<div class="icon-block">{firstChar}</div>','<div class="detail-block" style="top:{top}px;">','<div class="level-text" title="{name}"><span>{group_text}</span></div>','<p style="color: {fontColor};" class="info-text">{majorText}<br/>{juniorText}</p>',"</div>","</div>","</tpl>",'<div style="clear:both;"></div>',"</div></div>"],allColors:[["facca8","98d0dd","d2c9de","cadaa9","eccdcb","c9d6e6"],["f8b57e","71bfd3","bfb0cf","b5ca85","da9791","b0c2da"]],constructor:function(){var a=new Ext.data.Store({fields:["name","uuid","school_count","class_count","pic_count","group_type"],proxy:{url:"/activity/desktop-preview/groups/",type:"ajax",reader:{type:"json",root:"data.records",totalProperty:"data.record_count"}},pageSize:6});this.store=a;this.colors=this.suffle(bbt.UserInfo.level);this.listeners={itemclick:function(g,h){var f=h.get("uuid"),c=h.get("group_type"),e,b,i,d;if(c=="class"){e=g.up("previewlog").down("[name=term_type]");e=e.findRecordByValue(e.getValue());b=Ext.Date.parse(e.get("start_date"),"Y-m-d");i=Ext.Date.parse(e.get("end_date"),"Y-m-d");d=new Date();if(d>b&&d<i){i=d}g.viewBlock(h,b,i)}else{a.proxy.extraParams.uuid=f;a.load()}}};this.callParent()},viewBlock:function(d,g,b){var e=bbt.createOverlay(),f,c,a;f=document.createElement("div");f.style.zIndex=20;f.className="log-viewer";f.innerHTML='<div class="time-axis"><a class="pager first-page"></a><a class="pager prev-page"></a><ul>'+new Array(21).join("<li></li>")+'</ul><a class="pager next-page"></a><a class="pager last-page"></a></div><img src=""/><div class="log-footer"><a href="javascript:void(0);"></a><span></span></div>';document.body.appendChild(f);f=Ext.get(f);a=(function(){var j=[],l=[],m,k=0,h=(b-g)/(24*60*60*1000);for(;k<=h;k++){m=Ext.Date.clone(g);m.setDate(m.getDate()+k);l.push(Ext.Date.format(m,"Y-m-d"));if(l.length===20){j.push(l);l=[]}}if(l.length&&l.length<20){while(l.length!=20){m=Ext.Date.clone(g);m.setDate(m.getDate()+k);l.push(Ext.Date.format(m,"Y-m-d"));k++}j.push(l)}return j})();e.onBeforeDestroy=function(){f.unHighlight();Ext.removeNode(f.dom)};f.store=new Ext.data.Store({autoLoad:true,fields:["grade_name","class_name","lesson_name","teacher_name","lesson_period_sequence","created_at","url"],proxy:{type:"ajax",url:"/activity/desktop-preview/by-date/",extraParams:{date:Ext.Date.format(b,"Y-m-d"),class_uuid:d.raw.uuid,lesson_period_sequence:d.store.proxy.extraParams.lesson_period_sequence},reader:{type:"json",root:"data.records"}},listeners:{load:function(h){f.currentImageIndex=0;f.setByModel(h.getAt(0))}}});Ext.apply(f,{jieci:d.store.proxy.extraParams.lesson_period_sequence,classUUID:d.raw.uuid,pages:a,MAX_DATE:Ext.Date.format(b,"Y-m-d"),initViewerEvents:function(){var i=this,h=i.child(".time-axis"),j=h.child("ul");j.on("click",function(m){var k=Ext.get(m.target),l=this;if(k.hasCls("circle-off")||k.hasCls("selected")){return}Ext.each(k.parent("ul").query(".focus"),function(p){var o;if(p.className.indexOf("off")===-1){o=Ext.get(p);o.addCls("focus-off");o.child(".circle").removeCls("selected");o.next(".date").setStyle("display","none");o.parent("li").removeCls("colored");l.unHighlight()}});k.addCls("selected");k.parent().next(".date").setStyle("display","block");k.parent().removeCls("focus-off");k.parent("li").addCls("colored");l.makeHighlight(k);f.store.proxy.extraParams.date=k.parent("li").getAttribute("data-date");f.store.load()},i,{delegate:".circle"});j.on("mouseover",function(l){var k=Ext.get(l.target);if(k.hasCls("circle-off")||k.hasCls("selected")){return}k.parent().removeCls("focus-off");k.parent("li").child(".date").setStyle("display","block")},null,{delegate:".circle"});j.on("mouseout",function(l){var k=Ext.get(l.target);if(k.hasCls("circle-off")||k.hasCls("selected")){return}k.parent().addCls("focus-off");k.parent("li").child(".date").setStyle("display","none")},null,{delegate:".circle"});h.on("click",function(l){var k=Ext.get(l.target);if(k.hasCls("prev-page")){this.loadTimeAsixPage("prev")}else{if(k.hasCls("first-page")){this.loadTimeAsixPage(0)}else{if(k.hasCls("next-page")){this.loadTimeAsixPage("next")}else{if(k.hasCls("last-page")){this.loadTimeAsixPage(-1)}}}}},i,{delegate:".pager"});i.child("img").on("mousemove",function(m){var n=m.getX(),k=this.getX(),l=this.getWidth();if((n-k)>l/2){this.setStyle("cursor","url(/public/images/mouse-right.cur), auto")}else{this.setStyle("cursor","url(/public/images/mouse-left.cur), auto")}}).on("click",function(m){var n=m.getX(),k=this.getX(),l=this.getWidth();if((n-k)>l/2){i.nextImage()}else{i.prevImage()}});i.child(".log-footer").child("a").on("click",function(n,l){var m=Ext.get(l.parentNode),k=m.getHeight();if(k===0){m.animate({stopAnimation:true,duration:400,to:{height:"40px"},callback:function(){l.className=""}})}else{m.animate({duration:400,to:{height:"0px"},callback:function(){l.className="switch-up"}})}})},loadTimeAsixPage:function(k){var n=this,p,m=[],l,h,j,o;if(typeof k=="number"){if(k<0){k=n.pages.length+k}p=n.pages[k]}else{if(typeof k=="string"){for(l=0,h=n.pages.length;l<h;l++){if(n.pages[l].current){break}}if(k=="prev"){l--}else{if(k=="next"){l++}}p=n.pages[l]}}if(!p||(p&&p.current)){return}Ext.each(n.pages,function(i){i.current&&(delete i.current)});p.current=true;j='</b><div class="focus focus-off"><a class="circle"></a></div><b class="date">';for(l=0,h=p.length;l<h;l++){if(l===0){m.push('<li class="first" data-date="'+p[l]+'"><b class="line line-off">')}else{m.push('<li data-date="'+p[l]+'"><b class="line">')}if(p[l]>n.MAX_DATE){m.push(j.replace("circle","circle circle-off"))}else{m.push(j)}m.push(p[l].substring(5)+"</b></li>")}n.unHighlight();o=n.child(".time-axis").child("ul");o.setHTML(m.join(""));Ext.Ajax.request({method:"GET",url:"/activity/desktop-preview/list-everyday/",params:{lesson_period_sequence:n.jieci,class_uuid:n.classUUID,start_date:p[0],end_date:p[p.length-1]},callback:function(u,t,v){var s=Ext.decode(v.responseText),i,q,r;if(s.status!="success"){return}s=s.data;i=o.child("li");while(i){q=i.dom.getAttribute("data-date");if((q in s)&&s[q]===0){i.down(".circle").addCls("circle-off")}if(i.down(".circle").dom.className=="circle"){r=i}i=i.next("li")}r&&bbt.simulateClick(r.down(".circle").dom)}})},$func:(function(){var j="inset 0 0 {x}px #1eff00",h=6,i=1;return function(){var k=arguments.callee.style;if(!k){return}if(h==16||h==-2){i=i*-1}h+=i;if(k.webkitBoxShadow){k.webkitBoxShadow=j.replace("{x}",h)}else{if(k.mozBoxShadow){k.mozBoxShadow=j.replace("{x}",h)}else{k.boxShadow=j.replace("{x}",h)}}}})(),makeHighlight:function(h){if(Ext.isIE&&Ext.ieVersion<9){return}this.$func.style=h.dom.style;this.$timer=setInterval(this.$func,80);this.$animateTarget=h},unHighlight:function(){if(Ext.isIE&&Ext.ieVersion<9){return}if(!this.$animateTarget){return}clearInterval(this.$timer);var h=this.$animateTarget.dom.style;if(h.webkitBoxShadow){h.webkitBoxShadow=""}else{if(h.mozBoxShadow){h.mozBoxShadow=""}else{h.boxShadow=""}}delete this.$animateTarget},setByModel:function(j){var h=this.down("img",true),k,i,n,l=this,m;if(!j){h.style.visibility="hidden";this.child(".log-footer").down("span").setHTML("");return -1}i=function(q,t){var p,s,o=Ext.getBody().getHeight()-94;if(t===false){p=j.raw.naturalWidth;s=j.raw.naturalHeight}else{s=550;p=s*j.raw.naturalWidth/j.raw.naturalHeight}q.width=p;q.height=s;q.style.marginLeft="-"+(p/2)+"px";if(s<=o){q.style.top="50%";q.style.marginTop=s/-2+"px";q.style.bottom="auto"}else{q.style.top="auto";q.style.marginTop="auto";q.style.bottom="0px"}if(q.style.visibility=="hidden"){q.style.visibility="visible"}};if(typeof j.raw.naturalWidth=="undefined"){k=new Image();k.$target=h;k.src="http://"+j.raw.host+j.raw.url;l.mask("正在加载图片...");k.onload=function(o){o=o||window.event;l.unmask();if(k.naturalHeight){j.raw.naturalHeight=k.naturalHeight;j.raw.naturalWidth=k.naturalWidth}else{j.raw.naturalWidth=k.width;j.raw.naturalHeight=k.height}k.$target.src=k.src;i(k.$target);k.onload=null;delete k.$target;clearTimeout(m)};m=setTimeout(function(){delete k.$target;delete k.onload;k=null;l.unmask();h.src="/public/images/broken.png";j.raw.naturalWidth=63;j.raw.naturalHeight=48;i(h,false)},60*1000)}else{h.src="http://"+j.raw.host+j.raw.url;i(h)}n=this.child(".log-footer");n.down("span").setHTML(Ext.String.format("时间:{0}&nbsp;&nbsp;节次:{1}&nbsp;&nbsp;班级:{2}&nbsp;&nbsp;课程:{3}&nbsp;&nbsp;授课教师:{4}",j.data.created_at,j.data.lesson_period_sequence,j.data.grade_name+"年级"+j.data.class_name+"班",j.data.lesson_name,j.data.teacher_name))},makeFooterVisible:function(){var h=this.child(".log-footer");h.setHeight(40)},prevImage:function(){var k,h,j=false;if(this.currentImageIndex===0){try{h=this.down(".selected").parent("li");while(h){h=h.prev("li");if(!h.down(".circle-off")){j=true;break}}bbt.simulateClick(h.down(".circle").dom)}catch(l){}}else{j=true}if(!j){return}k=--this.currentImageIndex;k=this.setByModel(this.store.getAt(k));if(k===-1){return}this.makeFooterVisible()},nextImage:function(){var k,j,h=false;if(this.currentImageIndex===(this.store.count()-1)){try{j=this.down(".selected").parent("li");while(j){j=j.next("li");if(!j.down(".circle-off")){h=true;break}}bbt.simulateClick(j.down(".circle").dom)}catch(l){}}else{h=true}if(!h){return}k=++this.currentImageIndex;k=this.setByModel(this.store.getAt(k));if(k===-1){return}this.makeFooterVisible()}});f.initViewerEvents();f.loadTimeAsixPage(-1)},suffle:function(f){var b,d=0,a,e,c;c=Ext.Array.indexOf("province city country town school grade class".split(" "),f);if(c<=2){b=this.allColors[1];this.fontColor="#FFF"}else{b=this.allColors[0];this.fontColor="#8b7d72"}for(a=b.length;d<a;d++){e=Math.floor(Math.random()*a);if(e==d){continue}else{c=b[d];b[d]=b[e];b[e]=c}}return b},prepareData:function(c,b,a){c.bgcolor=this.colors[b%this.colors.length];c.fontColor=this.fontColor;c.firstChar=c.name.charAt(0);c.top=0;if(c.name.length>10){c.group_text=c.name.substr(0,9)+".."}else{c.group_text=c.name;if(c.name.length<6){c.top=-14}}switch(c.group_type){case"class":c.majorText=c.pic_count+"次";c.juniorText="桌面预览";break;case"school":c.majorText=c.class_count+"个班级";break;default:c.majorText=c.school_count+"所学校";c.juniorText=c.class_count+"个班级";break}return c}});Ext.define("bbt.DesktopPreview",{extend:"Ext.panel.Panel",alias:"widget.desktoppreview",initComponent:function(){var b=this,a=new Ext.data.Store({pageSize:4,fields:["grade_name","class_name","lesson_name","teacher_name","lesson_period_sequence","url"],proxy:{url:"/global/desktop-preview/",type:"ajax",reader:{type:"json",root:"data.records",totalProperty:"data.record_count"}}});a.on("load",function(c){b.eachBlock(function(d,e){var f=c.getAt(e);if(f){f=f.raw}else{f={}}d=Ext.get(d);d.removeCls("preview-loading");b.fillBlock(d.parent(),f)})});Ext.apply(this,{store:a,autoScroll:true,minWidth:800,layout:{type:"vbox",align:"stretch"},defaultType:"panel",defaults:{border:false,flex:1},items:[{layout:{type:"hbox",align:"stretch"},defaults:{flex:1,border:true},defaultType:"panel",items:[{margin:"5 2 2 5",html:'<div class="desktop-preview preview-loading"><img style="width:100%;height:100%;" src=""/></div><div class="preview-footer"><span></span><a class="open-viewer" href="javascript:void(0);"></a></div>'},{margin:"5 5 2 3",html:'<div class="desktop-preview preview-loading"><img style="width:100%;height:100%;" src=""/></div><div class="preview-footer"><span></span><a class="open-viewer" href="javascript:void(0);"></a></div>'}]},{layout:{type:"hbox",align:"stretch"},defaults:{flex:1,border:true},defaultType:"panel",items:[{margin:"3 2 5 5",html:'<div class="desktop-preview preview-loading"><img style="width:100%;height:100%;" src=""/></div><div class="preview-footer"><span></span><a class="open-viewer" href="javascript:void(0);"></a></div>'},{margin:"3 5 5 3",html:'<div class="desktop-preview preview-loading"><img style="width:100%;height:100%;" src=""/></div><div class="preview-footer"><span></span><a class="open-viewer" href="javascript:void(0);"></a></div>'}]}],listeners:{afterrender:function(){var c=this,d;Ext.each(c.getEl().query(".desktop-preview"),function(e){var f;e=Ext.get(e);e.down("img").on("load",function(h,g){if(!g.naturalHeight){g.naturalWidth=g.width;g.naturalHeight=g.height}});f=e.parent().down(".preview-footer");f.hover(function(){this.style.zIndex=20},function(){this.style.zIndex="auto"});f.down(".open-viewer").on("click",function(i,g){var j=Ext.get(g).parent(".preview-footer").prev(".desktop-preview"),h;h=j.down("img",true);if(!h.src||h.src.indexOf(location.href)!=-1){return}c.openViewer(j)})});c.body.insertHtml("beforeEnd",'<a class="prev-page" href="javascript:void(0);"></a><a class="next-page" href="javascript:void(0);"></a>');c.body.child(".prev-page").on("click",function(){var f=0;try{f=this.store.proxy.reader.rawData.data.page_count;if(this.store.currentPage===1){this.store.currentPage=f}else{this.store.currentPage--}this.store.load()}catch(g){}},c);c.body.child(".next-page").on("click",function(){var f=0;try{f=this.store.proxy.reader.rawData.data.page_count;if(this.store.currentPage===f){this.store.currentPage=1}else{this.store.currentPage++}this.store.load()}catch(g){}},c)}}});this.callParent()},openViewer:function(e){var b=e.down("img",true),a,d=580,c;if(!b.src){return}document.body.appendChild(b);a=d*b.naturalWidth/b.naturalHeight;b.style.cssText=Ext.String.format("position:absolute;z-index:21;width:{0}px;height:{1}px;top:50%;left:50%;margin-left:-{2}px;margin-top:-{3}px;",a,d,a/2,d/2);c=bbt.createOverlay(20);c.$image=b;c.onBeforeDestroy=function(g){var h=Ext.get(g.$image),f,i,k,j;f=h.getPageBox();k={left:f.left+"px",top:f.top+"px",width:f.width+"px",height:f.height+"px"};i=e.getPageBox();j={left:i.left+"px",top:i.top+"px",width:i.width+"px",height:i.height+"px"};g.$image.style.cssText="position: absolute;z-index: 21;";h.animate({duration:500,from:k,to:j,callback:function(){e.appendChild(h);h.dom.style.cssText="width:100%;height:100%;"}});delete g.$image}},eachBlock:function(a){Ext.each(this.getEl().query(".desktop-preview"),a)},fillBlock:function(d,b){var e,a,c;if(!d.$cache){d=Ext.get(d)}e=d.down(".preview-footer");a=d.down("img",true);c=d.down(".preview-no-img");if(b&&b.url){c&&c.hide();a.style.visibility="visible";a.src="http://"+b.host+b.url;e.down("span").setHTML(Ext.String.format("节次：{0} 班级：{1}年级{2}班 课程：{3} 授课教师：{4}",b.lesson_period_sequence,b.grade_name,b.class_name,b.lesson_name,b.teacher_name));e.animate({to:{marginTop:"-28px"}})}else{a.style.visibility="hidden";e.down("span").setHTML("");e.animate({to:{marginTop:"0px"}});if(!c){e.insertHtml("afterEnd",'<div class="preview-no-img">桌面预览：无</div>');c=d.down(".preview-no-img")}c.show()}},showWarn:function(){this.eachBlock(function(a){a=Ext.get(a.parentNode);var b=document.createElement("div");b.setAttribute("data-remove","yes");b.style.cssText="position:absolute;font-size:24px;top:0;right:0;bottom:0;left:0;text-align:center;background-color:#FFF;line-height:"+a.getHeight()+"px;";b.style.fontFamily="微软雅黑";b.innerHTML="请点击某个学校后进行桌面预览！";a.appendChild(b)})},removeWarn:function(){Ext.each(this.getEl().query("div[data-remove=yes]"),function(a){Ext.removeNode(a)})},onLevelChange:function(b,a){switch(b){case"school":case"grade":if(this.__warn){this.removeWarn();delete this.__warn}this.store.proxy.extraParams.uuid=a;this.store.currentPage=1;this.eachBlock(function(d){var e;d=Ext.get(d);d.addCls("preview-loading");e=d.child(".preview-no-img");e&&e.hide()});this.store.load();break;default:if(!this.__warn){this.showWarn();this.__warn=true}break}}});Ext.define("bbt.DesktopPreviewLog",{extend:"Ext.panel.Panel",alias:"widget.previewlog",layout:"fit",items:[{xtype:"colorblock"}],initComponent:function(){this.tbar=[bbt.ToolBox.get("schoolYear"),bbt.ToolBox.get("term"),{xtype:"combo",value:"class",editable:false,disabled:true,store:[["class","按班级"],["jieci","按节次"]],fieldLabel:"查询方式",labelWidth:75,width:150,myrole:"querymethod"},bbt.ToolBox.get("jieciOld",{disabled:true})];if(!bbt.UserInfo.isSchool()){this.tbar.push({xtype:"tbtext",cls:"my-tbtext icon-toolbar"})}this.callParent()},listeners:{afterrender:function(){var e=this.down("toolbar[dock=top]"),g,c,d,f,a,b;this.store=this.down("colorblock").store;g=e.down("[name=school_year]");g.store.owner=g;g.on("change",function(i,h){i.up("previewlog").store.proxy.extraParams.school_year=h});c=e.down("[name=term_type]");c.on("change",function(k,j){var h=k.ownerCt.down("[myrole=querymethod]"),i=k.ownerCt.down("[name=lesson_period]");if(!i.isDisabled()){i.setDisabled(true)}h.setDisabled(!!!j);k.up("previewlog").store.proxy.extraParams.term_type=j;if(j){if(h.getValue()=="class"){h.fireEvent("change",h,"class")}else{h.setValue("class")}}});d=e.down("combo[myrole=querymethod]");f=e.down("combo[name=lesson_period]");d.on("change",function(k,i){var j=k.ownerCt.down("combo[name=lesson_period]"),h;if(i=="class"){j.setDisabled(true);j.setValue("");h=k.up("previewlog").down("colorblock").store;delete h.proxy.extraParams.lesson_period_sequence;delete h.proxy.extraParams.uuid;setTimeout(function(){h.load()},10)}else{if(i=="jieci"){j.setDisabled(false);j.setValue(j.store.getAt(0).get(j.valueField))}}});f.on("change",function(j,i){var h=j.up("previewlog").down("colorblock").store;if(i==="所有"){delete h.proxy.extraParams.lesson_period_sequence}else{h.proxy.extraParams.lesson_period_sequence=i}delete h.proxy.extraParams.uuid;h.load()});f.store.on("load",function(h){h.each(function(i){if(i.data.value===""){h.remove(i);return false}})});f.store.load();this.body.insertHtml("beforeEnd",'<a class="prev-page" href="javascript:void(0);"></a><a class="next-page" href="javascript:void(0);"></a>');this.body.child(".prev-page").on("click",function(){if(this.store.currentPage===1){return}this.store.currentPage--;this.store.isClickFromPager=true;this.store.load()},this);this.body.child(".next-page").on("click",function(){var h=0;try{h=this.store.proxy.reader.rawData.data.page_count;if((this.store.currentPage+1)>h){return}this.store.currentPage++;this.store.isClickFromPager=true;this.store.load()}catch(i){}},this);bbt.loadCurrentSchoolYear(function(i,h,k){var j=Ext.decode(k.responseText);if(j.status=="success"){g.setValue(j.data.school_year);c.setValue(j.data.term_type)}});b=e.down("tbtext");if(!b){return}b=b.getEl();Ext.apply(b,{store:this.store,initCrubms:function(){var h,i;i=this._cacheLevel();h=i[this.serverLevel];this.setHTML('<p class="spread-crumbs">'+h.name+"</p>");this.store.on("beforeload",function(j,k){if(j.isClickFromPager){delete j.isClickFromPager}else{j.currentPage=k.page=1}this.setCurrentLevel(j.proxy.extraParams.uuid)},this);this.on("click",function(l){var j=l.target,k=j.getAttribute("data-uuid");this.store.proxy.extraParams.uuid=k;this.store.load()},this,{delegate:"a[data-uuid]"})},_cacheLevel:function(){var i=bbt.UserInfo.level+"Store",k={},j,h;i=Ext.getStore(i);j=i.getAt(0);h=function(m){var n,l;k[m.uuid]=m;if(m.children){n=0,l=m.children.length;for(;n<l;n++){h(m.children[n])}}};h(j.raw);this.serverLevel=j.data.uuid;this.leveldict=k;return k},setCurrentLevel:function(h,p){var k=this.leveldict,n=h,q=[],l,j,m=0;j=(h in k);for(;j;m++){l=k[h];if(m===0){q.unshift(l.name)}else{q.unshift('<a href="javascript:void(0);" data-uuid="'+l.uuid+'">'+l.name+"</a>")}h=l.parent__uuid;j=(h in k)}this.child(".spread-crumbs").setHTML(q.join("&nbsp;&gt;&nbsp;"));try{l=Ext.getCmp("content-panel").down("colorblock");l.colors=l.suffle(k[n].group_type)}catch(o){console.log(o)}}});b.initCrubms()}}});Ext.define("bbt.ComprehensiveAnalysis",{extend:"Ext.tab.Panel",alias:"widget.cphcount",initComponent:function(){Ext.apply(this,{defaults:{border:false},items:[{xtype:"panel",title:"班班通授课次数分析",layout:{type:"vbox",stretch:"max"},defaults:{flex:1,width:"100%"},listUrl:"/statistic/teaching-analysis/lesson-count/",items:[{xtype:"chart",animate:false,shadow:false,store:new Ext.data.Store({fields:["data1","data2","data3","name"]}),axes:[{type:"Numeric",position:"left",fields:["data1","data2","data3"],minorTickSteps:1,grid:true,minimum:0},{type:"Category",position:"bottom",fields:["name"],label:{renderer:function(a){return"第"+a+"周"}},title:"班班通授课周节次分析（次）"}],series:[{type:"column",axis:"left",highlight:true,tips:{width:100,trackMouse:true,renderer:function(a,b){this.setTitle(a.get(b.yField))}},label:{display:"outside","text-anchor":"middle",field:["data1","data2","data3"],renderer:function(a){return a}},xField:"name",yField:["data1","data2","data3"],}],listeners:{afterrender:function(){var b=this,a=b.themeAttrs.colors;legend={data1:a[0],data2:a[1],data3:a[2]};bbt.createLegend(b,legend)}}},{xtype:"chart",style:{borderTop:"1px solid #99bce8 !important"},animate:true,shadow:true,store:new Ext.data.Store({fields:["data1","data2","data3","name"]}),axes:[{type:"Numeric",minorTickSteps:1,position:"left",fields:["data1","data2","data3"],grid:true,minimum:0},{type:"Category",position:"bottom",fields:["name"],label:{renderer:function(a){return"第"+a+"周"}},title:"班班通授课周节次趋势分析（次）"}],series:[{type:"line",axis:"left",highlight:true,smooth:true,tips:{width:100,trackMouse:true,renderer:function(a,b){this.setTitle(b.value[1]||"0")}},xField:"name",yField:"data2",},{type:"line",axis:"left",smooth:true,tips:{width:100,trackMouse:true,renderer:function(a,b){this.setTitle(b.value[1]||"0")}},xField:"name",yField:"data1",},{type:"line",axis:"left",highlight:true,smooth:true,tips:{width:100,trackMouse:true,renderer:function(a,b){this.setTitle(b.value[1]||"0")}},xField:"name",yField:"data3",}],listeners:{afterrender:function(){var b=this,a=b.themeAttrs.colors;legend={data1:a[0],data2:a[1],data3:a[2]};bbt.createLegend(b,legend)}}}],tbar:(function(){var a=bbt.getLevelTools();a.push("grade","class","->",{xtype:"checkbox",name:"term_previous",boxLabel:"与上学期环比"},{xtype:"checkbox",name:"term_lastyear",boxLabel:"与上学年同学期同比"});return bbt.ToolBox.convert(a)})(),listeners:{beforerender:function(){var b,a=this;bbt.autoFill2(a);b=a.down("toolbar");b.down("[name=grade_name]").store.proxy.extraParams.current_term="true";Ext.each(b.query("field[name]"),function(c){c.on("change",a.updateStore,a)})}},loadStore:function(c){var b=this,a=b.query("chart");b.getEl().mask("loading ...");bbt.loadTermCompareData(b.listUrl,c,function(d,e){a[0].store.removeAll();a[0].store.loadData(d);a[1].store.removeAll();a[1].store.loadData(e);b.getEl().unmask()})},updateStore:function(){var a=this;if(a.updateTimer){clearTimeout(a.updateTimer)}a.updateTimer=setTimeout(function(){var b={};Ext.each(a.down("toolbar").query("field[name]"),function(e){var d,c;if(e.is("combo")){d=e.findRecordByValue(e.getValue())}c=d?d.get(e.submitField):e.getValue();b[e.name]=c=="所有"?"":c});a.loadStore(b);delete a.updateTimer},50)}},{xtype:"panel",title:"班班通授课时长分析",layout:{type:"vbox",stretch:"max"},defaults:{flex:1,width:"100%"},listUrl:"/statistic/teaching-analysis/total-time/",items:[{xtype:"chart",animate:false,shadow:false,store:new Ext.data.Store({fields:["data1","data2","data3","name"]}),axes:[{type:"Numeric",position:"left",fields:["data1","data2","data3"],minorTickSteps:1,grid:true,minimum:0},{type:"Category",position:"bottom",fields:["name"],label:{renderer:function(a){return"第"+a+"周"}},title:"班班通授课周时长分析（分钟）"}],series:[{type:"column",axis:"left",highlight:true,tips:{width:100,trackMouse:true,renderer:function(a,b){this.setTitle(a.get(b.yField))}},label:{display:"outside","text-anchor":"middle",field:["data1","data2","data3"],renderer:function(a){return a}},xField:"name",yField:["data1","data2","data3"],}],listeners:{afterrender:function(){var b=this,a=b.themeAttrs.colors;legend={data1:a[0],data2:a[1],data3:a[2]};bbt.createLegend(b,legend)}}},{xtype:"chart",style:{borderTop:"1px solid #99bce8 !important"},animate:true,shadow:true,store:new Ext.data.Store({fields:["data1","data2","data3","name"]}),axes:[{type:"Numeric",minorTickSteps:1,position:"left",fields:["data1","data2","data3"],grid:true,minimum:0},{type:"Category",position:"bottom",fields:["name"],label:{renderer:function(a){return"第"+a+"周"}},title:"班班通授课周时长趋势分析（分钟）"}],series:[{type:"line",axis:"left",highlight:true,smooth:true,tips:{width:100,trackMouse:true,renderer:function(a,b){this.setTitle(b.value[1]||"0")}},xField:"name",yField:"data2",},{type:"line",axis:"left",smooth:true,tips:{width:100,trackMouse:true,renderer:function(a,b){this.setTitle(b.value[1]||"0")}},xField:"name",yField:"data1",},{type:"line",axis:"left",highlight:true,smooth:true,tips:{width:100,trackMouse:true,renderer:function(a,b){this.setTitle(b.value[1]||"0")}},xField:"name",yField:"data3",}],listeners:{afterrender:function(){var b=this,a=b.themeAttrs.colors;legend={data1:a[0],data2:a[1],data3:a[2]};bbt.createLegend(b,legend)}}}],tbar:(function(){var a=bbt.getLevelTools();a.push("grade","class","->",{xtype:"checkbox",name:"term_previous",boxLabel:"与上学期环比"},{xtype:"checkbox",name:"term_lastyear",boxLabel:"与上学年同学期同比"});return bbt.ToolBox.convert(a)})(),listeners:{beforerender:function(){var b,a=this;bbt.autoFill2(a);b=a.down("toolbar");b.down("[name=grade_name]").store.proxy.extraParams.current_term="true";Ext.each(b.query("field[name]"),function(c){c.on("change",a.updateStore,a)})}},loadStore:function(c){var b=this,a=b.query("chart");b.getEl().mask("loading ...");bbt.loadTermCompareData(b.listUrl,c,function(d,e){a[0].store.removeAll();a[0].store.loadData(d);a[1].store.removeAll();a[1].store.loadData(e);b.getEl().unmask()})},updateStore:function(){var a=this;if(a.updateTimer){clearTimeout(a.updateTimer)}a.updateTimer=setTimeout(function(){var b={};Ext.each(a.down("toolbar").query("field[name]"),function(e){var d,c;if(e.is("combo")){d=e.findRecordByValue(e.getValue())}c=d?d.get(e.submitField):e.getValue();b[e.name]=c=="所有"?"":c});a.loadStore(b);delete a.updateTimer},50)}}],listeners:{beforerender:function(){bbt.autoArea(this)}}});this.callParent()}});Ext.define("bbt.About",{extend:"Ext.window.Window",alias:"widget.bbt_about",getDetails:function(){var a=this;apiRequest.target=a;apiRequest("/system/about/",{},function(c){var b=a.down("form").getForm();Ext.Object.each(c.data,function(e,d){var g=b.findField(e);g&&g.setValue(d)})})},initComponent:function(){Ext.apply(this,{layout:"fit",modal:true,width:400,height:300,bodyStyle:{background:"url(/public/images/logo.png) no-repeat 47% 11%"},resizable:false,closable:false,items:[{xtype:"form",border:false,margin:30,bodyCls:"no-bg",defaultType:"displayfield",layout:"anchor",defaults:{margin:15},items:[{fieldLabel:"产品名称",name:"product_name",value:"噢易班班通管理分析系统",margin:"90 7 7 15"},{fieldLabel:"版本号",name:"version",value:""},{fieldLabel:"版权所有",name:"copyright",value:"武汉噢易科技有限公司"},{hidden:true,fieldLabel:"软件授权",name:"privilege",value:""}]}],buttons:[{text:"关闭",action:"destroy"}],buttonAlign:"center",listeners:{afterrender:function(){this.down("button[action=destroy]").setHandler(this.destroy,this)}}});this.callParent();this.show();this.getDetails()}});Ext.define("bbt.NewFeature",{extend:"Ext.panel.Panel",alias:"widget.new_feature",initComponent:function(){var a=this;a.border=false;a.layout="absolute";a.bodyStyle={backgroundColor:"#d7e4f5"};a.items=[{xtype:"image",width:841,height:481,src:"/public/images/new-feature.jpg"},{xtype:"component",hidden:true,height:30,width:450,html:'<p class="wryh" style="font-size:24px;line-height:30px;white-space: nowrap;">功能暂未开放，敬请期待系统更新！</p>'}];a.listeners={beforedestroy:function(){if(this.currentAnim){Ext.fx.Manager.removeAnim(this.currentAnim)}},afterrender:function(){var b,c=this.down("image"),d;b=this.getWidth()-c.getWidth();c.setPosition(b,-70,false);d=new Ext.fx.Anim({target:c.el,stopAnimation:true,easing:"backIn",delay:300,duration:800,to:{top:"0px"},callback:function(){a.showText()}});a.currentAnim=d;a.el.insertHtml("beforeEnd",'<div style="position:absolute;top:0;left:0;bottom:0;right:0;z-index:199999;"></div>')}};a.callParent()},showText:function(){var b=this.down("component[hidden=true]"),a,c;a=(this.getWidth()-450)/2;c=(this.getHeight()-b.getHeight())/2;b.setPosition(a,c+80);b.show();b.setPosition(a,c,true)}});Ext.apply(bbt,{createLegendItem:function(c,b){var a=document.createElement("li");a.innerHTML='<span style="background-color:'+b+'"></span>'+c;return a},createLegend:function(d,e){var g,b,c,a=0,f={data1:"当前学期",data2:"上学期",data3:"上学年同学期"};if(!d.el){return}c=d.el.child(".analysis-legend");if(!c){c=document.createElement("ul");c.className="analysis-legend";d.el.appendChild(c);c=Ext.get(c)}c.setHTML("");for(g in e){b=e[g];c.appendChild(this.createLegendItem(f[g],b));a++}if(a===0){c.hide()}else{c.show()}}});